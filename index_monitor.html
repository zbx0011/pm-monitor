<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡æ•°æˆåˆ†è‚¡æ•´ä½“å‹åŠ›æ”¯æ’‘ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #131722;
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        header h1 {
            font-size: 1.6rem;
            color: #2962ff;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        button,
        .file-label {
            padding: 8px 20px;
            background: #2962ff;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        .file-label {
            background: #1e222d;
            border: 1px dashed #363a45;
            color: #787b86;
        }

        #file-input {
            display: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .card {
            background: #1e222d;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #363a45;
        }

        .card h3 {
            color: #787b86;
            font-size: 0.85rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .signal-box {
            text-align: center;
            padding: 30px;
        }

        .signal {
            font-size: 3rem;
            font-weight: 700;
        }

        .signal.bullish {
            color: #26a65b;
        }

        .signal.bearish {
            color: #ef5350;
        }

        .signal.neutral {
            color: #ffeb3b;
        }

        .signal-text {
            font-size: 1.2rem;
            margin-top: 10px;
            color: #d1d4dc;
        }

        .score-bar {
            height: 30px;
            background: #363a45;
            border-radius: 15px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .score-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s;
        }

        .score-fill.support {
            background: linear-gradient(90deg, #26a65b, #2ecc71);
        }

        .score-fill.resistance {
            background: linear-gradient(90deg, #ef5350, #e74c3c);
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2962ff;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #787b86;
            margin-top: 5px;
        }

        #gauge-chart {
            width: 100%;
            height: 200px;
        }

        #dist-chart {
            width: 100%;
            height: 200px;
        }

        .table-container {
            background: #1e222d;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #363a45;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #363a45;
        }

        th {
            background: #131722;
            color: #787b86;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            color: #2962ff;
        }

        tr:hover {
            background: rgba(41, 98, 255, 0.1);
        }

        .price {
            color: #d1d4dc;
            font-weight: 600;
        }

        .up {
            color: #26a65b;
        }

        .down {
            color: #ef5350;
        }

        .neutral {
            color: #ffeb3b;
        }

        .link {
            color: #2962ff;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #787b86;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š æŒ‡æ•°æˆåˆ†è‚¡æ•´ä½“å‹åŠ›æ”¯æ’‘ç›‘æ§</h1>
        </header>

        <div class="controls">
            <label class="file-label" for="file-input">ğŸ“‚ åŠ è½½CSVæ•°æ®</label>
            <input type="file" id="file-input" accept=".csv">
            <button onclick="analyze()">ğŸ” å¼€å§‹åˆ†æ</button>
            <a href="stock_visualization.html" class="file-label" style="text-decoration:none">ğŸ“ˆ å•è‚¡åˆ†æ</a>
        </div>

        <div id="result" style="display:none">
            <div class="dashboard">
                <!-- äº¤æ˜“ä¿¡å· -->
                <div class="card signal-box">
                    <h3>äº¤æ˜“ä¿¡å·</h3>
                    <div id="signal" class="signal neutral">â€”</div>
                    <div id="signal-text" class="signal-text">è¯·åŠ è½½æ•°æ®</div>
                </div>

                <!-- å‹åŠ›æ”¯æ’‘å¯¹æ¯” -->
                <div class="card">
                    <h3>å‹åŠ›æ”¯æ’‘è¯„åˆ†</h3>
                    <div class="score-label"><span>æ”¯æ’‘å¼ºåº¦</span><span id="support-score">0</span></div>
                    <div class="score-bar">
                        <div id="support-bar" class="score-fill support" style="width:0%"></div>
                    </div>
                    <div class="score-label"><span>å‹åŠ›å¼ºåº¦</span><span id="resistance-score">0</span></div>
                    <div class="score-bar">
                        <div id="resistance-bar" class="score-fill resistance" style="width:0%"></div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="card">
                    <h3>ç»Ÿè®¡æ¦‚è§ˆ</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div id="stat-total" class="stat-value">0</div>
                            <div class="stat-label">è‚¡ç¥¨æ€»æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div id="stat-near-support" class="stat-value up">0</div>
                            <div class="stat-label">æ¥è¿‘æ”¯æ’‘</div>
                        </div>
                        <div class="stat-item">
                            <div id="stat-near-resistance" class="stat-value down">0</div>
                            <div class="stat-label">æ¥è¿‘å‹åŠ›</div>
                        </div>
                    </div>
                </div>

                <!-- ä»ªè¡¨ç›˜ -->
                <div class="card">
                    <h3>å¤šç©ºåŠ›é‡å¯¹æ¯”</h3>
                    <div id="gauge-chart"></div>
                </div>

                <!-- åˆ†å¸ƒå›¾ -->
                <div class="card">
                    <h3>è·ç¦»åˆ†å¸ƒ</h3>
                    <div id="dist-chart"></div>
                </div>
            </div>

            <!-- è¯¦æƒ…è¡¨æ ¼ -->
            <div class="table-container">
                <table id="stock-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">è‚¡ç¥¨ä»£ç  â†•</th>
                            <th onclick="sortTable(1)">è‚¡ç¥¨åç§° â†•</th>
                            <th onclick="sortTable(2)">ç°ä»· â†•</th>
                            <th onclick="sortTable(3)">è¯„åˆ† â†•</th>
                            <th onclick="sortTable(4)">å‹åŠ›åŒºé—´ â†•</th>
                            <th onclick="sortTable(5)">å‹åŠ›è·ç¦»% â†•</th>
                            <th onclick="sortTable(6)">æ”¯æ’‘åŒºé—´ â†•</th>
                            <th onclick="sortTable(7)">æ”¯æ’‘è·ç¦»% â†•</th>
                            <th onclick="sortTable(8)">çŠ¶æ€ â†•</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="loading" class="loading" style="display:none">æ­£åœ¨åˆ†æä¸­...</div>
    </div>

    <script>
        let rawData = [], stocks = [], stockResults = [];
        let gaugeChart = null, distChart = null;

        document.getElementById('file-input').onchange = function (e) {
            let f = e.target.files[0];
            if (!f) return;
            document.getElementById('loading').style.display = 'block';
            Papa.parse(f, {
                header: true,
                complete: function (r) {
                    rawData = r.data.filter(x => x.date && x.close);
                    let m = new Map();
                    rawData.forEach(x => { if (x['è‚¡ç¥¨ä»£ç '] && x['è‚¡ç¥¨åç§°']) m.set(x['è‚¡ç¥¨ä»£ç '], x['è‚¡ç¥¨åç§°']); });
                    stocks = Array.from(m.entries());
                    document.getElementById('loading').style.display = 'none';
                    alert('å·²åŠ è½½ ' + stocks.length + ' åªè‚¡ç¥¨æ•°æ®');
                }
            });
        };

        // LVNè¯†åˆ«ç®—æ³•ï¼ˆä¸å•è‚¡åˆ†æé¡µé¢ä¸€è‡´ï¼‰
        function findAllLVNZones(total, centers, maxVol, binSz) {
            let n = total.length;
            if (n < 5) return [];
            let zones = [];

            // æ–¹æ³•1: å±€éƒ¨æå°å€¼
            let windowSize = 3;
            for (let i = windowSize; i < n - windowSize; i++) {
                let current = total[i];
                let leftMax = Math.max(...total.slice(Math.max(0, i - windowSize), i));
                let rightMax = Math.max(...total.slice(i + 1, Math.min(n, i + windowSize + 1)));
                let isLocalMin = current < leftMax * 0.7 && current < rightMax * 0.7;
                let isBelowThreshold = current < maxVol * 0.6;
                if (isLocalMin && isBelowThreshold) {
                    let start = i, end = i;
                    while (start > 0 && total[start - 1] <= total[start] * 1.3 && total[start - 1] < maxVol * 0.6) start--;
                    while (end < n - 1 && total[end + 1] <= total[end] * 1.3 && total[end + 1] < maxVol * 0.6) end++;
                    let overlap = zones.some(z => !(end < z.startIdx || start > z.endIdx));
                    if (!overlap) zones.push({ startIdx: start, endIdx: end, priceHigh: centers[start] + binSz / 2, priceLow: centers[end] - binSz / 2 });
                }
            }

            // æ–¹æ³•2: è¿ç»­ä½æˆäº¤é‡
            let threshold50 = maxVol * 0.5;
            let i = 0;
            while (i < n) {
                if (total[i] < threshold50) {
                    let start = i;
                    while (i < n && total[i] < threshold50) i++;
                    let end = i - 1;
                    if (end - start >= 2) {
                        let overlap = zones.some(z => !(end < z.startIdx || start > z.endIdx));
                        if (!overlap) zones.push({ startIdx: start, endIdx: end, priceHigh: centers[start] + binSz / 2, priceLow: centers[end] - binSz / 2 });
                    }
                } else { i++; }
            }

            // æœ€ç»ˆè¿‡æ»¤
            zones = zones.filter(z => {
                let sum = 0;
                for (let i = z.startIdx; i <= z.endIdx; i++) sum += total[i];
                let avgVol = sum / (z.endIdx - z.startIdx + 1);
                return avgVol < maxVol * 0.55;
            });

            zones.sort((a, b) => a.startIdx - b.startIdx);
            return zones;
        }

        function calcVP(data, bins, yMin, yMax) {
            if (!data.length || yMin >= yMax) return null;
            let binSz = (yMax - yMin) / bins;
            let profUp = Array(bins).fill(0), profDn = Array(bins).fill(0), centers = [];
            for (let i = 0; i < bins; i++) centers.push(yMin + binSz * (i + 0.5));
            data.forEach(x => {
                let o = +x.open, c = +x.close, h = +x.high, l = +x.low, v = +x.volume || 0;
                if (v === 0 || h <= l) return;
                let isUp = c >= o;
                for (let i = 0; i < bins; i++) {
                    let bL = yMin + binSz * i, bH = yMin + binSz * (i + 1);
                    let oL = Math.max(l, bL), oH = Math.min(h, bH);
                    if (oH > oL) {
                        let vol = v * (oH - oL) / (h - l);
                        if (isUp) profUp[i] += vol; else profDn[i] += vol;
                    }
                }
            });
            let total = profUp.map((u, i) => u + profDn[i]);
            let mx = Math.max(...total);
            return { centers, total, mx, binSz };
        }

        function analyzeStock(code) {
            let data = rawData.filter(x => x['è‚¡ç¥¨ä»£ç '] === code);
            if (data.length < 30) return null; // éœ€è¦è¶³å¤Ÿæ•°æ®è®¡ç®—MA28

            let yMin = Math.min(...data.map(x => +x.low)) * 0.98;
            let yMax = Math.max(...data.map(x => +x.high)) * 1.02;
            let vp = calcVP(data, 60, yMin, yMax);
            if (!vp) return null;

            let zones = findAllLVNZones(vp.total, vp.centers, vp.mx, vp.binSz);
            let currentPrice = +data[data.length - 1].close;
            let currentHigh = +data[data.length - 1].high;
            let currentLow = +data[data.length - 1].low;
            let currentVol = +data[data.length - 1].volume;

            // è®¡ç®—MA28æˆäº¤é‡
            let vol28 = data.slice(-28).reduce((s, x) => s + (+x.volume || 0), 0) / 28;

            // è®¡ç®—VPå¹³å‡å€¼
            let vpAvg = vp.total.reduce((s, v) => s + v, 0) / vp.total.length;

            // è·å–æœ€è¿‘5å¤©æ•°æ®
            let recent5 = data.slice(-5);
            let price5DaysAgo = +data[data.length - 5]?.close || currentPrice;
            let price3DaysAgo = +data[data.length - 3]?.close || currentPrice; // ç”¨äºåˆ¤æ–­å‹åŠ›/æ”¯æ’‘åŒºé—´

            // ============ æ–°è¯„åˆ†ç³»ç»Ÿ ============
            // è§„åˆ™ï¼šKçº¿ä¸è§¦åŠä»»ä½•åŒºé—´ = è¯„åˆ†ä¸º0
            // Kçº¿è§¦åŠå‹åŠ›åŒºé—´ = æ­£æ•°ï¼Œè§¦åŠæ”¯æ’‘åŒºé—´ = è´Ÿæ•°

            let score = 0;
            let inZone = null;
            let zoneType = null; // 'resistance' or 'support'

            // æ£€æŸ¥Kçº¿æ˜¯å¦è§¦åŠæŸä¸ªåŒºé—´ï¼ˆä½¿ç”¨æœ€é«˜ä»·å’Œæœ€ä½ä»·ï¼‰
            for (let z of zones) {
                // Kçº¿è§¦åŠåŒºé—´ = æœ€é«˜ä»·>=åŒºé—´ä¸‹æ²¿ ä¸” æœ€ä½ä»·<=åŒºé—´ä¸Šæ²¿
                if (currentHigh >= z.priceLow && currentLow <= z.priceHigh) {
                    inZone = z;
                    break;
                }
            }

            // ç¡®å®šåŒºé—´ç±»å‹ï¼ˆå‹åŠ›è¿˜æ˜¯æ”¯æ’‘ï¼‰
            // æ ¹æ®Kçº¿è¿›å…¥æ–¹å‘åˆ¤æ–­ï¼šä»ä¸‹å¾€ä¸Šè¿›å…¥=å‹åŠ›åŒºé—´ï¼Œä»ä¸Šå¾€ä¸‹è¿›å…¥=æ”¯æ’‘åŒºé—´
            if (inZone) {
                // åˆ¤æ–­è¿›å…¥æ–¹å‘ï¼šçœ‹5å¤©å‰ä»·æ ¼
                if (price5DaysAgo < inZone.priceLow) {
                    zoneType = 'resistance'; // ä»ä¸‹å¾€ä¸Šè¿›å…¥=å‹åŠ›
                } else if (price5DaysAgo > inZone.priceHigh) {
                    zoneType = 'support'; // ä»ä¸Šå¾€ä¸‹è¿›å…¥=æ”¯æ’‘
                } else {
                    // 5å¤©å‰å°±åœ¨åŒºé—´å†…ï¼Œçœ‹æ›´æ—©çš„ä»·æ ¼
                    let earlierPrice = +data[Math.max(0, data.length - 10)]?.close || currentPrice;
                    zoneType = earlierPrice < inZone.priceLow ? 'resistance' : 'support';
                }

                // ============ è®¡ç®—åŒºé—´åŠ›åº¦ ============
                // åŠ›åº¦ = 100 Ã— (1 - VP/å¹³å‡VP) Ã— æ—¶é—´è¡°å‡ Ã— è§¦åŠè¡°å‡

                // 1. VPè¶Šå°åŠ›åº¦è¶Šå¼º
                let zoneVpSum = 0;
                for (let i = inZone.startIdx; i <= inZone.endIdx; i++) {
                    zoneVpSum += vp.total[i];
                }
                let zoneVpAvg = zoneVpSum / (inZone.endIdx - inZone.startIdx + 1);
                let vpStrength = Math.max(0, 1 - zoneVpAvg / vpAvg);

                // 2. æ—¶é—´è¡°å‡ï¼šæ‰¾åˆ°è¯¥åŒºé—´æœ€è¿‘çš„å½¢æˆæ—¶é—´
                // ç®€åŒ–ï¼šå‡è®¾ä½é‡èƒ½åŒºæ˜¯æœ€è¿‘æ‰å½¢æˆçš„æœ‰æ•ˆåŒºåŸŸ
                let daysSinceFormed = 30; // é»˜è®¤30å¤©
                for (let i = data.length - 1; i >= Math.max(0, data.length - 180); i--) {
                    let d = data[i];
                    if (+d.high >= inZone.priceLow && +d.low <= inZone.priceHigh) {
                        daysSinceFormed = data.length - 1 - i;
                        break;
                    }
                }
                let timeDecay = Math.pow(0.5, daysSinceFormed / 180);

                // 3. è§¦åŠæ¬¡æ•°è¡°å‡
                let touchCount = 0;
                for (let d of data) {
                    if (+d.high >= inZone.priceLow && +d.low <= inZone.priceHigh) {
                        touchCount++;
                    }
                }
                let touchDecay = Math.pow(0.9, touchCount);

                // åŸºç¡€åŠ›åº¦
                let baseStrength = 100 * vpStrength * timeDecay * touchDecay;

                // ============ Kçº¿è¿åŠ¨è°ƒæ•´ ============

                // 1. å¿«é€Ÿæ¥è¿‘åŠ åˆ†
                let dist5DaysAgo = Math.abs(price5DaysAgo - (inZone.priceLow + inZone.priceHigh) / 2) / price5DaysAgo * 100;
                let rushBonus = 0;
                if (dist5DaysAgo < 2) rushBonus = 0;
                else if (dist5DaysAgo < 3) rushBonus = 0.1;
                else if (dist5DaysAgo < 5) rushBonus = 0.2;
                else if (dist5DaysAgo < 8) rushBonus = 0.35;
                else if (dist5DaysAgo < 10) rushBonus = 0.5;
                else rushBonus = 0.7;

                // 2. å¾˜å¾Šè¡°å‡
                let daysInZone = 0;
                for (let d of recent5) {
                    if (+d.high >= inZone.priceLow && +d.low <= inZone.priceHigh) {
                        daysInZone++;
                    }
                }
                let lingerDecay = daysInZone >= 3 ? 0.5 : 0;

                // 3. ä¸Šå½±æ”¾é‡åŠ åˆ†ï¼ˆä»…å¯¹å‹åŠ›åŒºé—´æœ‰æ•ˆï¼‰
                let shadowVolumeBonus = 0;
                if (zoneType === 'resistance') {
                    // å½“æ—¥æœ€é«˜åœ¨åŒºé—´å†…æˆ–ä¸Šæ–¹ï¼Œæ”¶ç›˜ä½äºåŒºé—´ï¼Œæ”¾é‡
                    if (currentHigh >= inZone.priceLow && currentPrice < inZone.priceLow && currentVol > vol28) {
                        shadowVolumeBonus = 0.3;
                    }
                }

                // æœ€ç»ˆåˆ†æ•°
                let adjustment = 1 + rushBonus - lingerDecay + shadowVolumeBonus;
                score = baseStrength * adjustment;

                // æ–¹å‘ï¼šå‹åŠ›ä¸ºæ­£ï¼Œæ”¯æ’‘ä¸ºè´Ÿ
                if (zoneType === 'support') {
                    score = -score;
                }

                // é™åˆ¶èŒƒå›´
                score = Math.max(-100, Math.min(100, score));
            }

            // æ‰¾æœ€è¿‘çš„å‹åŠ›ä½å’Œæ”¯æ’‘ä½ï¼ˆç”¨äºè¡¨æ ¼æ˜¾ç¤ºï¼‰
            // ä½¿ç”¨3å¤©å‰æ”¶ç›˜ä»·ä½œä¸ºåŸºå‡†åˆ¤æ–­ï¼Œé¿å…å½“å¤©è§¦åŠååŒºé—´æ¶ˆå¤±
            let supports = zones.filter(z => z.priceHigh < price3DaysAgo);  // æ”¯æ’‘ï¼šä½äº3å¤©å‰ä»·æ ¼
            let pressures = zones.filter(z => z.priceLow > price3DaysAgo);  // å‹åŠ›ï¼šé«˜äº3å¤©å‰ä»·æ ¼

            let nearestResistance = pressures.length > 0 ?
                pressures.reduce((a, b) => (a.priceLow < b.priceLow ? a : b)) : null;
            let nearestSupport = supports.length > 0 ?
                supports.reduce((a, b) => (a.priceHigh > b.priceHigh ? a : b)) : null;

            // ä½¿ç”¨åŒºé—´ä¸­ç‚¹è®¡ç®—è·ç¦»
            let resistancePrice = nearestResistance ? (nearestResistance.priceLow + nearestResistance.priceHigh) / 2 : null;
            let supportPrice = nearestSupport ? (nearestSupport.priceLow + nearestSupport.priceHigh) / 2 : null;

            let resistanceDist = resistancePrice ? ((resistancePrice - currentPrice) / currentPrice * 100) : null;
            let supportDist = supportPrice ? ((currentPrice - supportPrice) / currentPrice * 100) : null;

            return {
                code: code,
                name: stocks.find(s => s[0] === code)?.[1] || code,
                currentPrice: currentPrice,
                // å‹åŠ›åŒºé—´ä¿¡æ¯
                resistanceLow: nearestResistance?.priceLow || null,
                resistanceHigh: nearestResistance?.priceHigh || null,
                resistanceDist: resistanceDist,
                // æ”¯æ’‘åŒºé—´ä¿¡æ¯
                supportLow: nearestSupport?.priceLow || null,
                supportHigh: nearestSupport?.priceHigh || null,
                supportDist: supportDist,
                inZone: inZone !== null,
                zoneType: zoneType,
                score: score,
                resistanceCount: pressures.length,
                supportCount: supports.length
            };
        }

        // è·ç¦»è¡°å‡å‡½æ•° - ç±»ä¼¼æœŸæƒGammaæ•ˆåº”
        // è¶Šæ¥è¿‘å…³é”®ä½ï¼ŒåŠ›åº¦è¶Šå¤§ï¼ˆéçº¿æ€§å¢é•¿ï¼‰
        // ä½¿ç”¨æŒ‡æ•°è¡°å‡: weight = e^(-k*dist)
        // å½“dist=0æ—¶ï¼Œweight=1ï¼ˆæœ€å¤§åŠ›åº¦ï¼‰
        // å½“distè¶‹å‘æ— ç©·æ—¶ï¼Œweightè¶‹å‘0
        function getDistanceWeight(dist) {
            if (dist === null || dist < 0) return 0;

            // è¡°å‡ç³»æ•°kï¼Œæ§åˆ¶è¡°å‡é€Ÿåº¦
            // kè¶Šå¤§ï¼Œè¿œè·ç¦»è¡°å‡è¶Šå¿«
            const k = 0.3;

            // æŒ‡æ•°è¡°å‡
            let weight = Math.exp(-k * dist);

            // è·ç¦»<1%æ—¶é¢å¤–åŠ æˆï¼ˆç±»ä¼¼ITMæœŸæƒçš„Deltaæ¥è¿‘1ï¼‰
            if (dist < 1) {
                weight *= 1.5;  // 50%åŠ æˆ
            } else if (dist < 2) {
                weight *= 1.2;  // 20%åŠ æˆ
            }

            return weight;
        }

        function analyze() {
            if (stocks.length === 0) {
                alert('è¯·å…ˆåŠ è½½CSVæ•°æ®');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            setTimeout(() => {
                stockResults = [];
                stocks.forEach(([code, name]) => {
                    let result = analyzeStock(code);
                    if (result) stockResults.push(result);
                });

                // æ±‡æ€»è®¡ç®— - ä½¿ç”¨ç»¼åˆè¯„åˆ†
                let totalScore = 0;
                let nearSupportCount = 0, nearResistanceCount = 0;
                let bullishCount = 0, bearishCount = 0;

                stockResults.forEach(r => {
                    totalScore += r.score;
                    if (r.score < -10) bullishCount++;
                    else if (r.score > 10) bearishCount++;

                    if (r.supportDist !== null && r.supportDist < 5) nearSupportCount++;
                    if (r.resistanceDist !== null && r.resistanceDist < 5) nearResistanceCount++;
                });

                let avgScore = stockResults.length > 0 ? totalScore / stockResults.length : 0;

                // è®¡ç®—å‹åŠ›å’Œæ”¯æ’‘çš„å¹³å‡åŠ›åº¦ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                let avgSupportScore = stockResults.length > 0 ?
                    (stockResults.reduce((s, r) => s + (r.score < 0 ? Math.abs(r.score) : 0), 0) / stockResults.length).toFixed(1) : 0;
                let avgResistanceScore = stockResults.length > 0 ?
                    (stockResults.reduce((s, r) => s + (r.score > 0 ? r.score : 0), 0) / stockResults.length).toFixed(1) : 0;

                // æ›´æ–°UI
                document.getElementById('support-score').textContent = avgSupportScore;
                document.getElementById('resistance-score').textContent = avgResistanceScore;
                document.getElementById('support-bar').style.width = Math.min(avgSupportScore, 100) + '%';
                document.getElementById('resistance-bar').style.width = Math.min(avgResistanceScore, 100) + '%';

                document.getElementById('stat-total').textContent = stockResults.length;
                document.getElementById('stat-near-support').textContent = nearSupportCount + ' (' + bullishCount + 'åå¤š)';
                document.getElementById('stat-near-resistance').textContent = nearResistanceCount + ' (' + bearishCount + 'åç©º)';

                // äº¤æ˜“ä¿¡å· - åŸºäºå¹³å‡è¯„åˆ†
                let signalEl = document.getElementById('signal');
                let signalTextEl = document.getElementById('signal-text');

                if (avgScore < -5) {
                    signalEl.textContent = 'ğŸŸ¢';
                    signalEl.className = 'signal bullish';
                    signalTextEl.textContent = 'åå¤š (æ•´ä½“è¯„åˆ†: ' + avgScore.toFixed(1) + ')';
                } else if (avgScore > 5) {
                    signalEl.textContent = 'ğŸ”´';
                    signalEl.className = 'signal bearish';
                    signalTextEl.textContent = 'åç©º (æ•´ä½“è¯„åˆ†: +' + avgScore.toFixed(1) + ')';
                } else {
                    signalEl.textContent = 'ğŸŸ¡';
                    signalEl.className = 'signal neutral';
                    signalTextEl.textContent = 'è§‚æœ› (æ•´ä½“è¯„åˆ†: ' + (avgScore > 0 ? '+' : '') + avgScore.toFixed(1) + ')';
                }

                // æ¸²æŸ“è¡¨æ ¼
                renderTable();

                // æ¸²æŸ“å›¾è¡¨
                renderGauge(avgSupportScore, avgResistanceScore);
                renderDistChart();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('result').style.display = 'block';
            }, 100);
        }

        function renderTable() {
            let tbody = document.getElementById('table-body');
            tbody.innerHTML = stockResults.map(r => {
                // çŠ¶æ€æ˜¾ç¤º
                let status = '', statusClass = 'neutral';
                if (r.inZone) {
                    if (r.zoneType === 'resistance') {
                        status = 'ğŸ”´ åœ¨å‹åŠ›åŒº'; statusClass = 'down';
                    } else {
                        status = 'ğŸŸ¢ åœ¨æ”¯æ’‘åŒº'; statusClass = 'up';
                    }
                } else {
                    status = 'æ­£å¸¸';
                }

                // è¯„åˆ†é¢œè‰²
                let scoreClass = r.score > 10 ? 'down' : (r.score < -10 ? 'up' : 'neutral');
                let scoreDisplay = r.score === 0 ? '0' : ((r.score > 0 ? '+' : '') + r.score.toFixed(1));

                // åŒºé—´æ˜¾ç¤ºæ ¼å¼
                let resistanceZone = r.resistanceLow ? `${r.resistanceLow.toFixed(2)}-${r.resistanceHigh.toFixed(2)}` : '-';
                let supportZone = r.supportLow ? `${r.supportLow.toFixed(2)}-${r.supportHigh.toFixed(2)}` : '-';

                return `<tr>
                    <td><a href="stock_visualization.html?code=${r.code}" class="link">${r.code}</a></td>
                    <td>${r.name}</td>
                    <td class="price">${r.currentPrice.toFixed(2)}</td>
                    <td class="${scoreClass}" style="font-weight:bold">${scoreDisplay}</td>
                    <td>${resistanceZone}</td>
                    <td class="${r.resistanceDist && r.resistanceDist < 5 ? 'down' : ''}">${r.resistanceDist !== null ? '+' + r.resistanceDist.toFixed(1) + '%' : '-'}</td>
                    <td>${supportZone}</td>
                    <td class="${r.supportDist && r.supportDist < 5 ? 'up' : ''}">${r.supportDist !== null ? '-' + r.supportDist.toFixed(1) + '%' : '-'}</td>
                    <td class="${statusClass}">${status}</td>
                </tr>`;
            }).join('');
        }

        let sortDir = 1;
        function sortTable(col) {
            sortDir *= -1;
            stockResults.sort((a, b) => {
                let va, vb;
                switch (col) {
                    case 0: va = a.code; vb = b.code; break;
                    case 1: va = a.name; vb = b.name; break;
                    case 2: va = a.currentPrice; vb = b.currentPrice; break;
                    case 3: va = a.score; vb = b.score; break;  // è¯„åˆ†
                    case 4: va = a.resistancePrice || 9999; vb = b.resistancePrice || 9999; break;
                    case 5: va = a.resistanceDist || 9999; vb = b.resistanceDist || 9999; break;
                    case 6: va = a.supportPrice || 0; vb = b.supportPrice || 0; break;
                    case 7: va = a.supportDist || 9999; vb = b.supportDist || 9999; break;
                    case 8: va = a.supportDist || 9999; vb = b.supportDist || 9999; break;
                }
                if (typeof va === 'string') return va.localeCompare(vb) * sortDir;
                return (va - vb) * sortDir;
            });
            renderTable();
        }

        function renderGauge(support, resistance) {
            if (!gaugeChart) gaugeChart = echarts.init(document.getElementById('gauge-chart'));
            let value = support - resistance;
            gaugeChart.setOption({
                backgroundColor: 'transparent',
                series: [{
                    type: 'gauge',
                    min: -100, max: 100,
                    splitNumber: 10,
                    axisLine: {
                        lineStyle: {
                            width: 20,
                            color: [[0.3, '#ef5350'], [0.5, '#ffeb3b'], [0.7, '#ffeb3b'], [1, '#26a65b']]
                        }
                    },
                    pointer: { itemStyle: { color: '#fff' }, width: 5 },
                    axisTick: { show: false },
                    splitLine: { length: 10, lineStyle: { color: '#363a45' } },
                    axisLabel: { color: '#787b86', fontSize: 10 },
                    detail: { valueAnimation: true, formatter: '{value}', color: '#fff', fontSize: 20, offsetCenter: [0, '70%'] },
                    data: [{ value: value.toFixed(0) }]
                }]
            });
        }

        function renderDistChart() {
            if (!distChart) distChart = echarts.init(document.getElementById('dist-chart'));
            let supportDists = stockResults.filter(r => r.supportDist !== null).map(r => r.supportDist);
            let resistanceDists = stockResults.filter(r => r.resistanceDist !== null).map(r => r.resistanceDist);

            let bins = ['<3%', '3-5%', '5-10%', '>10%'];
            let supportCounts = [0, 0, 0, 0], resistanceCounts = [0, 0, 0, 0];

            supportDists.forEach(d => {
                if (d < 3) supportCounts[0]++;
                else if (d < 5) supportCounts[1]++;
                else if (d < 10) supportCounts[2]++;
                else supportCounts[3]++;
            });
            resistanceDists.forEach(d => {
                if (d < 3) resistanceCounts[0]++;
                else if (d < 5) resistanceCounts[1]++;
                else if (d < 10) resistanceCounts[2]++;
                else resistanceCounts[3]++;
            });

            distChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                legend: { data: ['æ”¯æ’‘è·ç¦»', 'å‹åŠ›è·ç¦»'], textStyle: { color: '#787b86' } },
                grid: { left: 40, right: 10, top: 40, bottom: 30 },
                xAxis: { type: 'category', data: bins, axisLabel: { color: '#787b86' }, axisLine: { lineStyle: { color: '#363a45' } } },
                yAxis: { type: 'value', axisLabel: { color: '#787b86' }, splitLine: { lineStyle: { color: '#1e222d' } } },
                series: [
                    { name: 'æ”¯æ’‘è·ç¦»', type: 'bar', data: supportCounts, itemStyle: { color: '#26a65b' } },
                    { name: 'å‹åŠ›è·ç¦»', type: 'bar', data: resistanceCounts, itemStyle: { color: '#ef5350' } }
                ]
            });
        }

        window.onresize = function () {
            if (gaugeChart) gaugeChart.resize();
            if (distChart) distChart.resize();
        };
    </script>
</body>

</html>