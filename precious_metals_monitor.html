<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“‚é’¯è·¨å¸‚åœºå¥—åˆ©ç›‘æ§ | Precious Metals Arbitrage</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="echarts.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-card-hover: #252b3d;
            --border-color: #2d3748;
            --text-primary: #f0f4f8;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-gold: #fbbf24;
            --accent-platinum: #e5e7eb;
            --accent-palladium: #a78bfa;
            --positive: #22c55e;
            --negative: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --gradient-gold: linear-gradient(135deg, #fbbf24, #d97706);
            --gradient-platinum: linear-gradient(135deg, #94a3b8, #64748b);
            --gradient-palladium: linear-gradient(135deg, #a78bfa, #7c3aed);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: var(--gradient-gold);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-platinum));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--positive);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .refresh-btn {
            padding: 10px 20px;
            background: var(--gradient-gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-width: 100%;
        }

        /*
        @media (max-width: 1200px) { ... } Removed as no longer needed for complex switch
        */

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
            display: block;
            /* Reset grid */
        }

        /* Responsive */
        @media (max-width: 900px) {
            .card {
                grid-template-columns: 1fr;
                /* Stack on mobile */
            }

            .card-header,
            .spread-section,
            .price-grid {
                grid-column: 1 / -1;
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-icon.platinum {
            background: var(--gradient-platinum);
        }

        .card-icon.palladium {
            background: var(--gradient-palladium);
        }

        .card-title h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-title span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Price Display */
        .price-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
            padding: 0;
            background: none;
        }

        .price-item {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            display: block;
            /* Reset flex */
        }

        .price-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .price-value.cny {
            color: var(--accent-gold);
        }

        .price-value.usd {
            color: var(--info);
        }

        .price-sub {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Spread Display */
        .spread-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(167, 139, 250, 0.1));
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .spread-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .spread-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .spread-value.positive {
            color: var(--negative);
        }

        .spread-value.negative {
            color: var(--positive);
        }

        .spread-pct {
            font-size: 1.2rem;
            margin-top: 4px;
        }

        .spread-direction {
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* Exchange Rate */
        .exchange-rate {
            text-align: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .exchange-rate span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        /* Trading Rules Section */
        .rules-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .rules-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rules-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .rules-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .rules-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .rules-content.collapsed {
            display: none;
        }

        .rule-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
        }

        .rule-card h4 {
            font-size: 0.9rem;
            color: var(--accent-gold);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rule-card table {
            width: 100%;
            font-size: 0.85rem;
        }

        .rule-card td {
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .rule-card td:first-child {
            color: var(--text-secondary);
        }

        .rule-card td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.2), rgba(251, 191, 36, 0.2));
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .alert-banner.opportunity {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), rgba(59, 130, 246, 0.2));
            border-color: var(--positive);
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-content h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .alert-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Last Update */
        .last-update {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Risk Warning */
        .risk-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .risk-warning h4 {
            color: var(--negative);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-warning ul {
            list-style: none;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .risk-warning li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .risk-warning li::before {
            content: "âš ";
            position: absolute;
            left: 0;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }

            .price-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <style>
        /* Trading Calculator Section */
        .calculator-section {
            background: linear-gradient(135deg, var(--bg-card), #1e293b);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 30px;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.1);
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .calculator-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent-gold);
        }

        .calculator-tabs {
            display: flex;
            gap: 8px;
        }

        .calc-tab {
            padding: 8px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .calc-tab.active {
            background: var(--gradient-gold);
            color: #000;
            border-color: var(--accent-gold);
            font-weight: 600;
        }

        .calculator-body {
            display: block;
            /* Removed grid constraint as inner content handles layout */
            /* grid-template-columns: 1fr 2fr; */
            /* gap: 24px; */
        }

        @media (max-width: 900px) {
            .calculator-body {
                grid-template-columns: 1fr;
            }
        }

        .calc-input-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
        }

        .calc-input-group {
            margin-bottom: 20px;
        }

        .calc-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .calc-input-group input,
        .calc-input-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
        }

        .calc-input-group input:focus,
        .calc-input-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .calc-btn {
            width: 100%;
            padding: 14px 20px;
            background: var(--gradient-gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .calc-btn:hover {
            transform: translateY(-2px);
        }

        .calc-result-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .calc-result-section {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--border-color);
        }

        .result-card.margin {
            border-left-color: var(--info);
        }

        .result-card.profit {
            border-left-color: var(--positive);
        }

        .result-card.risk {
            border-left-color: var(--negative);
        }

        .result-card.strategy {
            border-left-color: var(--accent-gold);
        }

        .result-card h4 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-value.gold {
            color: var(--accent-gold);
        }

        .result-value.green {
            color: var(--positive);
        }

        .result-value.red {
            color: var(--negative);
        }

        .result-value.blue {
            color: var(--info);
        }

        .result-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .strategy-box {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(167, 139, 250, 0.15));
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .strategy-box h4 {
            color: var(--accent-gold);
            margin-bottom: 16px;
            font-size: 0.95rem;
        }

        .strategy-steps {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 700px) {
            .strategy-steps {
                grid-template-columns: 1fr;
            }
        }

        .strategy-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: var(--gradient-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .step-content strong {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .step-content span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .risk-meter {
            margin-top: 12px;
        }

        .risk-bar {
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .risk-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .risk-fill.low {
            background: var(--positive);
            width: 30%;
        }

        .risk-fill.medium {
            background: var(--warning);
            width: 60%;
        }

        .risk-fill.high {
            background: var(--negative);
            width: 90%;
        }

        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">ğŸ’</div>
                <div class="header-title">
                    <h1>é“‚é’¯è·¨å¸‚åœºå¥—åˆ©ç›‘æ§</h1>
                    <p>å¹¿æœŸæ‰€ vs å›½é™…å¸‚åœº å®æ—¶ä»·å·®åˆ†æ</p>
                </div>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <!-- æ±‡ç‡ã€æ—¶é—´ã€æº¢ä»·çŠ¶æ€ -->
                <div
                    style="display: flex; align-items: center; gap: 12px; font-size: 0.8rem; color: var(--text-secondary);">
                    <span>ğŸ“Š <span id="exchange-rate">USD/CNY = 7.04</span></span>
                </div>

                <div class="status-indicator" style="display: flex; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div id="gfex-dot" class="status-dot"></div>
                        <span id="gfex-status" style="font-size: 0.7rem;">å¹¿æœŸæ‰€</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div id="nymex-dot" class="status-dot"></div>
                        <span id="nymex-status" style="font-size: 0.7rem;">NYMEX</span>
                    </div>
                </div>
                <span style="font-size: 0.7rem; color: var(--text-muted);">æœ€æ–°è·å–æ—¶é—´: <span id="data-time">--</span></span>
                <button class="refresh-btn" onclick="refreshData()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>
        </header>

        <!-- Price Cards - åŠ¨æ€æŒ‰ä»·å·®æ’åº -->
        <div id="spread-ranking-container" class="spread-ranking">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸ“Š ä»·å·®æ’è¡Œæ¦œ
                    <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal;">æŒ‰ä»·å·®ä»å¤§åˆ°å°æ’åº</span>
                </h3>
            </div>
            <div id="spread-cards" class="dashboard-grid">
                <!-- åŠ¨æ€ç”Ÿæˆé…å¯¹å¡ç‰‡ -->
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">ğŸ“Š åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- Trading Calculator -->
        <div class="calculator-section" id="calculator">
            <div class="calculator-header">
                <div style="display: flex; gap: 20px; align-items: center;">
                    <h2>ğŸ§® å¥—åˆ©åˆ†æ</h2>
                    <span id="selected-pair-info"
                        style="color: var(--text-secondary); font-size: 0.95rem; font-weight: 500; margin-top: 4px;"></span>
                </div>
                <div id="calc-pair-tabs" style="display: flex; gap: 12px; align-items: center;">
                    <!-- Dropdown containers will be injected here -->
                </div>
            </div>

            <div class="calculator-body">

                <!-- Result Section - å·¦å³ä¸¤åˆ—å¸ƒå±€ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch;">

                    <!-- å·¦åˆ—ï¼šæ”¶ç›Šåˆ†æ -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">

                        <!-- ä¸¤ä¸ªæ”¶ç›Šå¡ç‰‡å¹¶æ’æ˜¾ç¤º -->
                        <div style="display: flex; gap: 12px; align-items: stretch;">
                            <!-- é¢„æœŸæ¯›æ”¶ç›Š (å®Œå…¨æ”¶æ•›) -->
                            <div class="result-card"
                                style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                                    <h4 style="margin: 0;">é¢„æœŸæ¯›æ”¶ç›Š</h4>
                                    <span class="result-sub" style="color: var(--text-secondary); font-size: 0.8rem;"
                                        id="gross-profit-detail">ä»·å·®--å…ƒ/å…‹ Ã— --å…‹</span>
                                </div>
                                <div class="result-value" style="color: var(--positive); font-size: 1.8rem; flex: 1;"
                                    id="result-gross-profit">--</div>
                                <div style="color: var(--negative); font-weight: 700; font-size: 0.8rem; margin-top: 8px;"
                                    id="result-condition-full">è‹¥ä»·å·®å®Œå…¨æ”¶æ•›</div>
                            </div>

                            <!-- é¢„æœŸæ¯›æ”¶ç›Š (å‡å€¼æ”¶æ•›) -->
                            <div class="result-card"
                                style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                                    <h4 style="margin: 0;">é¢„æœŸæ¯›æ”¶ç›Š</h4>
                                    <span class="result-sub" style="color: var(--text-secondary); font-size: 0.8rem;"
                                        id="avg-profit-detail">ä»·å·®--å…ƒ/å…‹ Ã— --å…‹</span>
                                </div>
                                <div class="result-value" style="color: var(--accent-gold); font-size: 1.8rem; flex: 1;"
                                    id="result-avg-profit">--</div>
                                <div style="color: var(--negative); font-weight: 700; font-size: 0.8rem; margin-top: 8px;"
                                    id="result-condition-avg">è‹¥ä»·å·®æ”¶æ•›è‡³å‡å€¼ 16%</div>
                            </div>
                        </div>

                        <!-- ç¬¬äºŒè¡Œï¼šé¢„è®¡è´¹ç”¨ -->
                        <div
                            style="display: flex; gap: 12px; align-items: stretch; background: var(--bg-secondary); border-radius: 8px; padding: 12px 16px;">
                            <!-- äº¤æ˜“æ‰‹ç»­è´¹ -->
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">äº¤æ˜“æ‰‹ç»­è´¹
                                </div>
                                <div style="font-size: 1rem; color: var(--warning); font-weight: 600;"
                                    id="result-trading-fee">--
                                </div>
                                <div style="font-size: 0.65rem; color: var(--text-hint);">åŒè¾¹ä¸‡åˆ†ä¹‹äºŒ</div>
                            </div>
                            <div style="width: 1px; background: var(--border-color);"></div>
                            <!-- ç»çºªä½£é‡‘ -->
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">ç»çºªä½£é‡‘
                                </div>
                                <div style="font-size: 1rem; color: var(--warning); font-weight: 600;"
                                    id="result-broker-fee">~Â¥200
                                </div>
                                <div style="font-size: 0.65rem; color: var(--text-hint);">é¢„ä¼°å›ºå®š</div>
                            </div>
                            <div style="width: 1px; background: var(--border-color);"></div>
                            <!-- æ»‘ç‚¹æˆæœ¬ -->
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">æ»‘ç‚¹æˆæœ¬
                                </div>
                                <div style="font-size: 1rem; color: var(--warning); font-weight: 600;"
                                    id="result-slippage">--</div>
                                <div style="font-size: 0.65rem; color: var(--text-hint);">~0.1%</div>
                            </div>
                        </div>

                        <!-- é£é™©å› ç´  -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="result-card" style="padding: 12px 16px;">
                                <h4 style="margin-bottom: 8px;">ğŸ’± å¤–æ±‡æ³¢åŠ¨å½±å“</h4>
                                <div class="result-value"
                                    style="color: var(--info); font-size: 1.2rem; margin-bottom: 4px;"
                                    id="result-fx-impact">--</div>
                                <div class="result-sub" style="font-size: 0.75rem;">
                                    <span style="color: var(--positive);">7.04â†’7.11 âœ…æœ‰åˆ©</span>
                                    <span style="color: var(--text-muted); margin: 0 6px;">|</span>
                                    <span style="color: var(--negative);">7.04â†’6.97 âŒä¸åˆ©</span>
                                </div>
                            </div>
                            <div class="result-card" style="padding: 12px 16px;">
                                <h4 style="margin-bottom: 8px;">âš–ï¸ åˆçº¦æ•å£å½±å“</h4>
                                <div class="result-value"
                                    style="color: var(--warning); font-size: 1.2rem; margin-bottom: 4px;"
                                    id="result-exposure-impact">--</div>
                                <div class="result-sub" id="exposure-impact-detail" style="font-size: 0.75rem;">æ•å£110å…‹ Ã—
                                    10%æ³¢åŠ¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- å³åˆ—ï¼šèµ„é‡‘åˆ†é…å»ºè®® -->
                    <div class="result-card"
                        style="border-left-color: var(--info); display: flex; flex-direction: column;">
                        <h4 style="display: flex; align-items: center; justify-content: space-between;">
                            <span>ğŸ’° èµ„é‡‘åˆ†é…å»ºè®® <span
                                    style="font-size: 0.65rem; color: var(--text-muted); font-weight: normal;">(å¹³è¡¡çˆ†ä»“é£é™©)</span></span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 0.7rem; color: var(--text-muted);">æ€»èµ„é‡‘:</span>
                                <input type="number" id="calc-total-capital" value="1500000" step="100000"
                                    onchange="updateCapitalAllocation()"
                                    style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 6px; border-radius: 4px; width: 90px; font-size: 0.75rem;">
                            </span>
                        </h4>

                        <!-- CMEåˆ†é…æ¯”ä¾‹æ»‘å— -->
                        <div style="margin: 10px 0; padding: 10px; background: var(--bg-primary); border-radius: 6px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 0.8rem; color: var(--text-muted);">CMEåˆ†é…æ¯”ä¾‹:</span>
                                <span id="cme-ratio-display"
                                    style="font-size: 0.9rem; font-weight: 600; color: var(--info);">35%</span>
                            </div>
                            <input type="range" id="cme-ratio-slider" min="30" max="70" value="35" step="5"
                                oninput="updateCmeRatioDisplay(); updateCapitalAllocation();"
                                style="width: 100%; cursor: pointer; accent-color: var(--info);">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.6rem; color: var(--text-muted); margin-top: 2px;">
                                <span>â† åå‘å¹¿æœŸæ‰€</span>
                                <span>åå‘CME â†’</span>
                            </div>
                        </div>

                        <!-- åˆ†é…ç»“æœ -->
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.85rem; flex: 1;">
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 4px;">å¹¿æœŸæ‰€è´¦æˆ·:
                                </div>
                                <div style="font-size: 1rem; font-weight: 600;" id="alloc-gfex-amount">Â¥1,100,000 <span
                                        style="font-size: 0.7rem; color: var(--text-muted);">(55%)</span></div>
                                <div style="color: var(--positive); font-size: 0.75rem;" id="alloc-gfex-resist">å¯æŠ—æ¶¨å¹…
                                    +52%</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 4px;">CMEè´¦æˆ·:
                                </div>
                                <div style="font-size: 1rem; font-weight: 600;" id="alloc-cme-amount">$127,841 <span
                                        style="font-size: 0.7rem; color: var(--text-muted);">(45%)</span></div>
                                <div style="color: var(--negative); font-size: 0.75rem;" id="alloc-cme-resist">å¯æŠ—è·Œå¹… -53%
                                </div>
                            </div>
                        </div>

                        <!-- æ­¢æŸå»ºè®® -->
                        <div
                            style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--negative);">
                            <div style="font-size: 0.75rem; color: var(--negative); margin-bottom: 4px;">ğŸ”´ å»ºè®®æ­¢æŸä»·
                                (ä¿ç•™20%å®‰å…¨è¾¹é™…)</div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                <div>å¹¿æœŸæ‰€: <span style="font-weight: 600;" id="stop-gfex">Â¥998.63</span> <span
                                        style="font-size: 0.7rem; color: var(--text-muted);"
                                        id="stop-gfex-pct">(+41.6%)</span>
                                </div>
                                <div>CME: <span style="font-weight: 600;" id="stop-cme">$1390.57</span> <span
                                        style="font-size: 0.7rem; color: var(--text-muted);"
                                        id="stop-cme-pct">(-42.4%)</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²ä»·å·®èµ°åŠ¿å›¾ (Moved back to bottom) -->
        <div class="spread-chart-section"
            style="margin: 0 0 20px 0; background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸ“ˆ å†å²ä»·å·®èµ°åŠ¿
                    <span id="chart-subtitle"
                        style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal;">å›½å†…
                        vs å›½é™…</span>
                </h3>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <!-- å“ç§åˆ‡æ¢æ ‡ç­¾ -->
                    <div id="commodity-tabs"
                        style="display: flex; gap: 4px; background: var(--bg-secondary); padding: 3px; border-radius: 8px; align-items: center;">
                        <button onclick="switchCommodity('platinum')" id="tab-platinum" class="commodity-tab active"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: var(--accent-gold); color: #000;">é“‚é‡‘
                            <span id="pt-pair-label" style="font-size:0.6rem;opacity:0.7">2610-2610</span></button>
                        <!-- é“‚é‡‘é…å¯¹é€‰æ‹© -->
                        <select id="platinum-pair-select" onchange="switchPlatinumPair(this.value)"
                            style="padding: 4px 6px; border: 1px solid var(--accent-gold); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); font-size: 0.7rem; cursor: pointer;">
                            <option value="2610-2610">2610-2610</option>
                            <option value="2610-2607">2610-2607</option>
                            <option value="2610-2601">2610-2601</option>
                            <option value="2606-2610">2606-2610</option>
                            <option value="2606-2607">2606-2607</option>
                            <option value="2606-2601">2606-2601</option>
                        </select>
                        <button onclick="switchCommodity('palladium')" id="tab-palladium" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">é’¯é‡‘
                            <span id="pd-pair-label" style="font-size:0.6rem;opacity:0.7">2606-2606</span></button>
                        <!-- é’¯é‡‘é…å¯¹é€‰æ‹© -->
                        <select id="palladium-pair-select" onchange="switchPalladiumPair(this.value)"
                            style="padding: 4px 6px; border: 1px solid var(--accent-gold); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); font-size: 0.7rem; cursor: pointer; display: none;">
                            <option value="2606-2606">2606-2606</option>
                            <option value="2606-2603">2606-2603</option>
                            <option value="2606-2609">2606-2609</option>
                            <option value="2606-2612">2606-2612</option>
                            <option value="2608-2606">2608-2606</option>
                            <option value="2608-2603">2608-2603</option>
                            <option value="2608-2609">2608-2609</option>
                            <option value="2608-2612">2608-2612</option>
                            <option value="2610-2606">2610-2606</option>
                            <option value="2610-2603">2610-2603</option>
                            <option value="2610-2609">2610-2609</option>
                            <option value="2610-2612">2610-2612</option>
                            <option value="2612-2606">2612-2606</option>
                            <option value="2612-2603">2612-2603</option>
                            <option value="2612-2609">2612-2609</option>
                            <option value="2612-2612">2612-2612</option>
                        </select>
                        <button onclick="switchCommodity('gold')" id="tab-gold" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">é»„é‡‘
                            <span id="au-pair-label" style="font-size:0.6rem;opacity:0.7">2412</span></button>
                        <!-- é»„é‡‘åˆçº¦é€‰æ‹© -->
                        <select id="gold-pair-select" onchange="switchGoldPair(this.value)"
                            style="padding: 4px 6px; border: 1px solid var(--accent-gold); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); font-size: 0.7rem; cursor: pointer; display: none;">
                            <option value="AU2412">AU2412</option>
                            <option value="AU2406">AU2406</option>
                            <option value="AU2312">AU2312</option>
                            <option value="AU2306">AU2306</option>
                        </select>
                        <button onclick="switchCommodity('silver')" id="tab-silver" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">ç™½é“¶
                            <span id="ag-pair-label" style="font-size:0.6rem;opacity:0.7">2412</span></button>
                        <!-- ç™½é“¶åˆçº¦é€‰æ‹© -->
                        <select id="silver-pair-select" onchange="switchSilverPair(this.value)"
                            style="padding: 4px 6px; border: 1px solid var(--accent-gold); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); font-size: 0.7rem; cursor: pointer; display: none;">
                            <option value="AG2412">AG2412</option>
                            <option value="AG2406">AG2406</option>
                        </select>
                        <button onclick="switchCommodity('copper')" id="tab-copper" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">é“œ
                            <span style="font-size:0.6rem;opacity:0.7">ä¸»åŠ›</span></button>
                    </div>
                    <!-- ä»·å·®ç±»å‹åˆ‡æ¢ -->
                    <div
                        style="display: flex; gap: 4px; background: var(--bg-secondary); padding: 3px; border-radius: 8px; margin-right: 8px;">
                        <button onclick="switchSpreadType('pct')" id="spread-type-pct"
                            style="padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.7rem; background: var(--accent-gold); color: #000;">æ¯”ä¾‹(%)</button>
                        <button onclick="switchSpreadType('abs')" id="spread-type-abs"
                            style="padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.7rem; background: transparent; color: var(--text-muted);">ä»·å·®(å…ƒ)</button>
                    </div>
                    <button onclick="loadSpreadChart()"
                        style="padding: 6px 12px; background: var(--accent-gold); border: none; border-radius: 6px; color: #000; cursor: pointer; font-size: 0.8rem;">
                        åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
            <div id="spread-chart" style="width: 100%; height: 320px;"></div>
            <div id="spread-stats"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">å½“å‰æº¢ä»·</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--positive);" id="spread-current">+5.90%
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">å‡å€¼</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-gold);" id="spread-avg">+5.10%
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">æœ€é«˜</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--warning);" id="spread-max">+19.66%
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">æœ€ä½</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--info);" id="spread-min">-3.23%</div>
                </div>
            </div>
            <div id="risk-warning-banner"
                style="margin-top: 12px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--negative); display: none;">
                <div id="risk-warning-text" style="font-size: 0.85rem; color: var(--text-secondary);">
                    <!-- åŠ¨æ€åŠ è½½å†…å®¹ -->
                </div>
            </div>
        </div>

        <!-- Trading Rules -->
        <div class="rules-section">
            <div class="rules-header" onclick="toggleRules()">
                <h2>ğŸ“‹ å¹¿æœŸæ‰€äº¤æ˜“è§„åˆ™ (2025å¹´12æœˆæœ€æ–°)</h2>
                <span class="rules-toggle" id="rules-toggle">â–¼</span>
            </div>
            <div class="rules-content" id="rules-content">
                <!-- åˆçº¦è§„æ ¼ -->
                <div class="rule-card">
                    <h4>ğŸ“œ åˆçº¦è§„æ ¼</h4>
                    <table>
                        <tr>
                            <td>äº¤æ˜“å•ä½</td>
                            <td>1000å…‹/æ‰‹</td>
                        </tr>
                        <tr>
                            <td>æœ€å°å˜åŠ¨ä»·ä½</td>
                            <td>0.05å…ƒ/å…‹</td>
                        </tr>
                        <tr>
                            <td>åˆçº¦æœˆä»½</td>
                            <td>2/4/6/8/10/12æœˆ</td>
                        </tr>
                        <tr>
                            <td>æœ€åäº¤æ˜“æ—¥</td>
                            <td>åˆçº¦æœˆä»½ç¬¬10ä¸ªäº¤æ˜“æ—¥</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æ–¹å¼</td>
                            <td>å®ç‰©äº¤å‰²</td>
                        </tr>
                    </table>
                </div>

                <!-- äº¤æ˜“æ—¶é—´ -->
                <div class="rule-card">
                    <h4>â° äº¤æ˜“æ—¶é—´</h4>
                    <table>
                        <tr>
                            <td>ç¬¬ä¸€èŠ‚</td>
                            <td>09:00 - 10:15</td>
                        </tr>
                        <tr>
                            <td>ç¬¬äºŒèŠ‚</td>
                            <td>10:30 - 11:30</td>
                        </tr>
                        <tr>
                            <td>ç¬¬ä¸‰èŠ‚</td>
                            <td>13:30 - 15:00</td>
                        </tr>
                        <tr>
                            <td>å¤œç›˜</td>
                            <td>å¾…å…¬å¸ƒ</td>
                        </tr>
                    </table>
                </div>

                <!-- ä¿è¯é‡‘ä¸è´¹ç”¨ -->
                <div class="rule-card">
                    <h4>ğŸ’° ä¿è¯é‡‘ä¸æ‰‹ç»­è´¹ (12/25èµ·)</h4>
                    <table>
                        <tr>
                            <td>äº¤æ˜“ä¿è¯é‡‘</td>
                            <td>12%</td>
                        </tr>
                        <tr>
                            <td>æ¶¨è·Œåœæ¿</td>
                            <td>Â±10%</td>
                        </tr>
                        <tr>
                            <td>äº¤æ˜“æ‰‹ç»­è´¹</td>
                            <td>ä¸‡åˆ†ä¹‹2.5</td>
                        </tr>
                        <tr>
                            <td>å¹³ä»Šä»“æ‰‹ç»­è´¹</td>
                            <td>ä¸‡åˆ†ä¹‹2.5</td>
                        </tr>
                    </table>
                </div>

                <!-- æŒä»“é™é¢ -->
                <div class="rule-card">
                    <h4>ğŸ“Š æŒä»“é™é¢</h4>
                    <table>
                        <tr>
                            <td>å•æ—¥å¼€ä»“é™é¢</td>
                            <td>500æ‰‹/åˆçº¦</td>
                        </tr>
                        <tr>
                            <td>ä¸€èˆ¬æœˆä»½(PT)</td>
                            <td>600æ‰‹</td>
                        </tr>
                        <tr>
                            <td>ä¸€èˆ¬æœˆä»½(PD)</td>
                            <td>300æ‰‹</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æœˆ(PT)</td>
                            <td>60æ‰‹</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æœˆ(PD)</td>
                            <td>30æ‰‹</td>
                        </tr>
                    </table>
                </div>

                <!-- Bybit CFDå¯¹æ¯” -->
                <div class="rule-card">
                    <h4>ğŸŒ Bybit CFD å¯¹æ¯”</h4>
                    <table>
                        <tr>
                            <td>äº¤æ˜“å“ç§</td>
                            <td>XPT/USD, XPD/USD</td>
                        </tr>
                        <tr>
                            <td>æœ€å°äº¤æ˜“é‡</td>
                            <td>0.01æ‰‹ (1ç›å¸)</td>
                        </tr>
                        <tr>
                            <td>æ æ†</td>
                            <td>æœ€é«˜200x</td>
                        </tr>
                        <tr>
                            <td>ç‚¹å·®</td>
                            <td>æµ®åŠ¨ ~$5-10</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æ–¹å¼</td>
                            <td>ç°é‡‘ç»“ç®—</td>
                        </tr>
                    </table>
                </div>

                <!-- å¥—åˆ©æˆæœ¬ -->
                <div class="rule-card">
                    <h4>ğŸ’¸ å¥—åˆ©æˆæœ¬ä¼°ç®—</h4>
                    <table>
                        <tr>
                            <td>å¹¿æœŸæ‰€æ‰‹ç»­è´¹</td>
                            <td>~0.025%</td>
                        </tr>
                        <tr>
                            <td>Bybitç‚¹å·®</td>
                            <td>~0.05%</td>
                        </tr>
                        <tr>
                            <td>æ»‘ç‚¹ä¼°è®¡</td>
                            <td>~0.05%</td>
                        </tr>
                        <tr>
                            <td>æ±‡ç‡æ³¢åŠ¨é£é™©</td>
                            <td>ä¸ç¡®å®š</td>
                        </tr>
                        <tr style="color: var(--accent-gold); font-weight: 600;">
                            <td>æ€»æˆæœ¬</td>
                            <td>~0.15%</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Risk Warning -->


        <!-- Last Update -->
        <div class="last-update">
            ä¸Šæ¬¡æ›´æ–°: <span id="last-update">--</span> |
            æ•°æ®æ¥æº: æ–°æµªæœŸè´§ (å¹¿æœŸæ‰€å»¶è¿Ÿ15-20åˆ†é’Ÿ) + å›½é™…å¸‚åœºå…¬å¼€æ•°æ®
        </div>
    </div>

    <script>
        // å¸¸é‡
        const OZ_TO_GRAM = 31.1035;

        // æ•°æ®çŠ¶æ€
        let marketData = {
            gfex: {
                PT2606: null,
                PD2606: null
            },
            intl: {
                XPT: null,  // ä»JSONåŠ¨æ€è·å–
                XPD: null   // ä»JSONåŠ¨æ€è·å–
            },
            exchangeRate: 7.04,
            lastUpdate: null
        };

        // è·å–å¹¿æœŸæ‰€æ•°æ® (é€šè¿‡æ–°æµª)
        async function fetchGFEXPrice() {
            const symbols = ['PT2606', 'PD2606'];
            const results = {};

            for (const symbol of symbols) {
                try {
                    // ä½¿ç”¨ CORS ä»£ç†æˆ–ç›´æ¥è¯·æ±‚
                    // æ³¨æ„: æµè§ˆå™¨ç›´æ¥è¯·æ±‚å¯èƒ½æœ‰CORSé—®é¢˜ï¼Œéœ€è¦åç«¯ä»£ç†
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://hq.sinajs.cn/list=nf_${symbol}`)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();

                    if (data.contents) {
                        const match = data.contents.match(/"([^"]+)"/);
                        if (match && match[1]) {
                            const parts = match[1].split(',');
                            if (parts.length > 3 && parts[3]) {
                                results[symbol] = parseFloat(parts[3]);
                            }
                        }
                    }
                } catch (error) {
                    console.error(`è·å–${symbol}å¤±è´¥:`, error);
                }
            }

            return results;
        }

        // è·å–æ±‡ç‡
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                return data.rates.CNY || 7.04;
            } catch (error) {
                console.error('è·å–æ±‡ç‡å¤±è´¥:', error);
                return 7.04;
            }
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleString('zh-CN');
            document.getElementById('data-time').textContent = now.toLocaleString('zh-CN');
            document.getElementById('exchange-rate').textContent = `USD/CNY = ${marketData.exchangeRate.toFixed(4)}`;

            // å›½é™…ä»·æ ¼ (ä»JSONåŠ¨æ€è·å–)
            const intlPrices = {
                XPT: marketData.intl.XPT || 2500,  // é“‚é‡‘ USD/oz
                XPD: marketData.intl.XPD || 950    // é’¯é‡‘ USD/oz
            };

            // æ›´æ–°é“‚é‡‘
            if (marketData.gfex.PT2606) {
                const ptGfex = marketData.gfex.PT2606;
                const ptIntlUsd = intlPrices.XPT;
                const ptIntlCny = ptIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
                const ptSpread = ptGfex - ptIntlCny;
                const ptSpreadPct = (ptSpread / ptIntlCny) * 100;

                document.getElementById('pt-gfex').textContent = ptGfex.toFixed(2);
                document.getElementById('pt-intl').textContent = ptIntlCny.toFixed(2);
                document.getElementById('pt-intl-usd').textContent = ptIntlUsd.toFixed(2);
                document.getElementById('pt-spread').textContent = (ptSpread >= 0 ? '+' : '') + ptSpread.toFixed(2);
                document.getElementById('pt-spread-pct').textContent = (ptSpreadPct >= 0 ? '+' : '') + ptSpreadPct.toFixed(2) + '%';

                // æ›´æ–°æ ·å¼
                const ptSpreadEl = document.getElementById('pt-spread');
                const ptSpreadPctEl = document.getElementById('pt-spread-pct');
                const ptDirectionEl = document.getElementById('pt-direction');

                if (ptSpread >= 0) {
                    ptSpreadEl.className = 'spread-value positive';
                    ptSpreadPctEl.className = 'spread-pct positive';
                    ptDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
                } else {
                    ptSpreadEl.className = 'spread-value negative';
                    ptSpreadPctEl.className = 'spread-pct negative';
                    ptDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
                }
            }

            // æ›´æ–°é’¯é‡‘
            if (marketData.gfex.PD2606) {
                const pdGfex = marketData.gfex.PD2606;
                const pdIntlUsd = intlPrices.XPD;
                const pdIntlCny = pdIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
                const pdSpread = pdGfex - pdIntlCny;
                const pdSpreadPct = (pdSpread / pdIntlCny) * 100;

                document.getElementById('pd-gfex').textContent = pdGfex.toFixed(2);
                document.getElementById('pd-intl').textContent = pdIntlCny.toFixed(2);
                document.getElementById('pd-intl-usd').textContent = pdIntlUsd.toFixed(2);
                document.getElementById('pd-spread').textContent = (pdSpread >= 0 ? '+' : '') + pdSpread.toFixed(2);
                document.getElementById('pd-spread-pct').textContent = (pdSpreadPct >= 0 ? '+' : '') + pdSpreadPct.toFixed(2) + '%';

                // æ›´æ–°æ ·å¼
                const pdSpreadEl = document.getElementById('pd-spread');
                const pdSpreadPctEl = document.getElementById('pd-spread-pct');
                const pdDirectionEl = document.getElementById('pd-direction');

                if (pdSpread >= 0) {
                    pdSpreadEl.className = 'spread-value positive';
                    pdSpreadPctEl.className = 'spread-pct positive';
                    pdDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
                } else {
                    pdSpreadEl.className = 'spread-value negative';
                    pdSpreadPctEl.className = 'spread-pct negative';
                    pdDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
                }
            }

            // æ›´æ–°å‘Šè­¦
            updateAlert();
        }

        // æ›´æ–°å‘Šè­¦
        function updateAlert() {
            const alertBanner = document.getElementById('alert-banner');
            const ptGfex = marketData.gfex.PT2606 || 0;
            const pdGfex = marketData.gfex.PD2606 || 0;

            // ç®€å•åˆ¤æ–­æº¢ä»·æƒ…å†µ
            const ptIntlCny = (marketData.intl.XPT || 2500) * marketData.exchangeRate / OZ_TO_GRAM;
            const pdIntlCny = (marketData.intl.XPD || 950) * marketData.exchangeRate / OZ_TO_GRAM;

            const ptPremium = ((ptGfex - ptIntlCny) / ptIntlCny) * 100;
            const pdPremium = ((pdGfex - pdIntlCny) / pdIntlCny) * 100;

            if (ptPremium > 20 || pdPremium > 20) {
                alertBanner.className = 'alert-banner';
                alertBanner.innerHTML = `
                    <div class="alert-icon">ğŸ”´</div>
                    <div class="alert-content">
                        <h4>å¹¿æœŸæ‰€æº¢ä»·è¾ƒå¤§</h4>
                        <p>å½“å‰é“‚é‡‘å’Œé’¯é‡‘åœ¨å¹¿æœŸæ‰€çš„ä»·æ ¼æ˜¾è‘—é«˜äºå›½é™…å¸‚åœºï¼Œæº¢ä»·è¶…è¿‡20%ã€‚ç†è®ºå¥—åˆ©æ–¹å‘ï¼šåšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…å¸‚åœºã€‚</p>
                    </div>
                `;
            } else if (ptPremium < -5 || pdPremium < -5) {
                alertBanner.className = 'alert-banner opportunity';
                alertBanner.innerHTML = `
                    <div class="alert-icon">ğŸŸ¢</div>
                    <div class="alert-content">
                        <h4>å‘ç°å¥—åˆ©æœºä¼š!</h4>
                        <p>å¹¿æœŸæ‰€ä»·æ ¼ä½äºå›½é™…å¸‚åœºæ¢ç®—ä»·æ ¼ï¼Œå­˜åœ¨æ½œåœ¨å¥—åˆ©ç©ºé—´ã€‚ç†è®ºæ–¹å‘ï¼šåšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…å¸‚åœºã€‚</p>
                    </div>
                `;
            } else {
                alertBanner.innerHTML = `
                    <div class="alert-icon">ğŸ“Š</div>
                    <div class="alert-content">
                        <h4>ä»·å·®åœ¨åˆç†èŒƒå›´</h4>
                        <p>å½“å‰ä¸¤ä¸ªå¸‚åœºä»·æ ¼å·®å¼‚è¾ƒå°ï¼Œæš‚æ— æ˜æ˜¾å¥—åˆ©æœºä¼šã€‚å»ºè®®æŒç»­è§‚å¯Ÿã€‚</p>
                    </div>
                `;
            }
        }

        // åˆ·æ–°æ•°æ®
        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.textContent = 'â³ æ­£åœ¨é‡‡é›†æœ€æ–°æ•°æ®...';
                btn.disabled = true;
            }

            try {
                // 1. è°ƒç”¨APIè§¦å‘åå°æ•°æ®æ›´æ–°
                const updateRes = await fetch('/api/refresh-data', { method: 'POST' });
                if (!updateRes.ok) throw new Error('æ•°æ®æ›´æ–°è¯·æ±‚å¤±è´¥');

                // 2. ä¹Ÿæ˜¯é‡è½½é¡µé¢
                if (btn) btn.textContent = 'âœ… æ•°æ®å·²æ›´æ–°';
                setTimeout(() => window.location.reload(true), 500);

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                alert('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message);
                if (btn) {
                    btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                    btn.disabled = false;
                }
            }
        }

        // åˆ‡æ¢è§„åˆ™æ˜¾ç¤º
        function toggleRules() {
            const content = document.getElementById('rules-content');
            const toggle = document.getElementById('rules-toggle');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }

        // æ£€æŸ¥å¸‚åœºçŠ¶æ€
        function checkMarketStatus() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const day = now.getDay();

            const statusEl = document.getElementById('market-status');
            const dotEl = document.querySelector('.status-dot');

            // å‘¨æœ«
            if (day === 0 || day === 6) {
                statusEl.textContent = 'å¸‚åœºä¼‘å¸‚';
                dotEl.style.background = 'var(--text-muted)';
                return;
            }

            // äº¤æ˜“æ—¶æ®µåˆ¤æ–­
            const isSession1 = (hour === 9 && minute >= 0) || (hour === 10 && minute < 15);
            const isSession2 = (hour === 10 && minute >= 30) || (hour === 11 && minute < 30);
            const isSession3 = (hour === 13 && minute >= 30) || (hour === 14) || (hour === 15 && minute === 0);

            if (isSession1 || isSession2 || isSession3) {
                statusEl.textContent = 'å¸‚åœºå¼€æ”¾';
                dotEl.style.background = 'var(--positive)';
            } else {
                statusEl.textContent = 'ç›˜å';
                dotEl.style.background = 'var(--warning)';
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            // è®¾ç½®åˆå§‹æ•°æ® (åŸºäºä¹‹å‰Pythonè„šæœ¬è·å–çš„æ•°æ®)
            marketData.gfex.PT2606 = 657.65;
            marketData.gfex.PD2606 = 578.25;
            marketData.exchangeRate = 7.04;

            // ä»JSONæ–‡ä»¶åŠ è½½æ•°æ®æ—¶é—´æˆ³
            try {
                // åŠ è½½é“‚é‡‘æ•°æ®
                const ptResponse = await fetch('platinum_all_pairs.json?t=' + Date.now());
                if (ptResponse.ok) {
                    const ptData = await ptResponse.json();
                    // ä¼˜å…ˆé€‰æ‹©2610-2610é…å¯¹ï¼ˆPT2610 vs PLV2026ï¼‰ï¼Œå¦åˆ™ç”¨ç¬¬ä¸€ä¸ª
                    const targetPair = ptData.pairs['2610-2610'] || Object.values(ptData.pairs)[0];
                    if (targetPair && targetPair.history && targetPair.history.length > 0) {
                        const lastRecord = targetPair.history[targetPair.history.length - 1];
                        const ptGfexTimeEl = document.getElementById('pt-gfex-time');
                        const ptCmeTimeEl = document.getElementById('pt-cme-time');
                        if (ptGfexTimeEl) ptGfexTimeEl.textContent = lastRecord.date;
                        if (ptCmeTimeEl) ptCmeTimeEl.textContent = lastRecord.date;
                        // æ›´æ–°ä»·æ ¼
                        if (targetPair.current) {
                            marketData.gfex.PT2606 = targetPair.current.gfex_price;
                            marketData.intl.XPT = targetPair.current.cme_usd;  // åŠ¨æ€æ›´æ–°å›½é™…ä»·æ ¼
                            document.getElementById('pt-gfex').textContent = targetPair.current.gfex_price.toFixed(2);
                            document.getElementById('pt-intl-usd').textContent = targetPair.current.cme_usd.toFixed(2);
                            document.getElementById('pt-intl').textContent = targetPair.current.cme_cny.toFixed(2);
                        }
                    }
                }

                // åŠ è½½é’¯é‡‘æ•°æ®
                const pdResponse = await fetch('palladium_all_pairs.json?t=' + Date.now());
                if (pdResponse.ok) {
                    const pdData = await pdResponse.json();
                    // ä¼˜å…ˆé€‰æ‹©2606-2606é…å¯¹ï¼ˆPD2606 vs PAM2026ï¼‰ï¼Œå¦åˆ™ç”¨ç¬¬ä¸€ä¸ª
                    const targetPdPair = pdData.pairs['2606-2606'] || Object.values(pdData.pairs)[0];
                    if (targetPdPair && targetPdPair.history && targetPdPair.history.length > 0) {
                        const lastRecord = targetPdPair.history[targetPdPair.history.length - 1];
                        const pdGfexTimeEl = document.getElementById('pd-gfex-time');
                        const pdCmeTimeEl = document.getElementById('pd-cme-time');
                        if (pdGfexTimeEl) pdGfexTimeEl.textContent = lastRecord.date;
                        if (pdCmeTimeEl) pdCmeTimeEl.textContent = lastRecord.date;
                        // æ›´æ–°ä»·æ ¼
                        if (targetPdPair.current) {
                            marketData.gfex.PD2606 = targetPdPair.current.gfex_price;
                            marketData.intl.XPD = targetPdPair.current.cme_usd;  // åŠ¨æ€æ›´æ–°å›½é™…ä»·æ ¼
                            document.getElementById('pd-gfex').textContent = targetPdPair.current.gfex_price.toFixed(2);
                            document.getElementById('pd-intl-usd').textContent = targetPdPair.current.cme_usd.toFixed(2);
                            document.getElementById('pd-intl').textContent = targetPdPair.current.cme_cny.toFixed(2);
                        }
                    }
                }
            } catch (e) {
                console.log('åŠ è½½æ—¶é—´æˆ³æ•°æ®å¤±è´¥:', e);
            }

            updateDisplay();
            checkMarketStatus();

            // æ¯åˆ†é’Ÿæ£€æŸ¥å¸‚åœºçŠ¶æ€
            setInterval(checkMarketStatus, 60000);
        }


        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // ========== æ‰‹åŠ¨æ›´æ–°ä»·æ ¼åŠŸèƒ½ ==========
        function updateCMEPrice() {
            // è¯»å–ç”¨æˆ·è¾“å…¥çš„å€¼
            const cmePt = parseFloat(document.getElementById('cme-pl-price').value) || 0;
            const cmePd = parseFloat(document.getElementById('cme-pa-price').value) || 0;
            const spotPt = parseFloat(document.getElementById('spot-pl-price').value) || 0;
            const spotPd = parseFloat(document.getElementById('spot-pa-price').value) || 0;
            const gfexPt = parseFloat(document.getElementById('gfex-pl-price').value) || 0;
            const gfexPd = parseFloat(document.getElementById('gfex-pa-price').value) || 0;

            // æ›´æ–°å¹¿æœŸæ‰€æ•°æ®
            if (gfexPt > 0) marketData.gfex.PT2606 = gfexPt;
            if (gfexPd > 0) marketData.gfex.PD2606 = gfexPd;

            // æ›´æ–°æ—¶é—´
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN');
            document.getElementById('last-update').textContent = timeStr;
            document.getElementById('data-time').textContent = timeStr;

            // æ›´æ–°å¡ç‰‡ä¸Šçš„æ—¶é—´æ˜¾ç¤º (æ‰‹åŠ¨æ›´æ–°æ—¶æ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´)
            const dateStr = now.getFullYear() + '.' + String(now.getMonth() + 1).padStart(2, '0') + '.' + String(now.getDate()).padStart(2, '0');
            const timeOnlyStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const fullTimeStr = dateStr + ' ' + timeOnlyStr + ' æ‰‹åŠ¨';
            const ptGfexTimeEl = document.getElementById('pt-gfex-time');
            const pdGfexTimeEl = document.getElementById('pd-gfex-time');
            const ptCmeTimeEl = document.getElementById('pt-cme-time');
            const pdCmeTimeEl = document.getElementById('pd-cme-time');
            if (ptGfexTimeEl) ptGfexTimeEl.textContent = fullTimeStr;
            if (pdGfexTimeEl) pdGfexTimeEl.textContent = fullTimeStr;
            if (ptCmeTimeEl) ptCmeTimeEl.textContent = fullTimeStr;
            if (pdCmeTimeEl) pdCmeTimeEl.textContent = fullTimeStr;

            // è®¡ç®—é“‚é‡‘
            const ptGfex = marketData.gfex.PT2606;
            const ptIntlUsd = cmePt;
            const ptIntlCny = ptIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
            const ptSpread = ptGfex - ptIntlCny;
            const ptSpreadPct = ptIntlCny > 0 ? (ptSpread / ptIntlCny) * 100 : 0;

            document.getElementById('pt-gfex').textContent = ptGfex.toFixed(2);
            document.getElementById('pt-intl').textContent = ptIntlCny.toFixed(2);
            document.getElementById('pt-intl-usd').textContent = ptIntlUsd.toFixed(2);
            document.getElementById('pt-spot-usd-display').textContent = spotPt.toFixed(2);
            document.getElementById('pt-spread').textContent = (ptSpread >= 0 ? '+' : '') + ptSpread.toFixed(2);
            document.getElementById('pt-spread-pct').textContent = (ptSpreadPct >= 0 ? '+' : '') + ptSpreadPct.toFixed(2) + '%';

            // æ›´æ–°é“‚é‡‘æ ·å¼
            const ptSpreadEl = document.getElementById('pt-spread');
            const ptSpreadPctEl = document.getElementById('pt-spread-pct');
            const ptDirectionEl = document.getElementById('pt-direction');
            if (ptSpread >= 0) {
                ptSpreadEl.className = 'spread-value positive';
                ptSpreadPctEl.className = 'spread-pct positive';
                ptDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
            } else {
                ptSpreadEl.className = 'spread-value negative';
                ptSpreadPctEl.className = 'spread-pct negative';
                ptDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
            }

            // è®¡ç®—é’¯é‡‘
            const pdGfex = marketData.gfex.PD2606;
            const pdIntlUsd = cmePd;
            const pdIntlCny = pdIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
            const pdSpread = pdGfex - pdIntlCny;
            const pdSpreadPct = pdIntlCny > 0 ? (pdSpread / pdIntlCny) * 100 : 0;

            document.getElementById('pd-gfex').textContent = pdGfex.toFixed(2);
            document.getElementById('pd-intl').textContent = pdIntlCny.toFixed(2);
            document.getElementById('pd-intl-usd').textContent = pdIntlUsd.toFixed(2);
            document.getElementById('pd-spot-usd-display').textContent = spotPd.toFixed(2);
            document.getElementById('pd-spread').textContent = (pdSpread >= 0 ? '+' : '') + pdSpread.toFixed(2);
            document.getElementById('pd-spread-pct').textContent = (pdSpreadPct >= 0 ? '+' : '') + pdSpreadPct.toFixed(2) + '%';

            // æ›´æ–°é’¯é‡‘æ ·å¼
            const pdSpreadEl = document.getElementById('pd-spread');
            const pdSpreadPctEl = document.getElementById('pd-spread-pct');
            const pdDirectionEl = document.getElementById('pd-direction');
            if (pdSpread >= 0) {
                pdSpreadEl.className = 'spread-value positive';
                pdSpreadPctEl.className = 'spread-pct positive';
                pdDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
            } else {
                pdSpreadEl.className = 'spread-value negative';
                pdSpreadPctEl.className = 'spread-pct negative';
                pdDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
            }

            console.log('ä»·æ ¼å·²æ›´æ–°:', { cmePt, cmePd, spotPt, spotPd, gfexPt, gfexPd });

            // æ›´æ–°å¥—åˆ©è®¡ç®—å™¨
            if (typeof calculateArbitrage === 'function') {
                calculateArbitrage();
            }

            // ä¿å­˜åˆ°æœåŠ¡å™¨
            savePricesToServer({
                cme: { pt: cmePt, pd: cmePd },
                bybit: { pt: spotPt, pd: spotPd },
                gfex: { pt: gfexPt, pd: gfexPd },
                exchange_rate: marketData.exchangeRate
            });
        }

        // ä¿å­˜ä»·æ ¼åˆ°æœåŠ¡å™¨
        async function savePricesToServer(data) {
            try {
                const resp = await fetch('/api/save-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (resp.ok) {
                    console.log('ä»·æ ¼å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                }
            } catch (e) {
                console.error('ä¿å­˜å¤±è´¥:', e);
            }
        }

        // ========== å¥—åˆ©è®¡ç®—å™¨åŠŸèƒ½ ==========

        // å½“å‰é€‰æ‹©çš„é‡‘å±ç±»å‹
        let selectedMetal = 'PD';
        let calcPairsData = null;       // é“‚é‡‘é…å¯¹æ•°æ®
        let selectedPairData = null;    // å½“å‰é€‰ä¸­çš„é“‚é‡‘é…å¯¹
        let calcPdPairsData = null;     // é’¯é‡‘é…å¯¹æ•°æ®
        let selectedPdPairData = null;  // å½“å‰é€‰ä¸­çš„é’¯é‡‘é…å¯¹

        // åˆå§‹åŒ–è®¡ç®—å™¨é…å¯¹æ•°æ®
        async function initCalculatorPairs() {
            // åŠ è½½é“‚é‡‘é…å¯¹
            try {
                const response = await fetch('platinum_all_pairs.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    calcPairsData = data.pairs;
                    console.log('é“‚é‡‘è®¡ç®—å™¨é…å¯¹æ•°æ®åŠ è½½æˆåŠŸ:', Object.keys(calcPairsData));
                }
            } catch (e) {
                console.error('åŠ è½½é“‚é‡‘è®¡ç®—å™¨é…å¯¹æ•°æ®å¤±è´¥:', e);
            }

            // åŠ è½½é’¯é‡‘é…å¯¹
            try {
                const response = await fetch('palladium_all_pairs.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    calcPdPairsData = data.pairs;
                    console.log('é’¯é‡‘è®¡ç®—å™¨é…å¯¹æ•°æ®åŠ è½½æˆåŠŸ:', Object.keys(calcPdPairsData));

                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé’¯é‡‘é…å¯¹
                    const firstPair = Object.keys(calcPdPairsData)[0];
                    if (firstPair) {
                        selectedPdPairData = calcPdPairsData[firstPair];
                    }

                    // å¦‚æœå½“å‰æ˜¯é’¯é‡‘ï¼Œåˆ·æ–°è®¡ç®—
                    if (selectedMetal === 'PD') {
                        calculateArbitrage();
                    }
                }
            } catch (e) {
                console.error('åŠ è½½é’¯é‡‘è®¡ç®—å™¨é…å¯¹æ•°æ®å¤±è´¥:', e);
            }
        }

        // é¡µé¢åŠ å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ç°æœ‰initå·²åœ¨ä¸Šé¢æ³¨å†Œï¼Œè¿™é‡Œé¢å¤–æ³¨å†Œä¸€ä¸ª
            initCalculatorPairs();
        });

        // åˆ‡æ¢é‡‘å±ç±»å‹
        function selectMetal(metal) {
            selectedMetal = metal;
            document.querySelectorAll('.calc-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${metal.toLowerCase()}`).classList.add('active');

            const pairSelect = document.getElementById('calc-pair-select');

            if (metal === 'PT' && calcPairsData) {
                // æ˜¾ç¤ºé…å¯¹é€‰æ‹©
                pairSelect.style.display = 'block';
                pairSelect.innerHTML = ''; // æ¸…ç©º

                // å¡«å……é€‰é¡¹
                Object.keys(calcPairsData).forEach(pair => {
                    const option = document.createElement('option');
                    option.value = pair;
                    option.textContent = pair; // æ˜¾ç¤ºå¦‚ 2610-2610
                    pairSelect.appendChild(option);
                });

                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæˆ–ä¹‹å‰çš„é€‰æ‹©
                if (pairSelect.options.length > 0) {
                    pairSelect.selectedIndex = 0;
                    onCalcPairChange(); // è§¦å‘æ›´æ–°
                }
            } else {
                // éšè—é…å¯¹é€‰æ‹©
                pairSelect.style.display = 'none';
                selectedPairData = null; // é‡ç½®
                calculateArbitrage();
            }
        }

        // é…å¯¹é€‰æ‹©å˜æ›´
        function onCalcPairChange() {
            const pairSelect = document.getElementById('calc-pair-select');
            const pairKey = pairSelect.value;

            if (calcPairsData && calcPairsData[pairKey]) {
                selectedPairData = calcPairsData[pairKey];
                console.log('åˆ‡æ¢è®¡ç®—å™¨é…å¯¹:', pairKey, selectedPairData.current);

                // è‡ªåŠ¨æ›´æ–°è¾“å…¥æ¡†ä¸­çš„ä»·æ ¼ (å¦‚æœç”¨æˆ·æƒ³è¦ä½¿ç”¨æœ€æ–°ä»·æ ¼)
                // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç›´æ¥å½±å“calculateArbitrageçš„è®¡ç®—æºï¼Œæˆ–è€…æ›´æ–°æ‰‹åŠ¨è¾“å…¥æ¡†çš„å€¼
                // ä¸ºäº†ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨è¯¥é…å¯¹çš„æœ€æ–°ä»·æ ¼è¿›è¡Œè®¡ç®—ï¼Œè€Œä¸éœ€ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥

                calculateArbitrage();
            }
        }

        // è®¡ç®—å¥—åˆ©æ–¹æ¡ˆ
        function calculateArbitrage() {
            // è·å–è¾“å…¥å€¼
            // è·å–äº¤æ˜“å‚æ•°
            const lots = parseInt(document.getElementById('calc-lots').value) || 1;
            const convergence = parseFloat(document.getElementById('calc-convergence').value) || 0.5;
            const period = parseInt(document.getElementById('calc-period').value) || 30;
            const hedgePlatform = document.getElementById('calc-hedge-platform').value;

            // å¸‚åœºæ•°æ®
            const OZ_TO_GRAM = 31.1035;
            const exchangeRate = marketData.exchangeRate || 7.04;

            // æ ¹æ®é€‰æ‹©çš„é‡‘å±è·å–ä»·æ ¼ - ä»å…¨å±€pricesDataè¯»å–
            let gfexPrice, intlPriceUsd, contractCode, hedgeCode, cmeContractSize;

            if (selectedMetal === 'PT') {
                // ä¼˜å…ˆä½¿ç”¨é€‰ä¸­çš„é…å¯¹æ•°æ®
                if (selectedPairData) {
                    gfexPrice = selectedPairData.current.gfex_price;
                    intlPriceUsd = selectedPairData.current.cme_usd;
                    // ä»é…å¯¹åç§°è§£æåˆçº¦ä»£ç  2610-2610 -> PT2610 vs PLV2026(éšå¼)
                    const pairParts = document.getElementById('calc-pair-select').value.split('-');
                    contractCode = `PT${pairParts[0]}`;

                    // CMEä»£ç è§£æéœ€è¦æ˜ å°„: 2601->PLF, 2607->PLN, 2610->PLV
                    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æ˜¾ç¤º PL æœˆå¹´
                    hedgeCode = hedgePlatform === 'cme' ? `PL ${pairParts[1]}` : 'XPT/USD';

                } else {
                    // é»˜è®¤å›é€€
                    gfexPrice = pricesData?.gfex?.pt_price || marketData.gfex.PT2606 || 657.65;
                    intlPriceUsd = pricesData?.cme?.pt_usd || 940;
                    contractCode = 'PT2610';
                    hedgeCode = hedgePlatform === 'cme' ? 'PL 2610' : 'XPT/USD';
                }
                cmeContractSize = 50;  // CMEé“‚é‡‘1æ‰‹ = 50ç›å¸
            } else {
                // é’¯é‡‘ï¼šä¼˜å…ˆä½¿ç”¨é€‰ä¸­çš„é…å¯¹æ•°æ®
                if (selectedPdPairData) {
                    gfexPrice = selectedPdPairData.current.gfex_price;
                    intlPriceUsd = selectedPdPairData.current.cme_usd;
                    const pairParts = document.getElementById('calc-pd-pair-select')?.value?.split('-') || ['2606', '2606'];
                    contractCode = `PD${pairParts[0]}`;
                    hedgeCode = hedgePlatform === 'cme' ? `PA ${pairParts[1]}` : 'XPD/USD';
                } else {
                    // é»˜è®¤å›é€€ - ä½¿ç”¨æ­£ç¡®çš„å¸‚åœºä»·æ ¼
                    gfexPrice = pricesData?.gfex?.pd_price || marketData.gfex.PD2606 || 515.65;
                    intlPriceUsd = pricesData?.cme?.pd_usd || 1922;  // ä¿®æ­£ä¸ºæ­£ç¡®çš„CMEé’¯é‡‘ä»·æ ¼
                    contractCode = 'PD2606';
                    hedgeCode = hedgePlatform === 'cme' ? 'PA 2606' : 'XPD/USD';
                }
                cmeContractSize = 100;  // CMEé’¯é‡‘1æ‰‹ = 100ç›å¸
            }

            // å›½é™…ä»·æ ¼æ¢ç®—ä¸ºäººæ°‘å¸/å…‹
            const intlPriceCny = (intlPriceUsd * exchangeRate) / OZ_TO_GRAM;

            // ä»·å·®è®¡ç®—
            const spread = gfexPrice - intlPriceCny;
            const spreadPct = (spread / intlPriceCny) * 100;

            // äº¤æ˜“è§„æ¨¡
            const gramsPerLot = 1000;  // å¹¿æœŸæ‰€1æ‰‹ = 1000å…‹
            const totalGrams = lots * gramsPerLot;
            const ozEquivalent = totalGrams / OZ_TO_GRAM;  // ç­‰å€¼ç›å¸æ•°

            // === ä¿è¯é‡‘è®¡ç®— ===
            // å¹¿æœŸæ‰€ä¿è¯é‡‘ = åˆçº¦ä»·å€¼ Ã— 12%
            const gfexContractValue = gfexPrice * totalGrams;
            const gfexMargin = gfexContractValue * 0.12;

            // å¯¹å†²å¹³å°ä¿è¯é‡‘è®¡ç®—
            let hedgeContractValue, hedgeMargin, hedgeLots, hedgeOz, hedgeGrams, hedgeDetail, positionMismatch;
            let canHedge = true;  // æ˜¯å¦å¯ä»¥å¯¹å†²
            let hedgeWarning = '';

            if (hedgePlatform === 'cme') {
                // CMEäº¤å‰²åˆçº¦ - å¿…é¡»æ•´æ‰‹äº¤æ˜“
                // CMEé“‚é‡‘1æ‰‹=50oz=1555å…‹ï¼Œé’¯é‡‘1æ‰‹=100oz=3110å…‹
                const cmeGramsPerLot = cmeContractSize * OZ_TO_GRAM;
                const minGfexLotsForCme = Math.round(cmeGramsPerLot / gramsPerLot);  // é’¯é‡‘=3æ‰‹ï¼Œé“‚é‡‘=2æ‰‹

                // æ£€æŸ¥å¹¿æœŸæ‰€ä»“ä½æ˜¯å¦è¶³å¤Ÿæ¥è¿‘åŒ¹é…CMEæœ€å°1æ‰‹
                // 3000å…‹ vs 3110å…‹ = 96.5% åŒ¹é…åº¦ï¼Œå¯ä»¥æ¥å—
                if (totalGrams < cmeGramsPerLot * 0.5) {
                    // ä»“ä½å¤ªå°ï¼ˆä¸è¶³50%ï¼‰ï¼Œæ— æ³•æœ‰æ•ˆå¯¹å†²
                    canHedge = false;
                    hedgeLots = 0;
                    hedgeOz = 0;
                    hedgeGrams = 0;
                    hedgeContractValue = 0;
                    hedgeMargin = 0;
                    positionMismatch = -totalGrams;
                    hedgeDetail = `âš ï¸ ä»“ä½ä¸è¶³ï¼`;
                    hedgeWarning = `å»ºè®®å¹¿æœŸæ‰€åš${minGfexLotsForCme}æ‰‹ â‰ˆ CME 1æ‰‹`;
                } else {
                    // è®¡ç®—æœ€æ¥è¿‘çš„CMEæ‰‹æ•°
                    hedgeLots = Math.round(totalGrams / cmeGramsPerLot);
                    if (hedgeLots < 1) hedgeLots = 1;
                    hedgeOz = hedgeLots * cmeContractSize;
                    hedgeGrams = hedgeOz * OZ_TO_GRAM;
                    hedgeContractValue = intlPriceUsd * hedgeOz;

                    // ä»“ä½æ•å£è®¡ç®—
                    positionMismatch = hedgeGrams - totalGrams;
                    const mismatchPct = ((positionMismatch / totalGrams) * 100).toFixed(1);

                    // CMEä¿è¯é‡‘ï¼šé“‚é‡‘çº¦$5000/æ‰‹ï¼Œé’¯é‡‘çº¦$15000/æ‰‹
                    const cmeMarginPerLot = selectedMetal === 'PT' ? 5000 : 15000;
                    hedgeMargin = cmeMarginPerLot * hedgeLots;

                    if (Math.abs(positionMismatch) > 200) {
                        hedgeDetail = `= ${hedgeGrams.toFixed(0)}å…‹ (æ•å£${mismatchPct > 0 ? '+' : ''}${mismatchPct}%)`;
                    } else {
                        hedgeDetail = `= ${hedgeGrams.toFixed(0)}å…‹ âœ“`;
                    }
                }
            } else {
                // Bybitæ°¸ç»­CFD - å¯ä»¥ç²¾ç¡®åŒ¹é…ä»»æ„æ•°é‡
                hedgeLots = 1;
                hedgeOz = ozEquivalent;
                hedgeGrams = totalGrams;  // ç²¾ç¡®åŒ¹é…
                hedgeContractValue = intlPriceUsd * hedgeOz;
                hedgeMargin = hedgeContractValue * 0.10;  // 10å€æ æ†
                positionMismatch = 0;
                hedgeDetail = `= ${hedgeGrams.toFixed(0)}å…‹ âœ“`;
            }

            // æ€»ä¿è¯é‡‘éœ€æ±‚ï¼ˆç»Ÿä¸€æ¢ç®—æˆäººæ°‘å¸ï¼‰
            const hedgeMarginCny = hedgeMargin * exchangeRate;
            const hedgeContractValueCny = hedgeContractValue * exchangeRate;
            const totalMarginCny = gfexMargin + hedgeMarginCny;

            // === æ”¶ç›Šè®¡ç®— ===
            // æ”¶ç›ŠåŸºäºèƒ½åŒ¹é…çš„æœ€å°ä»“ä½
            const effectiveGrams = Math.min(totalGrams, hedgeGrams);
            // é¢„æœŸæ”¶æ•›æ”¶ç›Š = ä»·å·® Ã— æ”¶æ•›æ¯”ä¾‹ Ã— æœ‰æ•ˆå…‹æ•°
            const grossProfit = spread * convergence * effectiveGrams;

            // === äº¤æ˜“æˆæœ¬æ˜ç»† ===
            // 1. å¹¿æœŸæ‰€æ‰‹ç»­è´¹: ä¸‡åˆ†ä¹‹2.5å¼€ä»“ + ä¸‡åˆ†ä¹‹2.5å¹³ä»“ = ä¸‡åˆ†ä¹‹5
            const gfexFee = gfexContractValue * 0.0005;

            // 2. CMEæ‰‹ç»­è´¹: çº¦$2.5/æ‰‹/è¾¹ = $5/æ‰‹å¾€è¿”; Bybitçº¦0.055%/è¾¹
            const hedgeFee = hedgePlatform === 'cme'
                ? (hedgeLots * 5 * exchangeRate)  // CMEå¾€è¿”
                : (hedgeContractValue * exchangeRate * 0.0011);  // Bybitå¾€è¿”0.055%Ã—2

            // 3. èµ„é‡‘æˆæœ¬: ä¿è¯é‡‘å ç”¨çš„æœºä¼šæˆæœ¬ (æŒ‰å¹´åŒ–4%è®¡ç®—)
            const capitalCost = totalMarginCny * 0.04 * (period / 365);

            // 4. æ»‘ç‚¹æˆæœ¬: é¢„ä¼°ä¸ºåˆçº¦ä»·å€¼çš„0.1%
            const slippageCost = (gfexContractValue + hedgeContractValueCny) * 0.001;

            const totalFee = gfexFee + hedgeFee + capitalCost + slippageCost;

            // å‡€æ”¶ç›Š
            const netProfit = grossProfit - totalFee;

            // === é£é™©è®¡ç®— ===
            // æœ€å¤§äºæŸ = å‡è®¾ä»·å·®æ‰©å¤§20%
            const maxLoss = spread * 0.2 * totalGrams + totalFee;

            // æ”¶ç›Šé£é™©æ¯”
            const riskRatio = Math.abs(netProfit / maxLoss);

            // === å¹´åŒ–æ”¶ç›Šç‡ ===
            const annualizedReturn = ((netProfit / totalMarginCny) * (365 / period) * 100);

            // === é£é™©ç­‰çº§åˆ¤æ–­ ===
            let riskLevel, riskClass;
            if (spreadPct > 30) {
                riskLevel = 'ğŸ”´ é«˜é£é™©';
                riskClass = 'high';
            } else if (spreadPct > 15) {
                riskLevel = 'âš ï¸ ä¸­é«˜é£é™©';
                riskClass = 'medium';
            } else {
                riskLevel = 'ğŸŸ¢ ä¸­ç­‰é£é™©';
                riskClass = 'low';
            }

            // === æ›´æ–°æ˜¾ç¤º ===

            // æŒä»“æ˜ç»† - å¹¿æœŸæ‰€åšç©º
            document.getElementById('gfex-position').textContent = `${contractCode} Ã— ${lots}æ‰‹`;
            document.getElementById('gfex-contract-value').textContent = `Â¥${formatNumber(gfexContractValue)}`;
            document.getElementById('result-gfex-margin').textContent = `Â¥${formatNumber(gfexMargin)}`;
            document.getElementById('gfex-grams').textContent = `= ${formatNumber(totalGrams)}å…‹`;

            // æŒä»“æ˜ç»† - å¯¹å†²åšå¤š
            document.getElementById('hedge-platform-name').textContent = hedgePlatform === 'cme' ? 'CME NYMEX' : 'Bybit MT5';
            document.getElementById('hedge-contract-type').textContent = hedgePlatform === 'cme' ? 'äº¤å‰²' : 'æ°¸ç»­';

            if (hedgePlatform === 'cme' && !canHedge) {
                // æ— æ³•å¯¹å†²æ—¶æ˜¾ç¤ºè­¦å‘Š
                document.getElementById('hedge-contract-type').style.background = 'var(--negative)';
                document.getElementById('hedge-position').textContent = `âš ï¸ æ— æ³•åŒ¹é…`;
                document.getElementById('hedge-position-detail').textContent = hedgeWarning;
                document.getElementById('hedge-contract-value').textContent = `-`;
                document.getElementById('result-hedge-margin').textContent = `-`;
            } else {
                document.getElementById('hedge-contract-type').style.background = hedgePlatform === 'cme' ? 'var(--info)' : 'var(--warning)';
                document.getElementById('hedge-position').textContent = hedgePlatform === 'cme'
                    ? `${hedgeCode} Ã— ${hedgeLots}æ‰‹`
                    : `${hedgeCode} Ã— ${hedgeOz.toFixed(2)} oz`;
                document.getElementById('hedge-position-detail').textContent = hedgeDetail;
                document.getElementById('hedge-contract-value').textContent = `â‰ˆÂ¥${formatNumber(hedgeContractValueCny)}`;
                document.getElementById('result-hedge-margin').textContent = `â‰ˆÂ¥${formatNumber(hedgeMarginCny)}`;
            }

            // æ€»ä¿è¯é‡‘
            document.getElementById('result-total-margin').textContent = `Â¥${formatNumber(totalMarginCny)}`;

            // æ”¶ç›Š
            const convergencePct = (convergence * 100).toFixed(0);
            document.getElementById('result-gross-profit').textContent = `Â¥${formatNumber(grossProfit)}`;

            // æ”¶ç›Šç‡ï¼ˆç›¸å¯¹äºä¿è¯é‡‘ï¼‰
            const returnRate = (grossProfit / totalMarginCny) * 100;
            const returnRateEl = document.getElementById('result-return-rate');
            returnRateEl.textContent = `+${returnRate.toFixed(0)}%`;
            returnRateEl.style.color = returnRate > 50 ? 'var(--warning)' : 'var(--positive)';

            document.getElementById('gross-profit-detail').textContent =
                `ä»·å·®${spread.toFixed(0)}å…ƒ/å…‹ Ã— ${convergencePct}%æ”¶æ•› Ã— ${totalGrams}å…‹`;

            document.getElementById('result-net-profit').textContent = `Â¥${formatNumber(netProfit)}`;
            document.getElementById('net-profit-detail').textContent =
                `æ¯›æ”¶ç›ŠÂ¥${formatNumber(grossProfit)} - æ‰‹ç»­è´¹Â¥${formatNumber(totalFee)}`;

            // æ›´æ–°æ”¶ç›Šé¢œè‰²
            const netProfitEl = document.getElementById('result-net-profit');
            if (netProfit >= 0) {
                netProfitEl.className = 'result-value green';
            } else {
                netProfitEl.className = 'result-value red';
            }

            // é£é™©
            document.getElementById('result-max-loss').textContent = `-Â¥${formatNumber(maxLoss)}`;
            document.getElementById('result-risk-ratio').textContent = `${riskRatio.toFixed(1)}:1`;

            // é£é™©ç­‰çº§
            document.getElementById('risk-level').textContent = riskLevel;
            document.getElementById('risk-level').style.color =
                riskClass === 'high' ? 'var(--negative)' :
                    riskClass === 'medium' ? 'var(--warning)' : 'var(--positive)';

            const riskBarFill = document.getElementById('risk-bar-fill');
            riskBarFill.className = `risk-fill ${riskClass}`;

            // æ‰§è¡Œæ­¥éª¤
            document.getElementById('step1-detail').textContent =
                `å–å‡º ${contractCode} ${lots}æ‰‹ @ ${gfexPrice.toFixed(2)}å…ƒ/å…‹`;
            document.getElementById('step2-detail').textContent =
                `ä¹°å…¥ ${hedgeCode} ${hedgeOz.toFixed(2)}ç›å¸ @ $${intlPriceUsd.toFixed(0)}`;

            // === é£é™©æ·±åº¦è®¡ç®— (Added) ===
            const exposureGrams = Math.abs(positionMismatch);
            const exposureDir = positionMismatch > 0 ? 'å‡€å¤šå¤´' : (positionMismatch < 0 ? 'å‡€ç©ºå¤´' : 'å®Œç¾å¯¹å†²');
            // è®¡ç®—æ•å£å¸¦æ¥çš„å¸‚å€¼é£é™© (åŸºäºå›½é™…ä»·æ ¼ä½œä¸ºå…¬å…å€¼)
            const exposureValue = exposureGrams * intlPriceCny;
            const exposureRisk1Pct = exposureValue * 0.01;

            // çˆ†ä»“ä»·è®¡ç®— (ç®€åŒ–ç‰ˆï¼šäºæŸ = ä¿è¯é‡‘)
            // å¹¿æœŸæ‰€åšç©ºï¼šä»·æ ¼ä¸Šæ¶¨å¯¼è‡´çˆ†ä»“ã€‚ Burst = Entry + Margin/Size
            const gfexBurst = gfexPrice + (gfexMargin / totalGrams);
            const gfexBurstPct = ((gfexBurst / gfexPrice - 1) * 100);

            // CMEåšå¤šï¼šä»·æ ¼ä¸‹è·Œå¯¼è‡´çˆ†ä»“ã€‚ Burst = Entry - Margin/Size
            // ç”¨æˆ·è¦æ±‚ï¼šä½¿ç”¨ç¾å…ƒæ ‡ä»· ($/oz)
            let cmeBurst = 0;
            let cmeBurstPct = 0;
            if (hedgeOz > 0) {
                // hedgeMargin å·²ç»æ˜¯ç¾å…ƒå•ä½
                cmeBurst = intlPriceUsd - (hedgeMargin / hedgeOz);
                cmeBurstPct = ((1 - cmeBurst / intlPriceUsd) * 100);
            }

            // æ›´æ–°UI
            const expEl = document.getElementById('risk-exposure-val');
            const expPnlEl = document.getElementById('risk-exposure-pnl');
            if (expEl && expPnlEl) {
                if (Math.abs(positionMismatch) < 1) { // å¿½ç•¥å¾®å°å·®å¼‚
                    expEl.textContent = "å®Œç¾å¯¹å†² (æ— æ•å£)";
                    expEl.style.color = "var(--positive)";
                    expPnlEl.textContent = "æ— æ•å£é£é™©";
                } else {
                    expEl.textContent = `${exposureDir} ${exposureGrams.toFixed(0)}å…‹`;
                    expEl.style.color = "var(--warning)";
                    expPnlEl.textContent = `ä»·æ ¼æ³¢åŠ¨1% â‰ˆ ç›ˆäº Â¥${exposureRisk1Pct.toFixed(0)}`;
                }
            }

            const burstGfexEl = document.getElementById('risk-burst-gfex');
            if (burstGfexEl) {
                burstGfexEl.textContent = `> Â¥${gfexBurst.toFixed(2)} (+${gfexBurstPct.toFixed(1)}%)`;
            }

            const burstCmeEl = document.getElementById('risk-burst-cme');
            if (burstCmeEl) {
                if (hedgeOz > 0) {
                    burstCmeEl.textContent = `< $${cmeBurst.toFixed(2)} (-${cmeBurstPct.toFixed(1)}%)`;
                } else {
                    burstCmeEl.textContent = "N/A";
                }
            }

            // === èµ„é‡‘ä¸ä¿è¯é‡‘æ™ºèƒ½åˆ†é… (Capital Allocation) ===
            const totalCapitalInput = document.getElementById('calc-total-capital');
            const allocationEl = document.getElementById('allocation-result');
            const cmeRatioSlider = document.getElementById('cme-ratio-slider');

            if (totalCapitalInput && allocationEl) {
                const totalCapital = parseFloat(totalCapitalInput.value) || 0;

                if (totalCapital < totalMarginCny) {
                    allocationEl.innerHTML = `<span style="color: var(--negative)">âš ï¸ æ€»èµ„é‡‘ Â¥${formatNumber(totalCapital)} ä¸è¶³æ”¯ä»˜æœ€ä½ä¿è¯é‡‘ Â¥${formatNumber(totalMarginCny)}</span>`;
                } else {
                    // ä½¿ç”¨æ»‘å—æ¯”ä¾‹è€Œéè‡ªåŠ¨è®¡ç®—
                    const cmeRatio = cmeRatioSlider ? (parseFloat(cmeRatioSlider.value) / 100) : 0.5;
                    const gfexRatio = 1 - cmeRatio;

                    const allocCme = totalCapital * cmeRatio;
                    const allocGfex = totalCapital * gfexRatio;
                    const allocCmeUsd = allocCme / exchangeRate;

                    // è®¡ç®—å¯æŠ—è·Œå¹…/æ¶¨å¹…
                    // å¹¿æœŸæ‰€ç©º: ä»·æ ¼ä¸Šæ¶¨ä¼šäºæŸ, å¯æŠ—æ¶¨å¹… = allocGfex / åˆçº¦ä»·å€¼
                    const optDPctGfex = ((allocGfex / gfexContractValue) * 100).toFixed(1);
                    const optBurstGfex = gfexPrice * (1 + allocGfex / gfexContractValue);

                    // CMEå¤š: ä»·æ ¼ä¸‹è·Œä¼šäºæŸ, å¯æŠ—è·Œå¹… = allocCme / åˆçº¦ä»·å€¼
                    let optDPctCme = '0.0';
                    let optBurstCme = 0;
                    if (hedgeContractValueCny > 0) {
                        optDPctCme = ((allocCme / hedgeContractValueCny) * 100).toFixed(1);
                        optBurstCme = intlPriceUsd * (1 - allocCme / hedgeContractValueCny);
                    }
                    // è®¡ç®—æ¨èæ­¢æŸä»· (ç•™20%å®‰å…¨è¾¹é™…ï¼Œå³åœ¨å¯æŠ—å¹…åº¦çš„80%ä½ç½®æ­¢æŸ)
                    const safetyMargin = 0.8;
                    const stopLossGfex = gfexPrice * (1 + (allocGfex / gfexContractValue) * safetyMargin);
                    const stopLossCme = intlPriceUsd * (1 - (allocCme / hedgeContractValueCny) * safetyMargin);

                    allocationEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 6px;">
                            <span>å¹¿æœŸæ‰€è´¦æˆ·: <strong style="color: var(--text-primary)">Â¥${formatNumber(allocGfex)}</strong> <span style="color:var(--text-muted);font-size:0.7rem;">(${(gfexRatio * 100).toFixed(0)}%)</span></span>
                            <span style="color: var(--warning)">å¯æŠ—æ¶¨å¹… +${optDPctGfex}% <span style="opacity:0.7">(Â¥${optBurstGfex.toFixed(0)})</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>CMEè´¦æˆ·: <strong style="color: var(--text-primary)">$${formatNumber(allocCmeUsd)}</strong> <span style="color:var(--text-muted);font-size:0.7rem;">(â‰ˆÂ¥${formatNumber(allocCme)}, ${(cmeRatio * 100).toFixed(0)}%)</span></span>
                            <span style="color: var(--info)">å¯æŠ—è·Œå¹… -${optDPctCme}% <span style="opacity:0.7">($${optBurstCme.toFixed(0)})</span></span>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">ğŸ›‘ å»ºè®®æ­¢æŸä»· <span style="opacity:0.6">(ä¿ç•™20%å®‰å…¨è¾¹é™…)</span></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.85rem;">
                            <div>
                                <span style="color: var(--text-muted);">å¹¿æœŸæ‰€ç©ºå•æ­¢æŸ:</span>
                                <strong style="color: var(--negative); margin-left: 4px;">Â¥${stopLossGfex.toFixed(2)}</strong>
                                <span style="color: var(--text-muted); font-size: 0.7rem;"> (+${((stopLossGfex / gfexPrice - 1) * 100).toFixed(1)}%)</span>
                            </div>
                            <div>
                                <span style="color: var(--text-muted);">CMEå¤šå•æ­¢æŸ:</span>
                                <strong style="color: var(--negative); margin-left: 4px;">$${stopLossCme.toFixed(2)}</strong>
                                <span style="color: var(--text-muted); font-size: 0.7rem;"> (-${((1 - stopLossCme / intlPriceUsd) * 100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            return Math.abs(num).toLocaleString('zh-CN', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) btn.textContent = 'â³ åˆ·æ–°ä¸­...';

            try {
                // é‡æ–°åŠ è½½ä»·å·®æ’è¡Œæ¦œ
                await loadSpreadRanking();

                // é‡æ–°åŠ è½½åˆå§‹åŒ–æ•°æ®
                await init();

                if (btn) btn.textContent = 'âœ… å·²åˆ·æ–°';
                setTimeout(() => { if (btn) btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®'; }, 2000);

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                if (btn) btn.textContent = 'âŒ åˆ·æ–°å¤±è´¥';
                setTimeout(() => { if (btn) btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®'; }, 2000);
            }
        }

        // æ›´æ–°CMEæ¯”ä¾‹æ»‘å—æ˜¾ç¤º
        function updateCmeRatioDisplay() {
            const slider = document.getElementById('cme-ratio-slider');
            const display = document.getElementById('cme-ratio-display');
            if (slider && display) {
                display.textContent = slider.value + '%';
            }
        }

        // åˆ‡æ¢å¯¹å†²å¹³å°æ—¶æ›´æ–°
        function updateHedgePlatform() {
            calculateArbitrage();
        }

        // æ›´æ–°èµ„é‡‘åˆ†é…è®¡ç®—
        function updateCapitalAllocation() {
            if (!selectedPair) return;

            const totalCapital = parseFloat(document.getElementById('calc-total-capital').value) || 2000000;
            const cmeRatio = parseFloat(document.getElementById('cme-ratio-slider').value) / 100;
            const gfexRatio = 1 - cmeRatio;

            const gfexAmount = totalCapital * gfexRatio;
            const cmeAmountCny = totalCapital * cmeRatio;
            const exchangeRate = 7.04;
            const cmeAmountUsd = cmeAmountCny / exchangeRate;

            // æŒä»“ä¿¡æ¯ï¼ˆ3æ‰‹ï¼‰
            const lots = 3;
            const grams = lots * 1000;
            const gfexPrice = selectedPair.gfexPrice;
            const cmeUsd = selectedPair.cmeUsd;
            const marginRate = 0.12; // 12%ä¿è¯é‡‘

            // å¹¿æœŸæ‰€ï¼šç©ºå•ï¼Œä»·æ ¼ä¸Šæ¶¨äºæŸ
            // è®¡ç®—çˆ†ä»“é£é™©ï¼ˆæŒ‰æƒç›Šå½’é›¶æˆ–ç»´æŒä¿è¯é‡‘è®¡ç®—ï¼Œè¿™é‡ŒæŒ‰æƒç›Šå½’é›¶/å¼ºå¹³çº¿ç®€å•ä¼°ç®—ï¼Œæ›´ç¬¦åˆç›´è§‰ï¼‰
            // å®é™…ä¸Šäº¤æ˜“æ‰€ä¼šåœ¨æƒç›Š < ç»´æŒä¿è¯é‡‘æ—¶å¼ºå¹³ï¼Œç»´æŒä¿è¯é‡‘é€šå¸¸ä¸ºä¿è¯é‡‘çš„0.7-0.8
            // ç”¨æˆ·åé¦ˆæ›´å€¾å‘äº TotalCapital / Value çš„ç®€å•ç®—æ³•
            const gfexResistPct = (gfexAmount / (gfexPrice * grams)) * 100;
            const gfexStopPrice = gfexPrice * (1 + gfexResistPct * 0.8 / 100); // ç•™20%å®‰å…¨è¾¹é™…

            // CMEï¼šå¤šå•ï¼Œä»·æ ¼ä¸‹è·ŒäºæŸï¼ˆ1ç›å¸=31.1035å…‹ï¼Œ1æ‰‹=100ç›å¸=3110.35å…‹ï¼‰
            const cmeContracts = 1;
            const cmeGrams = 3110.35 * cmeContracts;
            // CMEçˆ†ä»“é£é™©
            const cmeResistPct = (cmeAmountUsd / (cmeUsd * cmeContracts * 100)) * 100;
            const cmeStopPrice = cmeUsd * (1 - cmeResistPct * 0.8 / 100); // ç•™20%å®‰å…¨è¾¹é™…

            // æ ¼å¼åŒ–å‡½æ•°
            const formatNum = (n) => n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('alloc-gfex-amount').innerHTML =
                `Â¥${formatNum(gfexAmount)} <span style="font-size: 0.75rem; color: var(--text-muted);">(${(gfexRatio * 100).toFixed(0)}%)</span>`;
            document.getElementById('alloc-gfex-resist').textContent = `å¯æŠ—æ¶¨å¹… +${gfexResistPct.toFixed(1)}% (Â¥${(gfexPrice * gfexResistPct / 100).toFixed(0)})`;

            document.getElementById('alloc-cme-amount').innerHTML =
                `$${formatNum(cmeAmountUsd)} <span style="font-size: 0.75rem; color: var(--text-muted);">(â‰ˆÂ¥${formatNum(cmeAmountCny)}, ${(cmeRatio * 100).toFixed(0)}%)</span>`;
            document.getElementById('alloc-cme-resist').textContent = `å¯æŠ—è·Œå¹… -${cmeResistPct.toFixed(1)}% ($${(cmeUsd * cmeResistPct / 100).toFixed(0)})`;

            document.getElementById('stop-gfex').textContent = `Â¥${gfexStopPrice.toFixed(2)}`;
            document.getElementById('stop-gfex-pct').textContent = `(+${(gfexResistPct * 0.8).toFixed(1)}%)`;
            document.getElementById('stop-cme').textContent = `$${cmeStopPrice.toFixed(2)}`;
            document.getElementById('stop-cme-pct').textContent = `(-${(cmeResistPct * 0.8).toFixed(1)}%)`;
        }

        // ========== å†å²ä»·å·®å›¾è¡¨å˜é‡ï¼ˆéœ€åœ¨è°ƒç”¨å‰å£°æ˜ï¼‰==========
        let spreadChart = null;
        let currentCommodity = 'platinum';
        let currentSpreadType = 'pct';
        let cachedSpreadData = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function () {
            // å…ˆå°è¯•åŠ è½½ä¿å­˜çš„æ‰‹åŠ¨æ•°æ®
            await loadSavedPrices();

            setTimeout(() => {
                try {
                    calculateArbitrage();
                } catch (e) {
                    console.error('è®¡ç®—å™¨åˆå§‹åŒ–å¤±è´¥:', e);
                }

                // ç‹¬ç«‹æ‰§è¡Œå›¾è¡¨åŠ è½½ï¼Œäº’ä¸å½±å“
                // æ³¨æ„ï¼šspreadChartã€currentCommodityç­‰å˜é‡åœ¨ä¸‹æ–¹å®šä¹‰
                loadSpreadChart();
                loadSpreadRanking();

                // æ›´æ–°å¸‚åœºçŠ¶æ€
                updateMarketStatus();
            }, 500);
        });

        // æ›´æ–°å¸‚åœºçŠ¶æ€
        function updateMarketStatus() {
            const now = new Date();
            const day = now.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
            const hour = now.getHours();
            const minute = now.getMinutes();
            const time = hour * 100 + minute;

            // å¹¿æœŸæ‰€äº¤æ˜“æ—¶é—´: å‘¨ä¸€è‡³å‘¨äº” 9:00-11:30, 13:30-15:00, 21:00-æ¬¡æ—¥1:00
            let gfexOpen = false;
            if (day >= 1 && day <= 5) {
                if ((time >= 900 && time <= 1130) ||
                    (time >= 1330 && time <= 1500) ||
                    (time >= 2100 && time <= 2359)) {
                    gfexOpen = true;
                }
            }
            // å‘¨ä¸€å‡Œæ™¨ä¸å¼€ï¼ˆå‘¨æ—¥æ™šå¤œç›˜æ‰å¼€ï¼‰
            if (day >= 2 && day <= 5 && time >= 0 && time <= 100) {
                gfexOpen = true;
            }

            // NYMEXäº¤æ˜“æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: å‘¨ä¸€6:00-å‘¨å…­5:00 å‡ ä¹è¿ç»­ï¼Œæ¯å¤©5:00-6:00ä¼‘å¸‚
            let nymexOpen = false;
            if (day >= 1 && day <= 5) {
                // å‘¨ä¸€åˆ°å‘¨äº”
                if (time >= 600 || time < 500) {
                    nymexOpen = true;
                }
            } else if (day === 6 && time < 500) {
                // å‘¨å…­å‡Œæ™¨5ç‚¹å‰
                nymexOpen = true;
            }

            // æ›´æ–°å¹¿æœŸæ‰€çŠ¶æ€
            const gfexDot = document.getElementById('gfex-dot');
            const gfexStatus = document.getElementById('gfex-status');
            if (gfexDot) gfexDot.style.background = gfexOpen ? 'var(--positive)' : 'var(--text-muted)';
            if (gfexStatus) gfexStatus.textContent = gfexOpen ? 'å¹¿æœŸæ‰€ å¼€ç›˜' : 'å¹¿æœŸæ‰€ ä¼‘å¸‚';

            // æ›´æ–°NYMEXçŠ¶æ€
            const nymexDot = document.getElementById('nymex-dot');
            const nymexStatus = document.getElementById('nymex-status');
            if (nymexDot) nymexDot.style.background = nymexOpen ? 'var(--positive)' : 'var(--text-muted)';
            if (nymexStatus) nymexStatus.textContent = nymexOpen ? 'NYMEX å¼€ç›˜' : 'NYMEX ä¼‘å¸‚';
        }

        // åŠ è½½ä¿å­˜çš„æ‰‹åŠ¨ä»·æ ¼æ•°æ®
        async function loadSavedPrices() {
            try {
                const resp = await fetch('/api/saved-prices');
                if (!resp.ok) return;

                const data = await resp.json();
                if (!data) return;

                console.log('åŠ è½½ä¿å­˜çš„æ•°æ®:', data);

                // å¡«å……åˆ°è¾“å…¥æ¡†
                if (data.cme?.pt) document.getElementById('cme-pl-price').value = data.cme.pt;
                if (data.cme?.pd) document.getElementById('cme-pa-price').value = data.cme.pd;
                if (data.bybit?.pt) document.getElementById('spot-pl-price').value = data.bybit.pt;
                if (data.bybit?.pd) document.getElementById('spot-pa-price').value = data.bybit.pd;
                if (data.gfex?.pt) document.getElementById('gfex-pl-price').value = data.gfex.pt;
                if (data.gfex?.pd) document.getElementById('gfex-pa-price').value = data.gfex.pd;

                // æ˜¾ç¤ºä¿å­˜æ—¶é—´ (å®Œæ•´æ—¥æœŸ+æ—¶é—´æ ¼å¼)
                if (data.save_time) {
                    document.getElementById('data-time').textContent = data.save_time + ' (å·²ä¿å­˜)';
                    // save_time æ ¼å¼: "2025/12/26 11:07:30" -> "2025.12.26 11:07 æ‰‹åŠ¨"
                    const parts = data.save_time.split(' ');
                    const datePart = parts[0].replace(/\//g, '.');
                    const timePart = parts[1] ? parts[1].substring(0, 5) : '';
                    const timeLabel = datePart + ' ' + timePart + ' æ‰‹åŠ¨';
                    const ptGfexTimeEl = document.getElementById('pt-gfex-time');
                    const pdGfexTimeEl = document.getElementById('pd-gfex-time');
                    const ptCmeTimeEl = document.getElementById('pt-cme-time');
                    const pdCmeTimeEl = document.getElementById('pd-cme-time');
                    if (ptGfexTimeEl) ptGfexTimeEl.textContent = timeLabel;
                    if (pdGfexTimeEl) pdGfexTimeEl.textContent = timeLabel;
                    if (ptCmeTimeEl) ptCmeTimeEl.textContent = timeLabel;
                    if (pdCmeTimeEl) pdCmeTimeEl.textContent = timeLabel;
                }

                // è§¦å‘æ›´æ–°
                updateCMEPrice();

            } catch (e) {
                console.log('æ— ä¿å­˜æ•°æ®æˆ–åŠ è½½å¤±è´¥:', e);
            }
        }

        // ========== å¥—åˆ©åˆ†æç¼“å­˜ ==========
        let cachedPairs = { pt: [], pd: [] };
        let selectedPair = null;

        // ========== ä»·å·®æ’è¡Œæ¦œ ==========
        async function loadSpreadRanking() {
            const container = document.getElementById('spread-cards');
            if (!container) return;

            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">ğŸ“Š åŠ è½½ä¸­...</div>';

            try {
                // åŠ è½½é“‚é‡‘å’Œé’¯é‡‘çš„æ‰€æœ‰é…å¯¹æ•°æ®
                const [ptRes, pdRes] = await Promise.all([
                    fetch('platinum_all_pairs.json?t=' + Date.now()),
                    fetch('palladium_all_pairs.json?t=' + Date.now())
                ]);

                if (!ptRes.ok || !pdRes.ok) throw new Error('æ•°æ®åŠ è½½å¤±è´¥');

                const ptData = await ptRes.json();
                const pdData = await pdRes.json();

                // æ”¶é›†é“‚é‡‘é…å¯¹
                const ptPairs = [];
                const todayPt = new Date().toISOString().slice(0, 10);
                for (const [pairName, pair] of Object.entries(ptData.pairs)) {
                    if (pair.current) {
                        // è·å–ä»·æ ¼æ—¶é—´ï¼šhistoryæœ€åä¸€æ¡çš„date
                        const priceTime = pair.history && pair.history.length > 0
                            ? pair.history[pair.history.length - 1].date
                            : ptData.update_time;
                        // åªä¿ç•™ä»Šå¤©çš„æ•°æ®
                        const priceDate = priceTime.slice(0, 10);
                        if (priceDate !== todayPt) continue;

                        ptPairs.push({
                            pairName, priceTime,
                            gfexContract: pair.gfex_contract,
                            cmeContract: pair.cme_contract,
                            gfexPrice: pair.current.gfex_price,
                            cmeUsd: pair.current.cme_usd,
                            cmeCny: pair.current.cme_cny,
                            spread: pair.current.spread,
                            spreadPct: pair.current.spread_pct
                        });
                    }
                }
                ptPairs.sort((a, b) => b.spreadPct - a.spreadPct);

                // æ”¶é›†é’¯é‡‘é…å¯¹
                const pdPairs = [];
                const today = new Date().toISOString().slice(0, 10); // ä»Šå¤©æ—¥æœŸ YYYY-MM-DD
                for (const [pairName, pair] of Object.entries(pdData.pairs)) {
                    if (pair.current) {
                        const priceTime = pair.history && pair.history.length > 0
                            ? pair.history[pair.history.length - 1].date
                            : pdData.update_time;
                        // åªä¿ç•™ä»Šå¤©çš„æ•°æ®
                        const priceDate = priceTime.slice(0, 10);
                        if (priceDate !== today) continue;

                        pdPairs.push({
                            pairName, priceTime,
                            gfexContract: pair.gfex_contract,
                            cmeContract: pair.cme_contract,
                            gfexPrice: pair.current.gfex_price,
                            cmeUsd: pair.current.cme_usd,
                            cmeCny: pair.current.cme_cny,
                            spread: pair.current.spread,
                            spreadPct: pair.current.spread_pct
                        });
                    }
                }
                pdPairs.sort((a, b) => b.spreadPct - a.spreadPct);

                // ç”Ÿæˆè¡ŒHTMLçš„å‡½æ•°
                function renderRow(pair, idx, icon, iconBg) {
                    const spreadClass = pair.spread >= 0 ? 'positive' : 'negative';
                    const spreadSign = pair.spread >= 0 ? '+' : '';
                    return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 4px;">
                            <div style="background: var(--accent-gold); color: #000; padding: 1px 5px; border-radius: 3px; font-size: 0.6rem; font-weight: bold;">#${idx + 1}</div>
                            <div style="width: 22px; height: 22px; border-radius: 50%; background: ${iconBg}; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.6rem;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.8rem;">${pair.pairName}</div>
                                <div style="font-size: 0.6rem; color: var(--text-muted);">${pair.gfexContract} | ${pair.cmeContract}</div>
                            </div>
                            <div style="text-align: right; font-size: 0.65rem; min-width: 75px;">
                                <div style="color: var(--accent-gold);">å¹¿æœŸæ‰€ ${pair.gfexPrice.toFixed(2)}</div>
                                <div style="color: var(--info);">CME ${pair.cmeUsd.toFixed(1)} â†’ ${pair.cmeCny.toFixed(2)}</div>
                            </div>
                            <div style="text-align: right; font-size: 0.7rem; min-width: 50px;">
                                <div style="color: var(--${spreadClass});">${spreadSign}${pair.spread.toFixed(1)}</div>
                                <div style="font-weight: 700; color: var(--${spreadClass});">${spreadSign}${pair.spreadPct.toFixed(2)}%</div>
                            </div>
                            <div style="font-size: 0.55rem; color: var(--text-muted); min-width: 80px; text-align: right;">${pair.priceTime}</div>
                        </div>
                    `;
                }

                // ç”Ÿæˆä¸¤åˆ—å¸ƒå±€HTML
                const defaultShow = 5;
                let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">';

                // å·¦åˆ—ï¼šé“‚é‡‘
                html += '<div>';
                html += `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #a78bfa;">ğŸ”· é“‚é‡‘ Platinum</span>
                    ${ptPairs.length > defaultShow ? `<button id="pt-expand-btn" onclick="togglePtExpand()" style="padding: 2px 8px; background: transparent; border: 1px solid var(--text-muted); border-radius: 4px; color: var(--text-muted); cursor: pointer; font-size: 0.65rem;">å±•å¼€å…¨éƒ¨ (${ptPairs.length})</button>` : ''}
                </div>`;
                html += '<div id="pt-list">';
                ptPairs.slice(0, defaultShow).forEach((pair, idx) => { html += renderRow(pair, idx, 'Pt', '#a78bfa'); });
                html += '</div>';
                html += `<div id="pt-list-hidden" style="display: none;">`;
                ptPairs.slice(defaultShow).forEach((pair, idx) => { html += renderRow(pair, idx + defaultShow, 'Pt', '#a78bfa'); });
                html += '</div>';
                html += '</div>';

                // å³åˆ—ï¼šé’¯é‡‘
                html += '<div>';
                html += `<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #f472b6;">ğŸ”¶ é’¯é‡‘ Palladium</span>
                    ${pdPairs.length > defaultShow ? `<button id="pd-expand-btn" onclick="togglePdExpand()" style="padding: 2px 8px; background: transparent; border: 1px solid var(--text-muted); border-radius: 4px; color: var(--text-muted); cursor: pointer; font-size: 0.65rem;">å±•å¼€å…¨éƒ¨ (${pdPairs.length})</button>` : ''}
                </div>`;
                html += '<div id="pd-list">';
                pdPairs.slice(0, defaultShow).forEach((pair, idx) => { html += renderRow(pair, idx, 'Pd', '#f472b6'); });
                html += '</div>';
                html += `<div id="pd-list-hidden" style="display: none;">`;
                pdPairs.slice(defaultShow).forEach((pair, idx) => { html += renderRow(pair, idx + defaultShow, 'Pd', '#f472b6'); });
                html += '</div>';
                html += '</div>';

                html += '</div>';

                container.innerHTML = html;
                console.log(`å·²åŠ è½½é“‚é‡‘${ptPairs.length}ä¸ªã€é’¯é‡‘${pdPairs.length}ä¸ªé…å¯¹`);

                // ç¼“å­˜é…å¯¹æ•°æ®å¹¶ç”Ÿæˆå¥—åˆ©åˆ†æé€‰é¡¹å—
                cachedPairs.pt = ptPairs;
                cachedPairs.pd = pdPairs;
                generatePairTabs();

            } catch (error) {
                console.error('åŠ è½½ä»·å·®æ’è¡Œå¤±è´¥:', error);
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--negative);">âŒ ${error.message}</div>`;
            }
        }

        // é“‚é‡‘å±•å¼€/æ”¶èµ·
        function togglePtExpand() {
            const hidden = document.getElementById('pt-list-hidden');
            const btn = document.getElementById('pt-expand-btn');
            if (hidden.style.display === 'none') {
                hidden.style.display = 'block';
                btn.textContent = 'æ”¶èµ·';
            } else {
                hidden.style.display = 'none';
                btn.textContent = 'å±•å¼€å…¨éƒ¨';
            }
        }

        // é’¯é‡‘å±•å¼€/æ”¶èµ·
        function togglePdExpand() {
            const hidden = document.getElementById('pd-list-hidden');
            const btn = document.getElementById('pd-expand-btn');
            if (hidden.style.display === 'none') {
                hidden.style.display = 'block';
                btn.textContent = 'æ”¶èµ·';
            } else {
                hidden.style.display = 'none';
                btn.textContent = 'å±•å¼€å…¨éƒ¨';
            }
        }

        // ========== å¥—åˆ©åˆ†æé€‰é¡¹å— ==========

        // ç”Ÿæˆé…å¯¹é€‰é¡¹å—ï¼ˆåœ¨loadSpreadRankingåè°ƒç”¨ï¼‰
        function generatePairTabs() {
            const container = document.getElementById('calc-pair-tabs');
            if (!container) return;

            // åˆ†åˆ«ç”Ÿæˆé“‚é‡‘å’Œé’¯é‡‘é€‰é¡¹å—ï¼ˆå„å–å‰16ä¸ªï¼‰
            const ptTop = cachedPairs.pt.slice(0, 16);
            const pdTop = cachedPairs.pd.slice(0, 16);

            let html = '';

            // é“‚é‡‘ä¸‹æ‹‰æ¡†
            html += `<div style="display: flex; align-items: center; gap: 8px;">
                <span id="pt-label" style="font-size: 0.9rem; font-weight: 700; padding: 4px 12px; border-radius: 6px; transition: all 0.3s; color: #64748b;">é“‚é‡‘</span>
                <select id="pt-pair-select" onchange="selectPairTab('pt', this.value)" 
                    style="background: var(--bg-primary); color: var(--text-secondary); border: 1px solid #334155; padding: 4px 8px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; outline: none; min-width: 140px; height: 32px; transition: all 0.3s;">
                    <option value="" disabled selected>é€‰æ‹©åˆçº¦é…å¯¹</option>
                    ${ptTop.map(pair => `<option value="${pair.pairName}">${pair.pairName} +${pair.spreadPct.toFixed(0)}%</option>`).join('')}
                </select>
            </div>`;

            // é’¯é‡‘ä¸‹æ‹‰æ¡†
            html += `<div style="display: flex; align-items: center; gap: 8px;">
                <span id="pd-label" style="font-size: 0.9rem; font-weight: 700; padding: 4px 12px; border-radius: 6px; transition: all 0.3s; color: #64748b;">é’¯é‡‘</span>
                <select id="pd-pair-select" onchange="selectPairTab('pd', this.value)" 
                    style="background: var(--bg-primary); color: var(--text-secondary); border: 1px solid #334155; padding: 4px 8px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; outline: none; min-width: 140px; height: 32px; transition: all 0.3s;">
                    <option value="" disabled>é€‰æ‹©åˆçº¦é…å¯¹</option>
                    ${pdTop.map(pair => `<option value="${pair.pairName}">${pair.pairName} +${pair.spreadPct.toFixed(0)}%</option>`).join('')}
                </select>
            </div>`;

            container.innerHTML = html;

            // é»˜è®¤é€‰ä¸­é“‚é‡‘ç¬¬ä¸€ä¸ªï¼ˆä»·å·®æœ€é«˜çš„ï¼‰
            if (ptTop.length > 0) {
                const defaultPair = ptTop[0].pairName;
                document.getElementById('pt-pair-select').value = defaultPair;
                selectPairTab('pt', defaultPair);
            }
        }

        // é€‰æ‹©é…å¯¹
        function selectPairTab(type, pairName) {
            const pairs = type === 'pt' ? cachedPairs.pt : cachedPairs.pd;
            selectedPair = pairs.find(p => p.pairName === pairName);
            if (!selectedPair) return;

            // äº’æ–¥é€»è¾‘åŠæ ·å¼æ›´æ–°ï¼šå‚ç…§ç”¨æˆ·æˆªå›¾é£æ ¼
            // é€‰ä¸­æ€ï¼šLabelèƒŒæ™¯è‰²+é»‘å­—ï¼ŒSelectå¯¹åº”è¾¹æ¡†è‰²
            // æœªé€‰æ€ï¼šLabelé»˜è®¤è‰²ï¼ŒSelectç°è¾¹æ¡†
            const ptLabel = document.getElementById('pt-label');
            const ptSelect = document.getElementById('pt-pair-select');

            const pdLabel = document.getElementById('pd-label');
            const pdSelect = document.getElementById('pd-pair-select');

            if (type === 'pt') {
                // è®¾ç½®é’¯é‡‘ä¸ºæœªé€‰ä¸­
                if (pdSelect) {
                    pdSelect.value = "";
                    pdSelect.style.borderColor = '#334155';
                    pdSelect.style.color = '#64748b';
                }
                if (pdLabel) {
                    pdLabel.style.background = 'transparent';
                    pdLabel.style.color = '#64748b';
                }

                // è®¾ç½®é“‚é‡‘ä¸ºé€‰ä¸­
                if (ptSelect) {
                    if (ptSelect.value !== pairName) ptSelect.value = pairName;
                    ptSelect.style.borderColor = '#fbbf24'; // é‡‘è‰²è¾¹æ¡†
                    ptSelect.style.color = '#fbbf24';
                }
                if (ptLabel) {
                    ptLabel.style.background = '#fbbf24'; // é‡‘è‰²èƒŒæ™¯
                    ptLabel.style.color = '#000'; // é»‘å­—
                }

            } else {
                // è®¾ç½®é“‚é‡‘ä¸ºæœªé€‰ä¸­
                if (ptSelect) {
                    ptSelect.value = "";
                    ptSelect.style.borderColor = '#334155';
                    ptSelect.style.color = '#64748b';
                }
                if (ptLabel) {
                    ptLabel.style.background = 'transparent';
                    ptLabel.style.color = '#64748b';
                }

                // è®¾ç½®é’¯é‡‘ä¸ºé€‰ä¸­
                if (pdSelect) {
                    if (pdSelect.value !== pairName) pdSelect.value = pairName;
                    // æš‚æ—¶ç»Ÿä¸€ç”¨é‡‘è‰²é«˜äº®ï¼Œç¬¦åˆâ€œé€‰ä¸­çŠ¶æ€â€çš„ç»Ÿä¸€éšå–»
                    pdSelect.style.borderColor = '#fbbf24';
                    pdSelect.style.color = '#fbbf24';
                }
                if (pdLabel) {
                    pdLabel.style.background = '#fbbf24';
                    pdLabel.style.color = '#000';
                }
            }

            // æ›´æ–°æ ‡é¢˜æ—çš„é€‰ä¸­ä¿¡æ¯
            const infoSpan = document.getElementById('selected-pair-info');
            if (infoSpan) {
                // e.g. "å·²é€‰ä¸­ï¼šé“‚é‡‘ 2610-2601"
                infoSpan.innerHTML = `å·²é€‰ä¸­ï¼š<span style="color: ${type === 'pt' ? '#a78bfa' : '#f472b6'}">${type === 'pt' ? 'é“‚é‡‘' : 'é’¯é‡‘'}</span> <span style="font-family: monospace; color: var(--text-primary);">${pairName}</span>`;
            }

            updateArbitrageAnalysis(selectedPair);
            updateCapitalAllocation();
        }

        // æ›´æ–°å¥—åˆ©åˆ†ææ˜¾ç¤º
        function updateArbitrageAnalysis(pair) {
            if (!pair) return;

            const lots = 3; // 3æ‰‹
            const grams = lots * 1000; // 3000å…‹
            const spread = pair.spread;
            const avgSpreadPct = pair.avgSpreadPct || 16; // é»˜è®¤å‡å€¼16%
            const avgSpread = pair.cmeCny * avgSpreadPct / 100;

            // å®Œå…¨æ”¶æ•›æ”¶ç›Š
            const fullProfit = spread * grams;
            const fullReturnPct = (fullProfit / (pair.gfexPrice * grams * 0.12)) * 100; // å‡è®¾12%ä¿è¯é‡‘

            // æ”¶æ•›è‡³å‡å€¼æ”¶ç›Š
            const avgProfit = (spread - avgSpread) * grams;
            const avgReturnPct = (avgProfit / (pair.gfexPrice * grams * 0.12)) * 100;

            // å¤–æ±‡æ³¢åŠ¨å½±å“ï¼šCMEä»¥USDè®¡ä»·ï¼Œäººæ°‘å¸è´¬å€¼ä¼šå¢åŠ CMEæ¢ç®—ä»·æ ¼
            // äººæ°‘å¸è´¬å€¼1% æ„å‘³ç€ CMEä»·æ ¼æ¢ç®—åå‡é«˜çº¦1%ï¼Œå¯¹å†²åšå¤šç«¯çš„äººæ°‘å¸ä»·å€¼å¢åŠ 
            const fxImpact = pair.cmeCny * grams * 0.01;

            // æ•å£å½±å“ï¼š110å…‹æ•å£ Ã— 10%ä»·æ ¼æ³¢åŠ¨
            const exposureGrams = 110; // å›ºå®šæ•å£
            const exposureImpact = exposureGrams * pair.gfexPrice * 0.10; // 10%ä»·æ ¼æ³¢åŠ¨

            // ä¼°ç®—æ‰‹ç»­è´¹ (åŒè¾¹) - å‡è®¾çº¦200å…ƒæˆ–æŒ‰æ¯”ä¾‹
            // è¿™é‡Œç®€å•æŒ‰æ€»ä»·å€¼ä¸‡åˆ†ä¹‹ä¸€ä¼°ç®—ï¼Œæˆ–è€…ç›´æ¥ç»™ä¸ªå›ºå®šå‚è€ƒå€¼
            // å‡è®¾å•è¾¹ä¸‡åˆ†ä¹‹0.5ï¼ŒåŒè¾¹ä¸‡åˆ†ä¹‹1 (CME + GFEX)
            // GFEX 3000g * price * 0.0001
            const totalValue = (pair.gfexPrice * grams) + (pair.cmeCny * grams);
            const tradingFee = totalValue * 0.0002; // åŒè¾¹ä¸‡åˆ†ä¹‹äºŒ (ä¿å®ˆä¼°è®¡)

            // æ»‘ç‚¹æˆæœ¬: æŒ‰æ€»ä»·å€¼çš„0.1%ä¼°ç®—
            const slippageCost = totalValue * 0.001;

            // èµ„é‡‘æˆæœ¬: å‡è®¾ä¿è¯é‡‘æ¯”ä¾‹12%, å¹´åŒ–4%, æŒä»“å¤©æ•°æ ¹æ®åˆçº¦è®¡ç®—
            // ä» pairName è§£ææŒä»“å¤©æ•° (å¦‚ "2610-2601" è¡¨ç¤º Dec 2026 - Jan 2026, çº¦11ä¸ªæœˆ)
            // ç®€åŒ–: å‡è®¾å¹³å‡æŒä»“3ä¸ªæœˆ
            const marginRatio = 0.12;
            const annualRate = 0.04;
            const holdingMonths = 3; // å¹³å‡æŒä»“æœˆæ•°
            const capitalCost = (totalValue * marginRatio) * (annualRate * holdingMonths / 12);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('result-gross-profit').textContent = `Â¥${fullProfit.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
            document.getElementById('gross-profit-detail').textContent = `ä»·å·®${spread.toFixed(1)}å…ƒ/å…‹ Ã— ${grams}å…‹`;

            // æ›´æ–°è´¹ç”¨è¡Œ
            const tradingFeeEl = document.getElementById('result-trading-fee');
            if (tradingFeeEl) tradingFeeEl.textContent = `Â¥${tradingFee.toFixed(0)}`;

            const slippageEl = document.getElementById('result-slippage');
            if (slippageEl) slippageEl.textContent = `Â¥${slippageCost.toFixed(0)}`;

            document.getElementById('result-avg-profit').textContent = avgProfit > 0
                ? `Â¥${avgProfit.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`
                : `-Â¥${Math.abs(avgProfit).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
            document.getElementById('avg-profit-detail').textContent = `ä»·å·®${spread.toFixed(1)}å…ƒ/å…‹ Ã— ${grams}å…‹`;

            // æ›´æ–°åº•éƒ¨çº¢è‰²æ¡ä»¶æ–‡æœ¬
            const conditionAvgEl = document.getElementById('result-condition-avg');
            if (conditionAvgEl) conditionAvgEl.textContent = `è‹¥ä»·å·®æ”¶æ•›è‡³å‡å€¼ ${avgSpreadPct.toFixed(0)}%`;

            document.getElementById('result-fx-impact').textContent = `Â±Â¥${fxImpact.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;

            document.getElementById('result-exposure-impact').textContent = `Â±Â¥${exposureImpact.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
            document.getElementById('exposure-impact-detail').textContent = `æ•å£${exposureGrams}å…‹ Ã— 10%æ³¢åŠ¨`;
        }

        // ========== å†å²ä»·å·®å›¾è¡¨ ==========
        // å˜é‡å·²åœ¨å‰é¢å£°æ˜ï¼šspreadChart, currentCommodity, currentSpreadType, cachedSpreadData

        // ä»·å·®ç±»å‹åˆ‡æ¢å‡½æ•°
        function switchSpreadType(type) {
            currentSpreadType = type;

            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('spread-type-pct').style.background = type === 'pct' ? 'var(--accent-gold)' : 'transparent';
            document.getElementById('spread-type-pct').style.color = type === 'pct' ? '#000' : 'var(--text-muted)';
            document.getElementById('spread-type-abs').style.background = type === 'abs' ? 'var(--accent-gold)' : 'transparent';
            document.getElementById('spread-type-abs').style.color = type === 'abs' ? '#000' : 'var(--text-muted)';

            // é‡æ–°åŠ è½½å›¾è¡¨
            loadSpreadChart();
        }


        // å“ç§åˆ‡æ¢å‡½æ•°
        function switchCommodity(commodity) {
            currentCommodity = commodity;

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.commodity-tab').forEach(tab => {
                tab.style.background = 'transparent';
                tab.style.color = 'var(--text-muted)';
            });
            const activeTab = document.getElementById('tab-' + commodity);
            if (activeTab) {
                activeTab.style.background = 'var(--accent-gold)';
                activeTab.style.color = '#000';
            }

            // æ˜¾ç¤º/éšè—é…å¯¹é€‰æ‹©å™¨
            const ptPairSelect = document.getElementById('platinum-pair-select');
            const pdPairSelect = document.getElementById('palladium-pair-select');
            const auPairSelect = document.getElementById('gold-pair-select');
            const agPairSelect = document.getElementById('silver-pair-select');
            if (ptPairSelect) ptPairSelect.style.display = (commodity === 'platinum') ? 'block' : 'none';
            if (pdPairSelect) pdPairSelect.style.display = (commodity === 'palladium') ? 'block' : 'none';
            if (auPairSelect) auPairSelect.style.display = (commodity === 'gold') ? 'block' : 'none';
            if (agPairSelect) agPairSelect.style.display = (commodity === 'silver') ? 'block' : 'none';

            // æ›´æ–°å‰¯æ ‡é¢˜
            const subtitles = {
                'platinum': 'å¹¿æœŸæ‰€ PT2610 vs CME é“‚é‡‘',
                'palladium': 'å¹¿æœŸæ‰€ PD2606 vs CME é’¯é‡‘',
                'gold': 'ä¸ŠæœŸæ‰€ vs COMEXé»„é‡‘',
                'silver': 'ä¸ŠæœŸæ‰€ vs COMEXç™½é“¶',
                'copper': 'ä¸ŠæœŸæ‰€ vs COMEXé“œ'
            };
            document.getElementById('chart-subtitle').textContent = subtitles[commodity] || '';

            // é‡æ–°åŠ è½½å›¾è¡¨
            loadSpreadChart();
        }

        // é“‚é‡‘é…å¯¹åˆ‡æ¢å‡½æ•°
        function switchPlatinumPair(pairName) {
            // ç¡®ä¿å½“å‰æ˜¯é“‚é‡‘
            if (currentCommodity !== 'platinum') {
                switchCommodity('platinum');
            }
            // æ›´æ–°æ ‡ç­¾
            document.getElementById('pt-pair-label').textContent = pairName;
            // é‡æ–°åŠ è½½å›¾è¡¨
            loadSpreadChart();
        }

        // é’¯é‡‘é…å¯¹åˆ‡æ¢å‡½æ•°
        function switchPalladiumPair(pairName) {
            // ç¡®ä¿å½“å‰æ˜¯é’¯é‡‘
            if (currentCommodity !== 'palladium') {
                switchCommodity('palladium');
            }
            // æ›´æ–°æ ‡ç­¾
            document.getElementById('pd-pair-label').textContent = pairName;
            // é‡æ–°åŠ è½½å›¾è¡¨
            loadSpreadChart();
        }

        // é»„é‡‘åˆçº¦åˆ‡æ¢å‡½æ•°
        function switchGoldPair(contractName) {
            if (currentCommodity !== 'gold') {
                switchCommodity('gold');
            }
            document.getElementById('au-pair-label').textContent = contractName.replace('AU', '');
            loadSpreadChart();
        }

        // ç™½é“¶åˆçº¦åˆ‡æ¢å‡½æ•°
        function switchSilverPair(contractName) {
            if (currentCommodity !== 'silver') {
                switchCommodity('silver');
            }
            document.getElementById('ag-pair-label').textContent = contractName.replace('AG', '');
            loadSpreadChart();
        }

        async function loadSpreadChart() {
            const chartDom = document.getElementById('spread-chart');
            if (!chartDom) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            chartDom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">ğŸ“Š åŠ è½½å†å²æ•°æ®ä¸­...</div>';

            try {
                // 1. æ£€æŸ¥EChartsåº“æ˜¯å¦åŠ è½½
                if (typeof echarts === 'undefined') {
                    throw new Error('EChartsåº“æœªåŠ è½½ï¼Œå¯èƒ½CDNè®¿é—®å—é™');
                }

                let data, chartData;

                if (currentCommodity === 'platinum') {
                    // é“‚é‡‘ï¼šä»é…å¯¹æ•°æ®æ–‡ä»¶åŠ è½½
                    const response = await fetch('platinum_all_pairs.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status})`);
                    const allPairs = await response.json();

                    // åŠ¨æ€æ›´æ–°ä¸‹æ‹‰èœå•é€‰é¡¹
                    // åŠ¨æ€æ›´æ–°ä¸‹æ‹‰èœå•é€‰é¡¹
                    const pairSelect = document.getElementById('platinum-pair-select');
                    if (pairSelect) {
                        const currentVal = pairSelect.value;
                        pairSelect.innerHTML = '';
                        const sortedPairs = Object.keys(allPairs.pairs).sort();

                        sortedPairs.forEach(pair => {
                            const option = document.createElement('option');
                            option.value = pair;
                            option.textContent = pair;
                            pairSelect.appendChild(option);
                        });

                        // å°è¯•æ¢å¤é€‰ä¸­é¡¹
                        if (sortedPairs.includes(currentVal)) {
                            pairSelect.value = currentVal;
                        } else if (sortedPairs.length > 0) {
                            pairSelect.value = sortedPairs[0];
                        }
                    }

                    // è·å–å½“å‰é€‰ä¸­çš„é…å¯¹
                    const selectedPair = pairSelect ? pairSelect.value : (Object.keys(allPairs.pairs)[0] || '2610-2610');
                    data = allPairs.pairs[selectedPair];

                    if (!data) throw new Error(`æœªæ‰¾åˆ°é…å¯¹ ${selectedPair} çš„æ•°æ®`);

                    // æ›´æ–°å‰¯æ ‡é¢˜
                    document.getElementById('chart-subtitle').textContent =
                        `å¹¿æœŸæ‰€ PT${selectedPair.split('-')[0]} vs CME PL ${selectedPair.split('-')[1]}`;
                    document.getElementById('pt-pair-label').textContent = selectedPair;

                    chartData = {
                        dates: data.history.map(item => item.date),
                        spreads: data.history.map(item => item.spread_pct),
                        spreadsAbs: data.history.map(item => item.spread), // ç»å¯¹å€¼ä»·å·®
                        current: data.current.spread_pct,
                        currentAbs: data.current.spread,
                        avg: data.stats.avg_spread_pct,
                        max: data.stats.max_spread_pct,
                        min: data.stats.min_spread_pct
                    };
                } else if (currentCommodity === 'palladium') {
                    // é’¯é‡‘ï¼šä»é…å¯¹æ•°æ®æ–‡ä»¶åŠ è½½
                    const response = await fetch('palladium_all_pairs.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`é’¯é‡‘æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status})`);
                    const allPairs = await response.json();

                    // åŠ¨æ€æ›´æ–°ä¸‹æ‹‰èœå•é€‰é¡¹
                    // åŠ¨æ€æ›´æ–°ä¸‹æ‹‰èœå•é€‰é¡¹
                    const pairSelect = document.getElementById('palladium-pair-select');
                    if (pairSelect) {
                        const currentVal = pairSelect.value;
                        pairSelect.innerHTML = '';
                        // è·å–æ‰€æœ‰é…å¯¹å¹¶ä¿ç•™ä»Šå¤©æœ‰æ•°æ®çš„ï¼Œæˆ–è€…å…¨éƒ¨
                        // è¿™é‡Œæˆ‘ä»¬å…¨éƒ¨æ˜¾ç¤ºï¼Œæ–¹ä¾¿æŸ¥çœ‹å†å²
                        const sortedPairs = Object.keys(allPairs.pairs).sort();

                        sortedPairs.forEach(pair => {
                            // è¿‡æ»¤æ‰æ²¡æœ‰todayæ•°æ®çš„ï¼ˆå¯é€‰ï¼Œå¦‚æœæƒ³çœ‹å†å²å°±ä¸è¿‡æ»¤ï¼‰
                            // è¿™é‡Œä¸è¿‡æ»¤ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æƒ³çœ‹åˆšæ‰è¯´çš„2604çš„å†å²
                            const option = document.createElement('option');
                            option.value = pair;
                            option.textContent = pair;
                            pairSelect.appendChild(option);
                        });

                        // å°è¯•æ¢å¤é€‰ä¸­é¡¹ï¼Œæˆ–è€…é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                        if (sortedPairs.includes(currentVal)) {
                            pairSelect.value = currentVal;
                        } else if (sortedPairs.length > 0) {
                            pairSelect.value = sortedPairs[0];
                        }
                    }

                    // è·å–å½“å‰é€‰ä¸­çš„é…å¯¹
                    const selectedPair = pairSelect ? pairSelect.value : (Object.keys(allPairs.pairs)[0] || '2606-2606');
                    data = allPairs.pairs[selectedPair];

                    if (!data) throw new Error(`æœªæ‰¾åˆ°é…å¯¹ ${selectedPair} çš„æ•°æ®`);

                    // æ›´æ–°å‰¯æ ‡é¢˜
                    document.getElementById('chart-subtitle').textContent =
                        `å¹¿æœŸæ‰€ PD${selectedPair.split('-')[0]} vs CME PA ${selectedPair.split('-')[1]}`;
                    document.getElementById('pd-pair-label').textContent = selectedPair;

                    chartData = {
                        dates: data.history.map(item => item.date),
                        spreads: data.history.map(item => item.spread_pct),
                        spreadsAbs: data.history.map(item => item.spread), // ç»å¯¹å€¼ä»·å·®
                        current: data.current.spread_pct,
                        currentAbs: data.current.spread,
                        avg: data.stats.avg_spread_pct,
                        max: data.stats.max_spread_pct,
                        min: data.stats.min_spread_pct
                    };
                } else if (currentCommodity === 'gold' || currentCommodity === 'silver') {
                    // é»„é‡‘/ç™½é“¶ï¼šä»æ”¶æ•›æ•°æ®æ–‡ä»¶åŠ è½½æŒ‡å®šåˆçº¦
                    const response = await fetch('contract_convergence_data.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`æ”¶æ•›æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status})`);
                    const convergenceData = await response.json();

                    // è·å–å½“å‰é€‰ä¸­çš„åˆçº¦
                    const selectId = currentCommodity === 'gold' ? 'gold-pair-select' : 'silver-pair-select';
                    const pairSelect = document.getElementById(selectId);
                    const selectedContract = pairSelect ? pairSelect.value : (currentCommodity === 'gold' ? 'AU2412' : 'AG2412');

                    // æŸ¥æ‰¾å¯¹åº”åˆçº¦æ•°æ®
                    const contractData = convergenceData.contracts.find(c => c.symbol === selectedContract);
                    if (!contractData) throw new Error(`æœªæ‰¾åˆ°åˆçº¦ ${selectedContract} çš„æ•°æ®`);

                    // æ›´æ–°å‰¯æ ‡é¢˜
                    const metalName = currentCommodity === 'gold' ? 'é»„é‡‘' : 'ç™½é“¶';
                    document.getElementById('chart-subtitle').textContent = `ä¸ŠæœŸæ‰€ ${selectedContract} vs COMEX ${metalName}`;

                    chartData = {
                        dates: contractData.history.map(item => item.date),
                        spreads: contractData.history.map(item => item.spread_pct),
                        current: contractData.end_spread,
                        avg: (contractData.start_spread + contractData.end_spread) / 2,
                        max: Math.max(...contractData.history.map(h => h.spread_pct)),
                        min: Math.min(...contractData.history.map(h => h.spread_pct))
                    };
                } else {
                    // é“œï¼šä½¿ç”¨åŸæœ‰æ•°æ®æ–‡ä»¶
                    const response = await fetch('precious_metals_spread_history.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status})`);
                    data = await response.json();

                    const commodityData = data.commodities[currentCommodity];
                    if (!commodityData) throw new Error(`æœªæ‰¾åˆ°${currentCommodity}æ•°æ®`);

                    chartData = {
                        dates: commodityData.history.map(item => item.date),
                        spreads: commodityData.history.map(item => item.spread_pct),
                        current: commodityData.current_spread_pct,
                        avg: commodityData.avg_spread_pct,
                        max: commodityData.max_spread_pct,
                        min: commodityData.min_spread_pct
                    };
                }

                console.log('Spread Data Loaded:', chartData);
                console.log('chartDom:', chartDom, 'spreads length:', chartData.spreads ? chartData.spreads.length : 0);

                // 3. æ¸²æŸ“å›¾è¡¨
                if (chartDom && chartData.spreads && chartData.spreads.length > 0) {
                    renderSpreadChartGeneric(chartDom, chartData);
                } else {
                    chartDom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">âš ï¸ æ— æœ‰æ•ˆæ•°æ®</div>';
                }

                // 4. æ›´æ–°ç»Ÿè®¡æ•°æ®
                const elCurrent = document.getElementById('spread-current');
                if (elCurrent) {
                    elCurrent.innerHTML = (chartData.current >= 0 ? '+' : '') + chartData.current.toFixed(2) + '%';
                }

                const elAvg = document.getElementById('spread-avg');
                if (elAvg) {
                    elAvg.innerHTML = (chartData.avg >= 0 ? '+' : '') + chartData.avg.toFixed(2) + '%' +
                        '<span style="font-size:0.75rem; display:block; color:var(--text-muted)">3å¹´å‡å€¼</span>';
                }

                const elMax = document.getElementById('spread-max');
                if (elMax) {
                    elMax.innerHTML = (chartData.max >= 0 ? '+' : '') + chartData.max.toFixed(2) + '%';
                }

                const elMin = document.getElementById('spread-min');
                if (elMin) {
                    elMin.innerHTML = (chartData.min >= 0 ? '+' : '') + chartData.min.toFixed(2) + '%';
                }

            } catch (error) {
                console.error('åŠ è½½ä»·å·®æ•°æ®å¤±è´¥:', error);
                chartDom.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">âš ï¸</div>
                        <div style="color: #ef4444; margin-bottom: 5px;">å›¾è¡¨åŠ è½½å¤±è´¥</div>
                        <div style="font-size: 0.8rem; color: #94a3b8;">${error.message}</div>
                        <div style="font-size: 0.7rem; margin-top: 10px; opacity: 0.5;">è¯·å°è¯•åˆ·æ–°æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
                    </div>
                `;
            }
        }

        function renderSpreadChart(chartDom, data) {
            if (spreadChart) {
                spreadChart.dispose();
            }

            spreadChart = echarts.init(chartDom, 'dark');

            // æ•°æ®å‡†å¤‡
            const dates = data.history.map(item => item.date);
            const sgeSpreads = data.history.map(item => item.spread_sge_pct);
            const gfexSpreads = data.history.map(item => item.spread_gfex_pct); // åŒ…å«null
            const avgLine = data.stats_3y_sge.avg_spread_pct;

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    confine: true,
                    backgroundColor: 'rgba(26, 31, 46, 0.95)',
                    borderColor: '#2d3748',
                    textStyle: { color: '#f0f4f8' },
                    formatter: function (params) {
                        // åªæ˜¾ç¤ºå¹¿æœŸæ‰€
                        const gfex = params.find(x => x.seriesName === 'å¹¿æœŸæ‰€æº¢ä»·');
                        const axisValue = params[0].axisValue;

                        const historyItem = data.history.find(h => h.date === axisValue);
                        let detailHtml = '';
                        if (historyItem) {
                            detailHtml = `
                                <div style="font-size:0.75rem; color:#9ca3af; margin-top:6px; padding-top:6px; border-top:1px solid #374151;">
                                    CMEæŠ˜ç®—: Â¥${historyItem.cme_cny}<br/>
                                    ${historyItem.gfex ? `<span style="color:#ef4444; font-weight:bold">å¹¿æœŸæ‰€: Â¥${historyItem.gfex}</span>` : ''}
                                </div>
                             `;
                        }

                        let html = `${axisValue}<br/>`;
                        if (gfex && gfex.value != null) {
                            html += `${gfex.marker} å¹¿æœŸæ‰€æº¢ä»·: <span style="color:#ef4444; font-weight:bold">+${gfex.value.toFixed(2)}%</span>`;
                        }
                        html += detailHtml;
                        return html;
                    }
                },
                legend: {
                    data: ['å¹¿æœŸæ‰€æº¢ä»·', 'å½“å‰åŸºå·®'],
                    bottom: 0,
                    textStyle: { color: '#94a3b8' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', fontSize: 10 },
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    name: 'æº¢ä»·/åŸºå·® (%)',
                    nameTextStyle: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#2d3748', type: 'dashed' } }
                },
                series: [
                    {
                        name: 'å¹¿æœŸæ‰€æº¢ä»·',
                        type: 'line',
                        data: gfexSpreads,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        connectNulls: true,
                        lineStyle: { color: '#ef4444', width: 3 },
                        itemStyle: { color: '#ef4444' },
                        z: 10,
                        markLine: {
                            data: [
                                {
                                    yAxis: (function () {
                                        const c = parseFloat(document.getElementById('cme-pl-price').value) || 0;
                                        const s = parseFloat(document.getElementById('spot-pl-price').value) || 0;
                                        return s > 0 ? ((c - s) / s) * 100 : 0;
                                    })(),
                                    name: 'å½“å‰åŸºå·®',
                                    label: { formatter: 'åŸºå·® {c}%', position: 'end', color: '#a78bfa' },
                                    lineStyle: { type: 'dotted', color: '#a78bfa', width: 2 }
                                }
                            ],
                            symbol: 'none'
                        }
                    },
                    {
                        name: 'å½“å‰åŸºå·®', // Dummy series for Legend
                        type: 'line',
                        color: '#a78bfa',
                        itemStyle: { color: '#a78bfa' },
                        lineStyle: { type: 'dotted' },
                        data: []
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: (function () {
                            // è‡ªåŠ¨è®¡ç®—æœ‰æ•ˆæ•°æ®èµ·å§‹ç‚¹
                            const idx = gfexSpreads.findIndex(v => v !== null && v !== undefined);
                            if (idx === -1) return 70; // é»˜è®¤
                            // ç¨å¾®å¤šæ˜¾ç¤ºä¸€ç‚¹ä¸Šä¸‹æ–‡ (å¾€å‰æ¨5%)
                            const pct = Math.max(0, (idx / gfexSpreads.length) * 100 - 5);
                            return pct;
                        })(),
                        end: 100
                    },
                    {
                        type: 'slider',
                        start: (function () {
                            const idx = gfexSpreads.findIndex(v => v !== null && v !== undefined);
                            if (idx === -1) return 70;
                            const pct = Math.max(0, (idx / gfexSpreads.length) * 100 - 5);
                            return pct;
                        })(),
                        end: 100,
                        height: 20,
                        bottom: 30,
                        borderColor: '#374151',
                        fillerColor: 'rgba(167, 139, 250, 0.2)'
                    }
                ]
            };

            spreadChart.setOption(option);

            window.addEventListener('resize', () => {
                spreadChart && spreadChart.resize();
            });
        }

        // é€šç”¨ä»·å·®å›¾è¡¨æ¸²æŸ“å‡½æ•° (ç”¨äºé»„é‡‘/ç™½é“¶/é“œ)
        function renderSpreadChartGeneric(chartDom, chartData) {
            if (!chartDom || !chartData || !chartData.dates) {
                console.error('Invalid chart data or DOM');
                return;
            }

            if (spreadChart) {
                try {
                    spreadChart.dispose();
                } catch (e) {
                    console.warn('Chart dispose error:', e);
                }
            }

            spreadChart = echarts.init(chartDom, 'dark');

            const commodityNames = {
                'platinum': 'é“‚é‡‘',
                'palladium': 'é’¯é‡‘',
                'gold': 'é»„é‡‘',
                'silver': 'ç™½é“¶',
                'copper': 'é“œ'
            };

            // æ ¹æ®ç±»å‹é€‰æ‹©æ•°æ®
            const isAbsMode = currentSpreadType === 'abs';
            const displayData = isAbsMode ? (chartData.spreadsAbs || chartData.spreads) : chartData.spreads;
            const unit = isAbsMode ? 'å…ƒ/å…‹' : '%';
            const seriesName = (commodityNames[currentCommodity] || 'ä»·å·®') + (isAbsMode ? 'ä»·å·®' : 'æº¢ä»·');

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    confine: true,
                    backgroundColor: 'rgba(26, 31, 46, 0.95)',
                    borderColor: '#2d3748',
                    textStyle: { color: '#f0f4f8' },
                    formatter: function (params) {
                        const p = params[0];
                        const val = p.value;
                        const formatted = isAbsMode ? val.toFixed(2) + 'å…ƒ/å…‹' : (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
                        return `${p.axisValue}<br/>${p.marker} ${seriesName}: <span style="font-weight:bold;color:${val >= 0 ? '#22c55e' : '#ef4444'}">${val >= 0 ? '+' : ''}${formatted}</span>`;
                    }
                },
                legend: {
                    data: [seriesName],
                    bottom: 0,
                    textStyle: { color: '#94a3b8' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: chartData.dates,
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', fontSize: 10 },
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    name: isAbsMode ? 'ä»·å·® (å…ƒ/å…‹)' : 'ä»·å·® (%)',
                    nameTextStyle: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', formatter: isAbsMode ? '{value}' : '{value}%' },
                    splitLine: { lineStyle: { color: '#2d3748', type: 'dashed' } }
                },
                series: [
                    {
                        name: seriesName,
                        type: 'line',
                        data: displayData,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 3,
                        lineStyle: { color: currentCommodity === 'gold' ? '#fbbf24' : currentCommodity === 'silver' ? '#94a3b8' : currentCommodity === 'copper' ? '#f97316' : '#ef4444', width: 2 },
                        itemStyle: { color: currentCommodity === 'gold' ? '#fbbf24' : currentCommodity === 'silver' ? '#94a3b8' : currentCommodity === 'copper' ? '#f97316' : '#ef4444' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(251, 191, 36, 0.3)' },
                                { offset: 1, color: 'rgba(251, 191, 36, 0)' }
                            ])
                        },
                        markLine: {
                            data: [
                                { yAxis: chartData.avg, name: '3å¹´å‡å€¼', label: { formatter: 'å‡å€¼ {c}%', position: 'end', color: '#a78bfa' }, lineStyle: { type: 'dashed', color: '#a78bfa', width: 1 } },
                                { yAxis: 0, lineStyle: { color: '#374151', width: 1 } }
                            ],
                            symbol: 'none'
                        }
                    }
                ],
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { type: 'slider', start: 0, end: 100, height: 20, bottom: 30, borderColor: '#374151', fillerColor: 'rgba(167, 139, 250, 0.2)' }
                ]
            };

            spreadChart.setOption(option);
        }

        // ========== è‡ªåŠ¨åŠ è½½æœ€æ–°æ•°æ® ==========
        // å…¨å±€å­˜å‚¨ä»·æ ¼æ•°æ®ï¼Œä¾›è®¡ç®—å™¨ä½¿ç”¨
        let pricesData = null;

        async function loadLatestPrices() {
            try {
                const response = await fetch('prices_data.json?t=' + Date.now());
                if (!response.ok) {
                    console.log('prices_data.json not found, using chart data');
                    return;
                }
                const data = await response.json();

                // å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›è®¡ç®—å™¨ä½¿ç”¨
                pricesData = data;

                // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                document.getElementById('data-time').textContent = data.update_time || 'è‡ªåŠ¨æ›´æ–°ä¸­...';

                // æ›´æ–°æ±‡ç‡
                if (data.exchange_rate) {
                    document.getElementById('exchange-rate').textContent = 'USD/CNY = ' + data.exchange_rate.toFixed(2);
                }

                // æ›´æ–°ä»·æ ¼å¡ç‰‡
                if (data.gfex) {
                    const ptGfexEl = document.getElementById('pt-gfex');
                    const pdGfexEl = document.getElementById('pd-gfex');
                    const ptUpdateTimeEl = document.getElementById('pt-update-time');
                    const pdUpdateTimeEl = document.getElementById('pd-update-time');

                    if (ptGfexEl) ptGfexEl.textContent = data.gfex.pt_price.toFixed(2);
                    if (pdGfexEl) pdGfexEl.textContent = data.gfex.pd_price.toFixed(2);

                    // ä½¿ç”¨å¹¿æœŸæ‰€å®é™…è¡Œæƒ…æ—¶é—´ï¼ˆè€Œéè„šæœ¬æ›´æ–°æ—¶é—´ï¼‰
                    const ptTime = data.gfex.pt_time ? '@' + data.gfex.pt_time : '';
                    const pdTime = data.gfex.pd_time ? '@' + data.gfex.pd_time : '';
                    if (ptUpdateTimeEl) ptUpdateTimeEl.textContent = ptTime;
                    if (pdUpdateTimeEl) pdUpdateTimeEl.textContent = pdTime;
                }

                if (data.cme) {
                    const ptIntlEl = document.getElementById('pt-intl');
                    const pdIntlEl = document.getElementById('pd-intl');
                    const ptIntlUsdEl = document.getElementById('pt-intl-usd');
                    const pdIntlUsdEl = document.getElementById('pd-intl-usd');
                    const ptCmeContractEl = document.getElementById('pt-cme-contract');
                    const pdCmeContractEl = document.getElementById('pd-cme-contract');
                    const ptCmeTimeEl = document.getElementById('pt-cme-time');
                    const pdCmeTimeEl = document.getElementById('pd-cme-time');

                    // æ˜¾ç¤ºCME USDä»·æ ¼å’Œæ—¶é—´
                    if (ptIntlUsdEl && data.cme.pt_usd) {
                        ptIntlUsdEl.innerHTML = data.cme.pt_usd.toFixed(2) +
                            ' <span id="pt-cme-time" style="font-size:0.6rem;color:var(--text-muted);">@' + (data.cme.pt_time || '') + '</span>';
                    }
                    if (pdIntlUsdEl && data.cme.pd_usd) {
                        pdIntlUsdEl.innerHTML = data.cme.pd_usd.toFixed(2) +
                            ' <span id="pd-cme-time" style="font-size:0.6rem;color:var(--text-muted);">@' + (data.cme.pd_time || '') + '</span>';
                    }

                    // æ˜¾ç¤ºCME CNYæŠ˜ç®—ä»·æ ¼
                    if (ptIntlEl && data.cme.pt_cny) {
                        ptIntlEl.textContent = data.cme.pt_cny.toFixed(2);
                    }
                    if (pdIntlEl && data.cme.pd_cny) {
                        pdIntlEl.textContent = data.cme.pd_cny.toFixed(2);
                    }

                    // æ˜¾ç¤ºåˆçº¦ä¿¡æ¯
                    if (ptCmeContractEl && data.cme.pt_contract) {
                        ptCmeContractEl.textContent = data.cme.pt_contract;
                    }
                    if (pdCmeContractEl && data.cme.pd_contract) {
                        pdCmeContractEl.textContent = data.cme.pd_contract;
                    }
                }

                if (data.spread) {
                    const ptSpreadEl = document.getElementById('pt-spread');
                    const ptSpreadPctEl = document.getElementById('pt-spread-pct');
                    const pdSpreadEl = document.getElementById('pd-spread');
                    const pdSpreadPctEl = document.getElementById('pd-spread-pct');

                    if (ptSpreadEl) ptSpreadEl.textContent = (data.spread.pt_spread >= 0 ? '+' : '') + data.spread.pt_spread.toFixed(2);
                    if (ptSpreadPctEl) ptSpreadPctEl.textContent = (data.spread.pt_spread_pct >= 0 ? '+' : '') + data.spread.pt_spread_pct.toFixed(2) + '%';
                    if (pdSpreadEl) pdSpreadEl.textContent = (data.spread.pd_spread >= 0 ? '+' : '') + data.spread.pd_spread.toFixed(2);
                    if (pdSpreadPctEl) pdSpreadPctEl.textContent = (data.spread.pd_spread_pct >= 0 ? '+' : '') + data.spread.pd_spread_pct.toFixed(2) + '%';
                }

                // æ›´æ–°å¥—åˆ©è®¡ç®—å™¨çš„å“ç§æ ‡ç­¾æ˜¾ç¤ºä»·æ ¼å’Œæ—¶é—´
                const arbPtPriceEl = document.getElementById('arb-pt-price');
                const arbPdPriceEl = document.getElementById('arb-pd-price');
                if (arbPtPriceEl && data.gfex && data.gfex.pt_price && data.gfex.pt_time) {
                    arbPtPriceEl.textContent = 'Â¥' + data.gfex.pt_price.toFixed(2) + ' @' + data.gfex.pt_time;
                }
                if (arbPdPriceEl && data.gfex && data.gfex.pd_price && data.gfex.pd_time) {
                    arbPdPriceEl.textContent = 'Â¥' + data.gfex.pd_price.toFixed(2) + ' @' + data.gfex.pd_time;
                }

                console.log('ä»·æ ¼æ•°æ®å·²è‡ªåŠ¨æ›´æ–°:', data.update_time);
            } catch (error) {
                console.log('è‡ªåŠ¨åŠ è½½ä»·æ ¼æ•°æ®:', error.message);
            }
        }

        // åˆ·æ–°æ•°æ®æŒ‰é’®
        // åˆ·æ–°æ•°æ®æŒ‰é’®
        // åˆ·æ–°æ•°æ®æŒ‰é’®
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.textContent = 'â³ æ­£åœ¨é‡‡é›†æœ€æ–°æ•°æ®...';
                btn.disabled = true;
            }

            try {
                // 1. è°ƒç”¨APIè§¦å‘åå°æ•°æ®æ›´æ–°
                const updateRes = await fetch('/api/refresh-data', { method: 'POST' });
                if (!updateRes.ok) throw new Error('æ•°æ®æ›´æ–°è¯·æ±‚å¤±è´¥');

                // 2. æ›´æ–°å®Œåé‡è½½é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®
                if (btn) btn.textContent = 'âœ… æ•°æ®å·²æ›´æ–°';
                setTimeout(() => window.location.reload(true), 500);

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                alert('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message);
                if (btn) {
                    btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                    btn.disabled = false;
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        (async function init() {
            // åŠ è½½æœ€æ–°ä»·æ ¼
            await loadLatestPrices();

            // åŠ è½½å›¾è¡¨
            loadSpreadChart();
            loadConvergenceChart();

            // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(async () => {
                await loadLatestPrices();
                loadSpreadChart();
            }, 60000);

            console.log('ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ¯60ç§’è‡ªåŠ¨åˆ·æ–°');
        })();
    </script>
</body>

</html>