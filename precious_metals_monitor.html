<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“‚é’¯è·¨å¸‚åœºå¥—åˆ©ç›‘æ§ | Precious Metals Arbitrage</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-card-hover: #252b3d;
            --border-color: #2d3748;
            --text-primary: #f0f4f8;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-gold: #fbbf24;
            --accent-platinum: #e5e7eb;
            --accent-palladium: #a78bfa;
            --positive: #22c55e;
            --negative: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --gradient-gold: linear-gradient(135deg, #fbbf24, #d97706);
            --gradient-platinum: linear-gradient(135deg, #94a3b8, #64748b);
            --gradient-palladium: linear-gradient(135deg, #a78bfa, #7c3aed);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: var(--gradient-gold);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-platinum));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--positive);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .refresh-btn {
            padding: 10px 20px;
            background: var(--gradient-gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-icon.platinum {
            background: var(--gradient-platinum);
        }

        .card-icon.palladium {
            background: var(--gradient-palladium);
        }

        .card-title h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-title span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Price Display */
        .price-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .price-item {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
        }

        .price-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .price-value.cny {
            color: var(--accent-gold);
        }

        .price-value.usd {
            color: var(--info);
        }

        .price-sub {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Spread Display */
        .spread-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(167, 139, 250, 0.1));
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .spread-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .spread-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .spread-value.positive {
            color: var(--negative);
        }

        .spread-value.negative {
            color: var(--positive);
        }

        .spread-pct {
            font-size: 1.2rem;
            margin-top: 4px;
        }

        .spread-direction {
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* Exchange Rate */
        .exchange-rate {
            text-align: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .exchange-rate span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        /* Trading Rules Section */
        .rules-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .rules-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rules-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .rules-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .rules-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .rules-content.collapsed {
            display: none;
        }

        .rule-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
        }

        .rule-card h4 {
            font-size: 0.9rem;
            color: var(--accent-gold);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rule-card table {
            width: 100%;
            font-size: 0.85rem;
        }

        .rule-card td {
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .rule-card td:first-child {
            color: var(--text-secondary);
        }

        .rule-card td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.2), rgba(251, 191, 36, 0.2));
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .alert-banner.opportunity {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), rgba(59, 130, 246, 0.2));
            border-color: var(--positive);
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-content h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .alert-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Last Update */
        .last-update {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Risk Warning */
        .risk-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .risk-warning h4 {
            color: var(--negative);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-warning ul {
            list-style: none;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .risk-warning li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .risk-warning li::before {
            content: "âš ";
            position: absolute;
            left: 0;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }

            .price-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <style>
        /* Trading Calculator Section */
        .calculator-section {
            background: linear-gradient(135deg, var(--bg-card), #1e293b);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 30px;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.1);
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .calculator-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent-gold);
        }

        .calculator-tabs {
            display: flex;
            gap: 8px;
        }

        .calc-tab {
            padding: 8px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .calc-tab.active {
            background: var(--gradient-gold);
            color: #000;
            border-color: var(--accent-gold);
            font-weight: 600;
        }

        .calculator-body {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .calculator-body {
                grid-template-columns: 1fr;
            }
        }

        .calc-input-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
        }

        .calc-input-group {
            margin-bottom: 20px;
        }

        .calc-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .calc-input-group input,
        .calc-input-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
        }

        .calc-input-group input:focus,
        .calc-input-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .calc-btn {
            width: 100%;
            padding: 14px 20px;
            background: var(--gradient-gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .calc-btn:hover {
            transform: translateY(-2px);
        }

        .calc-result-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .calc-result-section {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--border-color);
        }

        .result-card.margin {
            border-left-color: var(--info);
        }

        .result-card.profit {
            border-left-color: var(--positive);
        }

        .result-card.risk {
            border-left-color: var(--negative);
        }

        .result-card.strategy {
            border-left-color: var(--accent-gold);
        }

        .result-card h4 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-value.gold {
            color: var(--accent-gold);
        }

        .result-value.green {
            color: var(--positive);
        }

        .result-value.red {
            color: var(--negative);
        }

        .result-value.blue {
            color: var(--info);
        }

        .result-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .strategy-box {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(167, 139, 250, 0.15));
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .strategy-box h4 {
            color: var(--accent-gold);
            margin-bottom: 16px;
            font-size: 0.95rem;
        }

        .strategy-steps {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 700px) {
            .strategy-steps {
                grid-template-columns: 1fr;
            }
        }

        .strategy-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: var(--gradient-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .step-content strong {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .step-content span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .risk-meter {
            margin-top: 12px;
        }

        .risk-bar {
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .risk-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .risk-fill.low {
            background: var(--positive);
            width: 30%;
        }

        .risk-fill.medium {
            background: var(--warning);
            width: 60%;
        }

        .risk-fill.high {
            background: var(--negative);
            width: 90%;
        }

        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">ğŸ’</div>
                <div class="header-title">
                    <h1>é“‚é’¯è·¨å¸‚åœºå¥—åˆ©ç›‘æ§</h1>
                    <p>å¹¿æœŸæ‰€ vs å›½é™…å¸‚åœº å®æ—¶ä»·å·®åˆ†æ</p>
                </div>
            </div>
            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="market-status">å¸‚åœºå¼€æ”¾</span>
                </div>
                <button class="refresh-btn" onclick="refreshData()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>
        </header>

        <!-- Alert Banner -->
        <div class="alert-banner" id="alert-banner">
            <div class="alert-icon">ğŸ”´</div>
            <div class="alert-content">
                <h4>å¹¿æœŸæ‰€æº¢ä»·è¾ƒå¤§</h4>
                <p>å½“å‰é“‚é‡‘å’Œé’¯é‡‘åœ¨å¹¿æœŸæ‰€çš„ä»·æ ¼æ˜¾è‘—é«˜äºå›½é™…å¸‚åœºï¼Œæº¢ä»·è¶…è¿‡20%ã€‚ç†è®ºå¥—åˆ©æ–¹å‘ï¼šåšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…å¸‚åœºã€‚</p>
            </div>
        </div>

        <!-- Exchange Rate & Auto Update Status -->
        <div class="exchange-rate" style="display: flex; flex-wrap: wrap; align-items: center; gap: 16px;">
            <div>ğŸ“Š æ±‡ç‡: <span id="exchange-rate">USD/CNY = 7.04</span></div>
            <div>ğŸ“… <span id="data-time">è‡ªåŠ¨æ›´æ–°ä¸­...</span></div>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.75rem; color: var(--positive);">ğŸŸ¢ è‡ªåŠ¨åˆ·æ–°æ¯10åˆ†é’Ÿ</span>
            </div>
        </div>

        <!-- Price Cards -->
        <div class="dashboard-grid">
            <!-- Platinum Card -->
            <div class="card" id="platinum-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon platinum">Pt</div>
                        <div>
                            <h3>é“‚é‡‘ Platinum</h3>
                            <span id="pt-contract-info">PT2610 | PLV2026 (2026å¹´10æœˆ)</span>
                        </div>
                    </div>
                </div>

                <div class="price-grid">
                    <div class="price-item">
                        <div class="price-label">å¹¿æœŸæ‰€ PT2610</div>
                        <div class="price-value cny" id="pt-gfex">657.65</div>
                        <div class="price-sub">å…ƒ/å…‹ <span id="pt-gfex-time"
                                style="color:var(--text-muted);font-size:0.7rem;"></span></div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">å›½é™…ä»·æ ¼å¯¹æ¯” (USD/oz)</div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 0.8rem; color: var(--text-muted);">CME <span
                                    id="pt-cme-contract">PLV2026</span></span>
                            <span class="price-value usd" style="font-size: 1rem;" id="pt-intl-usd">2357.40 <span
                                    id="pt-cme-time" style="font-size:0.65rem;color:var(--text-muted);"></span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: var(--text-muted);">Bybitç°è´§</span>
                            <span class="price-value usd" style="font-size: 1rem; color: var(--text-secondary);"
                                id="pt-spot-usd-display">2350.00</span>
                        </div>
                        <div class="price-sub"
                            style="margin-top: 6px; text-align: right; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 4px;">
                            CMEæŠ˜ç®—: Â¥<span id="pt-intl">533.58</span>/å…‹
                            <span id="pt-cme-time"
                                style="display:block;color:var(--text-muted);font-size:0.65rem;"></span>
                        </div>
                    </div>
                </div>

                <div class="spread-section">
                    <div class="spread-label">ä»·å·® (å¹¿æœŸæ‰€ - å›½é™…)</div>
                    <div class="spread-value positive" id="pt-spread">+124.07</div>
                    <div class="spread-pct positive" id="pt-spread-pct">+23.25%</div>
                    <div class="spread-direction" id="pt-direction">
                        ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…
                    </div>
                </div>
            </div>

            <!-- Palladium Card -->
            <div class="card" id="palladium-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon palladium">Pd</div>
                        <div>
                            <h3>é’¯é‡‘ Palladium</h3>
                            <span id="pd-contract-info">PD2606 | PAM2026 (2026å¹´6æœˆ)</span>
                        </div>
                    </div>
                </div>

                <div class="price-grid">
                    <div class="price-item">
                        <div class="price-label">å¹¿æœŸæ‰€ PD2606</div>
                        <div class="price-value cny" id="pd-gfex">578.25</div>
                        <div class="price-sub">å…ƒ/å…‹ <span id="pd-gfex-time"
                                style="color:var(--text-muted);font-size:0.7rem;"></span></div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">å›½é™…ä»·æ ¼å¯¹æ¯” (USD/oz)</div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 0.8rem; color: var(--text-muted);">CME <span
                                    id="pd-cme-contract">PAM2026</span></span>
                            <span class="price-value usd" style="font-size: 1rem;" id="pd-intl-usd">1923.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: var(--text-muted);">Bybitç°è´§</span>
                            <span class="price-value usd" style="font-size: 1rem; color: var(--text-secondary);"
                                id="pd-spot-usd-display">1915.00</span>
                        </div>
                        <div class="price-sub"
                            style="margin-top: 6px; text-align: right; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 4px;">
                            CMEæŠ˜ç®—: Â¥<span id="pd-intl">435.25</span>/å…‹
                            <span id="pd-cme-time"
                                style="display:block;color:var(--text-muted);font-size:0.65rem;"></span>
                        </div>
                    </div>
                </div>

                <div class="spread-section">
                    <div class="spread-label">ä»·å·® (å¹¿æœŸæ‰€ - å›½é™…)</div>
                    <div class="spread-value positive" id="pd-spread">+143.00</div>
                    <div class="spread-pct positive" id="pd-spread-pct">+32.85%</div>
                    <div class="spread-direction" id="pd-direction">
                        ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²ä»·å·®èµ°åŠ¿å›¾ -->
        <div class="spread-chart-section"
            style="margin: 20px auto; max-width: 1200px; background: var(--bg-card); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸ“ˆ å†å²ä»·å·®èµ°åŠ¿ (è¿‘3å¹´)
                    <span id="chart-subtitle"
                        style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal;">å›½å†… vs å›½é™…</span>
                </h3>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <!-- å“ç§åˆ‡æ¢æ ‡ç­¾ -->
                    <div id="commodity-tabs"
                        style="display: flex; gap: 4px; background: var(--bg-secondary); padding: 3px; border-radius: 8px;">
                        <button onclick="switchCommodity('platinum')" id="tab-platinum" class="commodity-tab active"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: var(--accent-gold); color: #000;">é“‚é‡‘</button>
                        <button onclick="switchCommodity('palladium')" id="tab-palladium" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">é’¯é‡‘</button>
                        <button onclick="switchCommodity('gold')" id="tab-gold" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">é»„é‡‘</button>
                        <button onclick="switchCommodity('silver')" id="tab-silver" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">ç™½é“¶</button>
                        <button onclick="switchCommodity('copper')" id="tab-copper" class="commodity-tab"
                            style="padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; background: transparent; color: var(--text-muted);">é“œ</button>
                    </div>
                    <button onclick="loadSpreadChart()"
                        style="padding: 6px 12px; background: var(--accent-gold); border: none; border-radius: 6px; color: #000; cursor: pointer; font-size: 0.8rem;">
                        åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
            <div id="spread-chart" style="width: 100%; height: 400px;"></div>
            <div id="spread-stats"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">å½“å‰æº¢ä»·</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--positive);" id="spread-current">+5.90%
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">3å¹´å‡å€¼</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-gold);" id="spread-avg">+5.10%
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">3å¹´æœ€é«˜</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--warning);" id="spread-max">+19.66%
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">3å¹´æœ€ä½</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--info);" id="spread-min">-3.23%</div>
                </div>
            </div>
            <div id="risk-warning-banner"
                style="margin-top: 12px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--negative); display: none;">
                <div id="risk-warning-text" style="font-size: 0.85rem; color: var(--text-secondary);">
                    <!-- åŠ¨æ€åŠ è½½å†…å®¹ -->
                </div>
            </div>
        </div>

        <!-- åˆçº¦æ”¶æ•›åˆ†æå›¾è¡¨ -->
        <div class="convergence-section"
            style="margin: 20px auto; max-width: 1200px; background: var(--bg-card); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    ğŸ“‰ åˆçº¦æ”¶æ•›åˆ†æ
                    <span
                        style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal;">ç‰¹å®šäº¤å‰²åˆçº¦ä»ä¸Šå¸‚åˆ°äº¤å‰²çš„ä»·å·®èµ°åŠ¿</span>
                </h3>
                <button onclick="loadConvergenceChart()"
                    style="padding: 6px 12px; background: var(--accent-gold); border: none; border-radius: 6px; color: #000; cursor: pointer; font-size: 0.8rem;">
                    åˆ·æ–°æ•°æ®
                </button>
            </div>
            <!-- åˆçº¦é€‰æ‹©æŒ‰é’® -->
            <div id="convergence-tabs" style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="convergence-chart" style="width: 100%; height: 400px;"></div>
            <div id="convergence-stats"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 16px;">
                <!-- åŠ¨æ€åŠ è½½ç»Ÿè®¡ -->
            </div>
        </div>

        <!-- Trading Calculator -->
        <div class="calculator-section" id="calculator">
            <div class="calculator-header">
                <h2>ğŸ§® å¥—åˆ©äº¤æ˜“è®¡ç®—å™¨</h2>
                <div class="calculator-tabs">
                    <button class="calc-tab" onclick="selectMetal('PT')" id="tab-pt">
                        é“‚é‡‘ PT <span id="arb-pt-price"
                            style="font-size:0.75rem;color:var(--text-muted);margin-left:4px;"></span>
                    </button>
                    <button class="calc-tab active" onclick="selectMetal('PD')" id="tab-pd">
                        é’¯é‡‘ PD <span id="arb-pd-price"
                            style="font-size:0.75rem;color:var(--text-muted);margin-left:4px;"></span>
                    </button>
                </div>
            </div>

            <div class="calculator-body">
                <!-- Input Section -->
                <div class="calc-input-section">
                    <div class="calc-input-group">
                        <label>ğŸ“Š äº¤æ˜“æ‰‹æ•° (å¹¿æœŸæ‰€)</label>
                        <input type="number" id="calc-lots" value="3" min="1" max="500" onchange="calculateArbitrage()">
                        <div class="input-hint" style="margin-top: 4px; font-size: 0.75rem; color: var(--text-muted);">
                            1æ‰‹ = 1000å…‹ | é’¯é‡‘å»ºè®®3æ‰‹èµ· | é“‚é‡‘å»ºè®®2æ‰‹èµ·
                        </div>
                    </div>

                    <!-- å¯¹å†²å¹³å°é€‰æ‹© -->
                    <div class="calc-input-group">
                        <label>ğŸŒ å¯¹å†²å¹³å°</label>
                        <select id="calc-hedge-platform" onchange="updateHedgePlatform()">
                            <option value="cme" selected>CMEäº¤å‰²åˆçº¦ (æ¨è)</option>
                            <option value="bybit">Bybit MT5 æ°¸ç»­CFD</option>
                        </select>
                        <div class="input-hint" id="hedge-platform-hint"
                            style="margin-top: 4px; font-size: 0.75rem; color: var(--text-muted);">
                            CME: åŒæ—¶åˆ°æœŸï¼Œå¼ºåˆ¶æ”¶æ•› | Bybit: é—¨æ§›ä½ï¼Œæ— åˆ°æœŸæ—¥
                        </div>
                    </div>

                    <div class="calc-input-group">
                        <label>ğŸ¯ é¢„æœŸä»·å·®æ”¶æ•›æ¯”ä¾‹</label>
                        <select id="calc-convergence" onchange="calculateArbitrage()">
                            <option value="0.5">50% (æå‰å¹³ä»“)</option>
                            <option value="0.75">75% (æ¥è¿‘åˆ°æœŸ)</option>
                            <option value="1.0" selected>100% (åˆ°æœŸäº¤å‰²)</option>
                        </select>
                        <div class="input-hint" style="margin-top: 4px; font-size: 0.75rem; color: var(--text-muted);">
                            é¢„æœŸä¸¤å¸‚åœºä»·å·®æ”¶çª„çš„ç¨‹åº¦
                        </div>
                    </div>
                    <div class="calc-input-group">
                        <label>â±ï¸ æŒä»“å‘¨æœŸ</label>
                        <select id="calc-period">
                            <option value="7">1å‘¨</option>
                            <option value="30" selected>1ä¸ªæœˆ</option>
                            <option value="90">3ä¸ªæœˆ</option>
                            <option value="180">6ä¸ªæœˆ (åˆ°æœŸäº¤å‰²)</option>
                        </select>
                    </div>
                    <button class="calc-btn" onclick="calculateArbitrage()">
                        ğŸ“ˆ è®¡ç®—å¥—åˆ©æ–¹æ¡ˆ
                    </button>
                </div>

                <!-- Result Section -->
                <div class="calc-result-section" id="calc-results">
                    <!-- æŒä»“æ˜ç»† -->
                    <div class="result-card"
                        style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(34, 197, 94, 0.1)); border-left-color: var(--accent-gold); padding: 16px;">
                        <h4 style="margin-bottom: 12px;">ğŸ“‹ æŒä»“æ˜ç»†</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <!-- å¹¿æœŸæ‰€åšç©º -->
                            <div
                                style="background: rgba(239, 68, 68, 0.15); padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                    <span
                                        style="background: var(--negative); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">åšç©º
                                        SELL</span>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">å¹¿æœŸæ‰€</span>
                                </div>
                                <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary);"
                                    id="gfex-position">PD2606 Ã— 3æ‰‹</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                    åˆçº¦ä»·å€¼: <span style="color: var(--accent-gold);"
                                        id="gfex-contract-value">Â¥1,734,750</span>
                                    Â· ä¿è¯é‡‘: <span style="color: var(--info);" id="result-gfex-margin">Â¥208,170</span>
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;"
                                    id="gfex-grams">
                                    = 3,000å…‹
                                </div>
                            </div>
                            <!-- å¯¹å†²åšå¤š -->
                            <div id="hedge-position-card"
                                style="background: rgba(34, 197, 94, 0.15); padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                    <span
                                        style="background: var(--positive); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">åšå¤š
                                        BUY</span>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);"
                                        id="hedge-platform-name">CME NYMEX</span>
                                    <span id="hedge-contract-type"
                                        style="font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; background: var(--info); color: #fff;">äº¤å‰²</span>
                                </div>
                                <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary);"
                                    id="hedge-position">PA 2606 Ã— 1æ‰‹</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;"
                                    id="hedge-position-detail">= 3,110å…‹ âœ“</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                    åˆçº¦ä»·å€¼: <span style="color: var(--accent-gold);"
                                        id="hedge-contract-value">â‰ˆÂ¥695,552</span>
                                    Â· ä¿è¯é‡‘: <span style="color: var(--info);" id="result-hedge-margin">â‰ˆÂ¥105,600</span>
                                </div>
                            </div>
                        </div>
                        <!-- èµ„é‡‘æ±‡æ€» -->
                        <div
                            style="padding: 10px 14px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                            <span style="color: var(--text-muted); font-size: 0.8rem;">æ€»ä¿è¯é‡‘éœ€æ±‚:</span>
                            <span class="result-value gold" id="result-total-margin"
                                style="font-size: 1.2rem; margin-left: 6px;">Â¥174,990</span>
                        </div>
                    </div>

                    <!-- é¢„æœŸæ”¶ç›Š -->
                    <div class="result-card profit">
                        <h4>é¢„æœŸæ¯›æ”¶ç›Š <span style="font-size: 0.7rem; color: var(--warning);">ï¼ˆè‹¥ä»·å·®æ”¶æ•›ï¼‰</span></h4>
                        <div style="display: flex; align-items: baseline; gap: 12px;">
                            <div class="result-value green" id="result-gross-profit">Â¥62,035</div>
                            <div style="font-size: 1rem; color: var(--positive);" id="result-return-rate">+55%</div>
                        </div>
                        <div class="result-sub" id="gross-profit-detail">ä»·å·®124å…ƒ/å…‹ Ã— 50%æ”¶æ•› Ã— 1000å…‹</div>
                    </div>
                    <div class="result-card profit">
                        <h4>æ‰£é™¤æˆæœ¬åå‡€æ”¶ç›Š</h4>
                        <div class="result-value green" id="result-net-profit">Â¥61,050</div>
                        <div class="result-sub" id="net-profit-detail">æ¯›æ”¶ç›Š - æ‰‹ç»­è´¹</div>
                    </div>

                    <!-- é£é™©è¯„ä¼° -->
                    <div class="result-card risk">
                        <h4>æœ€å¤§äºæŸ (ä»·å·®æ‰©å¤§20%)</h4>
                        <div class="result-value red" id="result-max-loss">-Â¥24,807</div>
                        <div class="result-sub">è‹¥ä»·å·®ç»§ç»­æ‰©å¤§è€Œéæ”¶æ•›</div>
                    </div>
                    <div class="result-card">
                        <h4>æ”¶ç›Šé£é™©æ¯”</h4>
                        <div class="result-value gold" id="result-risk-ratio">2.5:1</div>
                        <div class="result-sub">é¢„æœŸæ”¶ç›Š / æœ€å¤§äºæŸ</div>
                    </div>


                    <!-- Risk Analysis: Exposure & Liquidation -->
                    <div class="result-card" style="grid-column: 1 / -1; border-left-color: var(--negative);">
                        <h4 style="display: flex; align-items: center; gap: 6px;">
                            ğŸ›¡ï¸ é£é™©æ·±åº¦åˆ†æ <span
                                style="font-size: 0.7rem; color: var(--text-muted); font-weight: normal;">(åŸºäºå½“å‰æŒä»“)</span>
                        </h4>

                        <!-- Exposure Risk (Full Width) -->
                        <div style="margin-top: 10px; margin-bottom: 12px;">
                            <div
                                style="background: var(--bg-primary); padding: 12px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">âš–ï¸
                                        æ•°é‡æ•å£é£é™© (å‡€å¤´å¯¸)</div>
                                    <div style="display: flex; align-items: baseline; gap: 8px;">
                                        <span id="risk-exposure-val"
                                            style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary);">--</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">æ³¢åŠ¨æ•æ„Ÿåº¦ (1%)</div>
                                    <div style="font-size: 0.9rem; color: var(--warning); font-weight:500; margin-top: 2px;"
                                        id="risk-exposure-pnl">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Capital Allocation -->
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border-color);">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 0.85rem; color: var(--text-primary); font-weight: 600;">ğŸ’°
                                        èµ„é‡‘åˆ†é…å»ºè®®</label>
                                    <span style="font-size: 0.7rem; color: var(--text-muted);">(å¹³è¡¡åŒè¾¹çˆ†ä»“é£é™©)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">æ€»èµ„é‡‘(Â¥):</span>
                                    <input type="number" id="calc-total-capital" value="500000" step="10000"
                                        onchange="calculateArbitrage()"
                                        style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 6px; border-radius: 4px; width: 80px; font-size: 0.8rem;">
                                </div>
                            </div>
                            <!-- CMEåå‘æ»‘å— -->
                            <div
                                style="margin: 10px 0; padding: 10px; background: var(--bg-primary); border-radius: 6px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 0.8rem; color: var(--text-muted);">CMEåˆ†é…æ¯”ä¾‹:</span>
                                    <span id="cme-ratio-display"
                                        style="font-size: 0.9rem; font-weight: 600; color: var(--info);">60%</span>
                                </div>
                                <input type="range" id="cme-ratio-slider" min="30" max="90" value="60" step="5"
                                    oninput="updateCmeRatioDisplay(); calculateArbitrage();"
                                    style="width: 100%; cursor: pointer; accent-color: var(--info);">
                                <div
                                    style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">
                                    <span>â† åå‘å¹¿æœŸæ‰€</span>
                                    <span>åå‘CME â†’</span>
                                </div>
                            </div>
                            <div id="allocation-result"
                                style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 10px; font-size: 0.8rem; color: var(--text-secondary);">
                                <!-- Dynamic Result -->
                            </div>
                        </div>
                    </div>

                    <!-- ç­–ç•¥å»ºè®® -->
                    <div class="strategy-box">
                        <h4>ğŸ“‹ äº¤æ˜“æ‰§è¡Œæ­¥éª¤</h4>
                        <div class="strategy-steps">
                            <div class="strategy-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>å¹¿æœŸæ‰€å¼€ç©ºä»“</strong>
                                    <span id="step1-detail">å–å‡º PT2606 1æ‰‹ @ 657.65å…ƒ/å…‹</span>
                                </div>
                            </div>
                            <div class="strategy-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>Bybitå¼€å¤šä»“</strong>
                                    <span id="step2-detail">ä¹°å…¥ XPT/USD 32.17ç›å¸ @ $2357</span>
                                </div>
                            </div>
                            <div class="strategy-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>æŒä»“è§‚å¯Ÿ</strong>
                                    <span>ç­‰å¾…ä»·å·®æ”¶æ•›æˆ–è¾¾åˆ°æ­¢ç›ˆ/æ­¢æŸç‚¹</span>
                                </div>
                            </div>
                            <div class="strategy-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>åŒæ—¶å¹³ä»“</strong>
                                    <span>ä¸¤è¾¹åŒæ—¶å¹³ä»“é”å®šæ”¶ç›Š</span>
                                </div>
                            </div>
                        </div>

                        <div class="risk-meter">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 0.85rem;">é£é™©ç­‰çº§:</span>
                                <span style="font-size: 0.85rem; color: var(--warning);" id="risk-level">âš ï¸ ä¸­é«˜é£é™©</span>
                            </div>
                            <div class="risk-bar">
                                <div class="risk-fill medium" id="risk-bar-fill"></div>
                            </div>
                            <div class="risk-labels">
                                <span>ä½</span>
                                <span>ä¸­</span>
                                <span>é«˜</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Rules -->
        <div class="rules-section">
            <div class="rules-header" onclick="toggleRules()">
                <h2>ğŸ“‹ å¹¿æœŸæ‰€äº¤æ˜“è§„åˆ™ (2025å¹´12æœˆæœ€æ–°)</h2>
                <span class="rules-toggle" id="rules-toggle">â–¼</span>
            </div>
            <div class="rules-content" id="rules-content">
                <!-- åˆçº¦è§„æ ¼ -->
                <div class="rule-card">
                    <h4>ğŸ“œ åˆçº¦è§„æ ¼</h4>
                    <table>
                        <tr>
                            <td>äº¤æ˜“å•ä½</td>
                            <td>1000å…‹/æ‰‹</td>
                        </tr>
                        <tr>
                            <td>æœ€å°å˜åŠ¨ä»·ä½</td>
                            <td>0.05å…ƒ/å…‹</td>
                        </tr>
                        <tr>
                            <td>åˆçº¦æœˆä»½</td>
                            <td>2/4/6/8/10/12æœˆ</td>
                        </tr>
                        <tr>
                            <td>æœ€åäº¤æ˜“æ—¥</td>
                            <td>åˆçº¦æœˆä»½ç¬¬10ä¸ªäº¤æ˜“æ—¥</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æ–¹å¼</td>
                            <td>å®ç‰©äº¤å‰²</td>
                        </tr>
                    </table>
                </div>

                <!-- äº¤æ˜“æ—¶é—´ -->
                <div class="rule-card">
                    <h4>â° äº¤æ˜“æ—¶é—´</h4>
                    <table>
                        <tr>
                            <td>ç¬¬ä¸€èŠ‚</td>
                            <td>09:00 - 10:15</td>
                        </tr>
                        <tr>
                            <td>ç¬¬äºŒèŠ‚</td>
                            <td>10:30 - 11:30</td>
                        </tr>
                        <tr>
                            <td>ç¬¬ä¸‰èŠ‚</td>
                            <td>13:30 - 15:00</td>
                        </tr>
                        <tr>
                            <td>å¤œç›˜</td>
                            <td>å¾…å…¬å¸ƒ</td>
                        </tr>
                    </table>
                </div>

                <!-- ä¿è¯é‡‘ä¸è´¹ç”¨ -->
                <div class="rule-card">
                    <h4>ğŸ’° ä¿è¯é‡‘ä¸æ‰‹ç»­è´¹ (12/25èµ·)</h4>
                    <table>
                        <tr>
                            <td>äº¤æ˜“ä¿è¯é‡‘</td>
                            <td>12%</td>
                        </tr>
                        <tr>
                            <td>æ¶¨è·Œåœæ¿</td>
                            <td>Â±10%</td>
                        </tr>
                        <tr>
                            <td>äº¤æ˜“æ‰‹ç»­è´¹</td>
                            <td>ä¸‡åˆ†ä¹‹2.5</td>
                        </tr>
                        <tr>
                            <td>å¹³ä»Šä»“æ‰‹ç»­è´¹</td>
                            <td>ä¸‡åˆ†ä¹‹2.5</td>
                        </tr>
                    </table>
                </div>

                <!-- æŒä»“é™é¢ -->
                <div class="rule-card">
                    <h4>ğŸ“Š æŒä»“é™é¢</h4>
                    <table>
                        <tr>
                            <td>å•æ—¥å¼€ä»“é™é¢</td>
                            <td>500æ‰‹/åˆçº¦</td>
                        </tr>
                        <tr>
                            <td>ä¸€èˆ¬æœˆä»½(PT)</td>
                            <td>600æ‰‹</td>
                        </tr>
                        <tr>
                            <td>ä¸€èˆ¬æœˆä»½(PD)</td>
                            <td>300æ‰‹</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æœˆ(PT)</td>
                            <td>60æ‰‹</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æœˆ(PD)</td>
                            <td>30æ‰‹</td>
                        </tr>
                    </table>
                </div>

                <!-- Bybit CFDå¯¹æ¯” -->
                <div class="rule-card">
                    <h4>ğŸŒ Bybit CFD å¯¹æ¯”</h4>
                    <table>
                        <tr>
                            <td>äº¤æ˜“å“ç§</td>
                            <td>XPT/USD, XPD/USD</td>
                        </tr>
                        <tr>
                            <td>æœ€å°äº¤æ˜“é‡</td>
                            <td>0.01æ‰‹ (1ç›å¸)</td>
                        </tr>
                        <tr>
                            <td>æ æ†</td>
                            <td>æœ€é«˜200x</td>
                        </tr>
                        <tr>
                            <td>ç‚¹å·®</td>
                            <td>æµ®åŠ¨ ~$5-10</td>
                        </tr>
                        <tr>
                            <td>äº¤å‰²æ–¹å¼</td>
                            <td>ç°é‡‘ç»“ç®—</td>
                        </tr>
                    </table>
                </div>

                <!-- å¥—åˆ©æˆæœ¬ -->
                <div class="rule-card">
                    <h4>ğŸ’¸ å¥—åˆ©æˆæœ¬ä¼°ç®—</h4>
                    <table>
                        <tr>
                            <td>å¹¿æœŸæ‰€æ‰‹ç»­è´¹</td>
                            <td>~0.025%</td>
                        </tr>
                        <tr>
                            <td>Bybitç‚¹å·®</td>
                            <td>~0.05%</td>
                        </tr>
                        <tr>
                            <td>æ»‘ç‚¹ä¼°è®¡</td>
                            <td>~0.05%</td>
                        </tr>
                        <tr>
                            <td>æ±‡ç‡æ³¢åŠ¨é£é™©</td>
                            <td>ä¸ç¡®å®š</td>
                        </tr>
                        <tr style="color: var(--accent-gold); font-weight: 600;">
                            <td>æ€»æˆæœ¬</td>
                            <td>~0.15%</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Risk Warning -->
        <div class="risk-warning">
            <h4>âš ï¸ é£é™©æç¤º</h4>
            <ul>
                <li>å¹¿æœŸæ‰€æ˜¯å®ç‰©äº¤å‰²æœŸè´§ï¼ŒBybitæ˜¯ç°é‡‘ç»“ç®—CFDï¼Œä¸¤è€…æœ¬è´¨ä¸åŒ</li>
                <li>ä»·å·®å¯èƒ½é•¿æœŸå­˜åœ¨ï¼Œå› ä¸ºä¸¤ä¸ªå¸‚åœºå®Œå…¨éš”ç¦»æ— æ³•ç›´æ¥å¥—åˆ©æ”¶æ•›</li>
                <li>å¹¿æœŸæ‰€æœ‰æ¶¨è·Œåœæ¿å’ŒæŒä»“é™åˆ¶ï¼Œå¯èƒ½æ— æ³•åŠæ—¶å¹³ä»“</li>
                <li>æ±‡ç‡æ³¢åŠ¨ä¼šå½±å“å¥—åˆ©æ”¶ç›Š</li>
                <li>å½“å‰å·¨å¤§æº¢ä»·å¯èƒ½åæ˜ å›½å†…å¸‚åœºçœŸå®ä¾›éœ€ï¼Œè€Œéå¥—åˆ©æœºä¼š</li>
                <li>å¹¿æœŸæ‰€é“‚é’¯æœŸè´§åˆšä¸Šå¸‚ä¸åˆ°1ä¸ªæœˆï¼ŒæµåŠ¨æ€§å¯èƒ½ä¸è¶³</li>
            </ul>
        </div>

        <!-- Last Update -->
        <div class="last-update">
            ä¸Šæ¬¡æ›´æ–°: <span id="last-update">--</span> |
            æ•°æ®æ¥æº: æ–°æµªæœŸè´§ (å¹¿æœŸæ‰€å»¶è¿Ÿ15-20åˆ†é’Ÿ) + å›½é™…å¸‚åœºå…¬å¼€æ•°æ®
        </div>
    </div>

    <script>
        // å¸¸é‡
        const OZ_TO_GRAM = 31.1035;

        // æ•°æ®çŠ¶æ€
        let marketData = {
            gfex: {
                PT2606: null,
                PD2606: null
            },
            intl: {
                XPT: null,
                XPD: null
            },
            exchangeRate: 7.04,
            lastUpdate: null
        };

        // è·å–å¹¿æœŸæ‰€æ•°æ® (é€šè¿‡æ–°æµª)
        async function fetchGFEXPrice() {
            const symbols = ['PT2606', 'PD2606'];
            const results = {};

            for (const symbol of symbols) {
                try {
                    // ä½¿ç”¨ CORS ä»£ç†æˆ–ç›´æ¥è¯·æ±‚
                    // æ³¨æ„: æµè§ˆå™¨ç›´æ¥è¯·æ±‚å¯èƒ½æœ‰CORSé—®é¢˜ï¼Œéœ€è¦åç«¯ä»£ç†
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://hq.sinajs.cn/list=nf_${symbol}`)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();

                    if (data.contents) {
                        const match = data.contents.match(/"([^"]+)"/);
                        if (match && match[1]) {
                            const parts = match[1].split(',');
                            if (parts.length > 3 && parts[3]) {
                                results[symbol] = parseFloat(parts[3]);
                            }
                        }
                    }
                } catch (error) {
                    console.error(`è·å–${symbol}å¤±è´¥:`, error);
                }
            }

            return results;
        }

        // è·å–æ±‡ç‡
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                return data.rates.CNY || 7.04;
            } catch (error) {
                console.error('è·å–æ±‡ç‡å¤±è´¥:', error);
                return 7.04;
            }
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleString('zh-CN');
            document.getElementById('data-time').textContent = now.toLocaleString('zh-CN');
            document.getElementById('exchange-rate').textContent = `USD/CNY = ${marketData.exchangeRate.toFixed(4)}`;

            // å›½é™…ä»·æ ¼ (ä½¿ç”¨æœ€æ–°æŸ¥è¯¢åˆ°çš„æ•°æ®)
            const intlPrices = {
                XPT: 2357.40,  // é“‚é‡‘ USD/oz
                XPD: 1923.00   // é’¯é‡‘ USD/oz
            };

            // æ›´æ–°é“‚é‡‘
            if (marketData.gfex.PT2606) {
                const ptGfex = marketData.gfex.PT2606;
                const ptIntlUsd = intlPrices.XPT;
                const ptIntlCny = ptIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
                const ptSpread = ptGfex - ptIntlCny;
                const ptSpreadPct = (ptSpread / ptIntlCny) * 100;

                document.getElementById('pt-gfex').textContent = ptGfex.toFixed(2);
                document.getElementById('pt-intl').textContent = ptIntlCny.toFixed(2);
                document.getElementById('pt-intl-usd').textContent = ptIntlUsd.toFixed(2);
                document.getElementById('pt-spread').textContent = (ptSpread >= 0 ? '+' : '') + ptSpread.toFixed(2);
                document.getElementById('pt-spread-pct').textContent = (ptSpreadPct >= 0 ? '+' : '') + ptSpreadPct.toFixed(2) + '%';

                // æ›´æ–°æ ·å¼
                const ptSpreadEl = document.getElementById('pt-spread');
                const ptSpreadPctEl = document.getElementById('pt-spread-pct');
                const ptDirectionEl = document.getElementById('pt-direction');

                if (ptSpread >= 0) {
                    ptSpreadEl.className = 'spread-value positive';
                    ptSpreadPctEl.className = 'spread-pct positive';
                    ptDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
                } else {
                    ptSpreadEl.className = 'spread-value negative';
                    ptSpreadPctEl.className = 'spread-pct negative';
                    ptDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
                }
            }

            // æ›´æ–°é’¯é‡‘
            if (marketData.gfex.PD2606) {
                const pdGfex = marketData.gfex.PD2606;
                const pdIntlUsd = intlPrices.XPD;
                const pdIntlCny = pdIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
                const pdSpread = pdGfex - pdIntlCny;
                const pdSpreadPct = (pdSpread / pdIntlCny) * 100;

                document.getElementById('pd-gfex').textContent = pdGfex.toFixed(2);
                document.getElementById('pd-intl').textContent = pdIntlCny.toFixed(2);
                document.getElementById('pd-intl-usd').textContent = pdIntlUsd.toFixed(2);
                document.getElementById('pd-spread').textContent = (pdSpread >= 0 ? '+' : '') + pdSpread.toFixed(2);
                document.getElementById('pd-spread-pct').textContent = (pdSpreadPct >= 0 ? '+' : '') + pdSpreadPct.toFixed(2) + '%';

                // æ›´æ–°æ ·å¼
                const pdSpreadEl = document.getElementById('pd-spread');
                const pdSpreadPctEl = document.getElementById('pd-spread-pct');
                const pdDirectionEl = document.getElementById('pd-direction');

                if (pdSpread >= 0) {
                    pdSpreadEl.className = 'spread-value positive';
                    pdSpreadPctEl.className = 'spread-pct positive';
                    pdDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
                } else {
                    pdSpreadEl.className = 'spread-value negative';
                    pdSpreadPctEl.className = 'spread-pct negative';
                    pdDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
                }
            }

            // æ›´æ–°å‘Šè­¦
            updateAlert();
        }

        // æ›´æ–°å‘Šè­¦
        function updateAlert() {
            const alertBanner = document.getElementById('alert-banner');
            const ptGfex = marketData.gfex.PT2606 || 0;
            const pdGfex = marketData.gfex.PD2606 || 0;

            // ç®€å•åˆ¤æ–­æº¢ä»·æƒ…å†µ
            const ptIntlCny = 2357.40 * marketData.exchangeRate / OZ_TO_GRAM;
            const pdIntlCny = 1923.00 * marketData.exchangeRate / OZ_TO_GRAM;

            const ptPremium = ((ptGfex - ptIntlCny) / ptIntlCny) * 100;
            const pdPremium = ((pdGfex - pdIntlCny) / pdIntlCny) * 100;

            if (ptPremium > 20 || pdPremium > 20) {
                alertBanner.className = 'alert-banner';
                alertBanner.innerHTML = `
                    <div class="alert-icon">ğŸ”´</div>
                    <div class="alert-content">
                        <h4>å¹¿æœŸæ‰€æº¢ä»·è¾ƒå¤§</h4>
                        <p>å½“å‰é“‚é‡‘å’Œé’¯é‡‘åœ¨å¹¿æœŸæ‰€çš„ä»·æ ¼æ˜¾è‘—é«˜äºå›½é™…å¸‚åœºï¼Œæº¢ä»·è¶…è¿‡20%ã€‚ç†è®ºå¥—åˆ©æ–¹å‘ï¼šåšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…å¸‚åœºã€‚</p>
                    </div>
                `;
            } else if (ptPremium < -5 || pdPremium < -5) {
                alertBanner.className = 'alert-banner opportunity';
                alertBanner.innerHTML = `
                    <div class="alert-icon">ğŸŸ¢</div>
                    <div class="alert-content">
                        <h4>å‘ç°å¥—åˆ©æœºä¼š!</h4>
                        <p>å¹¿æœŸæ‰€ä»·æ ¼ä½äºå›½é™…å¸‚åœºæ¢ç®—ä»·æ ¼ï¼Œå­˜åœ¨æ½œåœ¨å¥—åˆ©ç©ºé—´ã€‚ç†è®ºæ–¹å‘ï¼šåšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…å¸‚åœºã€‚</p>
                    </div>
                `;
            } else {
                alertBanner.innerHTML = `
                    <div class="alert-icon">ğŸ“Š</div>
                    <div class="alert-content">
                        <h4>ä»·å·®åœ¨åˆç†èŒƒå›´</h4>
                        <p>å½“å‰ä¸¤ä¸ªå¸‚åœºä»·æ ¼å·®å¼‚è¾ƒå°ï¼Œæš‚æ— æ˜æ˜¾å¥—åˆ©æœºä¼šã€‚å»ºè®®æŒç»­è§‚å¯Ÿã€‚</p>
                    </div>
                `;
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = 'â³ åˆ·æ–°ä¸­...';
            btn.disabled = true;

            try {
                // å¹¶è¡Œè·å–æ•°æ®
                const [gfexData, rate] = await Promise.all([
                    fetchGFEXPrice(),
                    fetchExchangeRate()
                ]);

                // æ›´æ–°æ•°æ®
                if (gfexData.PT2606) marketData.gfex.PT2606 = gfexData.PT2606;
                if (gfexData.PD2606) marketData.gfex.PD2606 = gfexData.PD2606;
                marketData.exchangeRate = rate;
                marketData.lastUpdate = new Date();

                updateDisplay();
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                alert('æ•°æ®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                btn.disabled = false;
            }
        }

        // åˆ‡æ¢è§„åˆ™æ˜¾ç¤º
        function toggleRules() {
            const content = document.getElementById('rules-content');
            const toggle = document.getElementById('rules-toggle');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }

        // æ£€æŸ¥å¸‚åœºçŠ¶æ€
        function checkMarketStatus() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const day = now.getDay();

            const statusEl = document.getElementById('market-status');
            const dotEl = document.querySelector('.status-dot');

            // å‘¨æœ«
            if (day === 0 || day === 6) {
                statusEl.textContent = 'å¸‚åœºä¼‘å¸‚';
                dotEl.style.background = 'var(--text-muted)';
                return;
            }

            // äº¤æ˜“æ—¶æ®µåˆ¤æ–­
            const isSession1 = (hour === 9 && minute >= 0) || (hour === 10 && minute < 15);
            const isSession2 = (hour === 10 && minute >= 30) || (hour === 11 && minute < 30);
            const isSession3 = (hour === 13 && minute >= 30) || (hour === 14) || (hour === 15 && minute === 0);

            if (isSession1 || isSession2 || isSession3) {
                statusEl.textContent = 'å¸‚åœºå¼€æ”¾';
                dotEl.style.background = 'var(--positive)';
            } else {
                statusEl.textContent = 'ç›˜å';
                dotEl.style.background = 'var(--warning)';
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            // è®¾ç½®åˆå§‹æ•°æ® (åŸºäºä¹‹å‰Pythonè„šæœ¬è·å–çš„æ•°æ®)
            marketData.gfex.PT2606 = 657.65;
            marketData.gfex.PD2606 = 578.25;
            marketData.exchangeRate = 7.04;

            updateDisplay();
            checkMarketStatus();

            // æ¯åˆ†é’Ÿæ£€æŸ¥å¸‚åœºçŠ¶æ€
            setInterval(checkMarketStatus, 60000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // ========== æ‰‹åŠ¨æ›´æ–°ä»·æ ¼åŠŸèƒ½ ==========
        function updateCMEPrice() {
            // è¯»å–ç”¨æˆ·è¾“å…¥çš„å€¼
            const cmePt = parseFloat(document.getElementById('cme-pl-price').value) || 0;
            const cmePd = parseFloat(document.getElementById('cme-pa-price').value) || 0;
            const spotPt = parseFloat(document.getElementById('spot-pl-price').value) || 0;
            const spotPd = parseFloat(document.getElementById('spot-pa-price').value) || 0;
            const gfexPt = parseFloat(document.getElementById('gfex-pl-price').value) || 0;
            const gfexPd = parseFloat(document.getElementById('gfex-pa-price').value) || 0;

            // æ›´æ–°å¹¿æœŸæ‰€æ•°æ®
            if (gfexPt > 0) marketData.gfex.PT2606 = gfexPt;
            if (gfexPd > 0) marketData.gfex.PD2606 = gfexPd;

            // æ›´æ–°æ—¶é—´
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN');
            document.getElementById('last-update').textContent = timeStr;
            document.getElementById('data-time').textContent = timeStr;

            // æ›´æ–°å¡ç‰‡ä¸Šçš„æ—¶é—´æ˜¾ç¤º (æ‰‹åŠ¨æ›´æ–°æ—¶æ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´)
            const dateStr = now.getFullYear() + '.' + String(now.getMonth() + 1).padStart(2, '0') + '.' + String(now.getDate()).padStart(2, '0');
            const timeOnlyStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const fullTimeStr = dateStr + ' ' + timeOnlyStr + ' æ‰‹åŠ¨';
            const ptGfexTimeEl = document.getElementById('pt-gfex-time');
            const pdGfexTimeEl = document.getElementById('pd-gfex-time');
            const ptCmeTimeEl = document.getElementById('pt-cme-time');
            const pdCmeTimeEl = document.getElementById('pd-cme-time');
            if (ptGfexTimeEl) ptGfexTimeEl.textContent = fullTimeStr;
            if (pdGfexTimeEl) pdGfexTimeEl.textContent = fullTimeStr;
            if (ptCmeTimeEl) ptCmeTimeEl.textContent = fullTimeStr;
            if (pdCmeTimeEl) pdCmeTimeEl.textContent = fullTimeStr;

            // è®¡ç®—é“‚é‡‘
            const ptGfex = marketData.gfex.PT2606;
            const ptIntlUsd = cmePt;
            const ptIntlCny = ptIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
            const ptSpread = ptGfex - ptIntlCny;
            const ptSpreadPct = ptIntlCny > 0 ? (ptSpread / ptIntlCny) * 100 : 0;

            document.getElementById('pt-gfex').textContent = ptGfex.toFixed(2);
            document.getElementById('pt-intl').textContent = ptIntlCny.toFixed(2);
            document.getElementById('pt-intl-usd').textContent = ptIntlUsd.toFixed(2);
            document.getElementById('pt-spot-usd-display').textContent = spotPt.toFixed(2);
            document.getElementById('pt-spread').textContent = (ptSpread >= 0 ? '+' : '') + ptSpread.toFixed(2);
            document.getElementById('pt-spread-pct').textContent = (ptSpreadPct >= 0 ? '+' : '') + ptSpreadPct.toFixed(2) + '%';

            // æ›´æ–°é“‚é‡‘æ ·å¼
            const ptSpreadEl = document.getElementById('pt-spread');
            const ptSpreadPctEl = document.getElementById('pt-spread-pct');
            const ptDirectionEl = document.getElementById('pt-direction');
            if (ptSpread >= 0) {
                ptSpreadEl.className = 'spread-value positive';
                ptSpreadPctEl.className = 'spread-pct positive';
                ptDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
            } else {
                ptSpreadEl.className = 'spread-value negative';
                ptSpreadPctEl.className = 'spread-pct negative';
                ptDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
            }

            // è®¡ç®—é’¯é‡‘
            const pdGfex = marketData.gfex.PD2606;
            const pdIntlUsd = cmePd;
            const pdIntlCny = pdIntlUsd * marketData.exchangeRate / OZ_TO_GRAM;
            const pdSpread = pdGfex - pdIntlCny;
            const pdSpreadPct = pdIntlCny > 0 ? (pdSpread / pdIntlCny) * 100 : 0;

            document.getElementById('pd-gfex').textContent = pdGfex.toFixed(2);
            document.getElementById('pd-intl').textContent = pdIntlCny.toFixed(2);
            document.getElementById('pd-intl-usd').textContent = pdIntlUsd.toFixed(2);
            document.getElementById('pd-spot-usd-display').textContent = spotPd.toFixed(2);
            document.getElementById('pd-spread').textContent = (pdSpread >= 0 ? '+' : '') + pdSpread.toFixed(2);
            document.getElementById('pd-spread-pct').textContent = (pdSpreadPct >= 0 ? '+' : '') + pdSpreadPct.toFixed(2) + '%';

            // æ›´æ–°é’¯é‡‘æ ·å¼
            const pdSpreadEl = document.getElementById('pd-spread');
            const pdSpreadPctEl = document.getElementById('pd-spread-pct');
            const pdDirectionEl = document.getElementById('pd-direction');
            if (pdSpread >= 0) {
                pdSpreadEl.className = 'spread-value positive';
                pdSpreadPctEl.className = 'spread-pct positive';
                pdDirectionEl.innerHTML = 'ğŸ”´ å¹¿æœŸæ‰€æº¢ä»· â†’ åšç©ºå¹¿æœŸæ‰€ + åšå¤šå›½é™…';
            } else {
                pdSpreadEl.className = 'spread-value negative';
                pdSpreadPctEl.className = 'spread-pct negative';
                pdDirectionEl.innerHTML = 'ğŸŸ¢ å¹¿æœŸæ‰€æŠ˜ä»· â†’ åšå¤šå¹¿æœŸæ‰€ + åšç©ºå›½é™…';
            }

            console.log('ä»·æ ¼å·²æ›´æ–°:', { cmePt, cmePd, spotPt, spotPd, gfexPt, gfexPd });

            // æ›´æ–°å¥—åˆ©è®¡ç®—å™¨
            if (typeof calculateArbitrage === 'function') {
                calculateArbitrage();
            }

            // ä¿å­˜åˆ°æœåŠ¡å™¨
            savePricesToServer({
                cme: { pt: cmePt, pd: cmePd },
                bybit: { pt: spotPt, pd: spotPd },
                gfex: { pt: gfexPt, pd: gfexPd },
                exchange_rate: marketData.exchangeRate
            });
        }

        // ä¿å­˜ä»·æ ¼åˆ°æœåŠ¡å™¨
        async function savePricesToServer(data) {
            try {
                const resp = await fetch('/api/save-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (resp.ok) {
                    console.log('ä»·æ ¼å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                }
            } catch (e) {
                console.error('ä¿å­˜å¤±è´¥:', e);
            }
        }

        // ========== å¥—åˆ©è®¡ç®—å™¨åŠŸèƒ½ ==========

        // å½“å‰é€‰æ‹©çš„é‡‘å±ç±»å‹
        let selectedMetal = 'PD';

        // åˆ‡æ¢é‡‘å±ç±»å‹
        function selectMetal(metal) {
            selectedMetal = metal;
            document.querySelectorAll('.calc-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${metal.toLowerCase()}`).classList.add('active');
            // é‡æ–°è®¡ç®—
            calculateArbitrage();
        }

        // è®¡ç®—å¥—åˆ©æ–¹æ¡ˆ
        function calculateArbitrage() {
            // è·å–è¾“å…¥å€¼
            // è·å–äº¤æ˜“å‚æ•°
            const lots = parseInt(document.getElementById('calc-lots').value) || 1;
            const convergence = parseFloat(document.getElementById('calc-convergence').value) || 0.5;
            const period = parseInt(document.getElementById('calc-period').value) || 30;
            const hedgePlatform = document.getElementById('calc-hedge-platform').value;

            // å¸‚åœºæ•°æ®
            const OZ_TO_GRAM = 31.1035;
            const exchangeRate = marketData.exchangeRate || 7.04;

            // æ ¹æ®é€‰æ‹©çš„é‡‘å±è·å–ä»·æ ¼ - ç›´æ¥ä»è¾“å…¥æ¡†è¯»å–ï¼Œç¡®ä¿ä¸ç”¨æˆ·è¾“å…¥åŒæ­¥
            let gfexPrice, intlPriceUsd, contractCode, hedgeCode, cmeContractSize;
            if (selectedMetal === 'PT') {
                // ä¼˜å…ˆä»è¾“å…¥æ¡†è¯»å–ï¼Œå…¶æ¬¡ä» marketDataï¼Œæœ€åç”¨é»˜è®¤å€¼
                gfexPrice = parseFloat(document.getElementById('gfex-pl-price').value) || marketData.gfex.PT2606 || 657.65;
                intlPriceUsd = parseFloat(document.getElementById('cme-pl-price').value) || 940;
                contractCode = 'PT2610';
                hedgeCode = hedgePlatform === 'cme' ? 'PL 2610' : 'XPT/USD';
                cmeContractSize = 50;  // CMEé“‚é‡‘1æ‰‹ = 50ç›å¸
            } else {
                // ä¼˜å…ˆä»è¾“å…¥æ¡†è¯»å–ï¼Œå…¶æ¬¡ä» marketDataï¼Œæœ€åç”¨é»˜è®¤å€¼
                gfexPrice = parseFloat(document.getElementById('gfex-pa-price').value) || marketData.gfex.PD2606 || 578.25;
                intlPriceUsd = parseFloat(document.getElementById('cme-pa-price').value) || 988;
                contractCode = 'PD2608';
                hedgeCode = hedgePlatform === 'cme' ? 'PA 2608' : 'XPD/USD';
                cmeContractSize = 100;  // CMEé’¯é‡‘1æ‰‹ = 100ç›å¸
            }

            // å›½é™…ä»·æ ¼æ¢ç®—ä¸ºäººæ°‘å¸/å…‹
            const intlPriceCny = (intlPriceUsd * exchangeRate) / OZ_TO_GRAM;

            // ä»·å·®è®¡ç®—
            const spread = gfexPrice - intlPriceCny;
            const spreadPct = (spread / intlPriceCny) * 100;

            // äº¤æ˜“è§„æ¨¡
            const gramsPerLot = 1000;  // å¹¿æœŸæ‰€1æ‰‹ = 1000å…‹
            const totalGrams = lots * gramsPerLot;
            const ozEquivalent = totalGrams / OZ_TO_GRAM;  // ç­‰å€¼ç›å¸æ•°

            // === ä¿è¯é‡‘è®¡ç®— ===
            // å¹¿æœŸæ‰€ä¿è¯é‡‘ = åˆçº¦ä»·å€¼ Ã— 12%
            const gfexContractValue = gfexPrice * totalGrams;
            const gfexMargin = gfexContractValue * 0.12;

            // å¯¹å†²å¹³å°ä¿è¯é‡‘è®¡ç®—
            let hedgeContractValue, hedgeMargin, hedgeLots, hedgeOz, hedgeGrams, hedgeDetail, positionMismatch;
            let canHedge = true;  // æ˜¯å¦å¯ä»¥å¯¹å†²
            let hedgeWarning = '';

            if (hedgePlatform === 'cme') {
                // CMEäº¤å‰²åˆçº¦ - å¿…é¡»æ•´æ‰‹äº¤æ˜“
                // CMEé“‚é‡‘1æ‰‹=50oz=1555å…‹ï¼Œé’¯é‡‘1æ‰‹=100oz=3110å…‹
                const cmeGramsPerLot = cmeContractSize * OZ_TO_GRAM;
                const minGfexLotsForCme = Math.round(cmeGramsPerLot / gramsPerLot);  // é’¯é‡‘=3æ‰‹ï¼Œé“‚é‡‘=2æ‰‹

                // æ£€æŸ¥å¹¿æœŸæ‰€ä»“ä½æ˜¯å¦è¶³å¤Ÿæ¥è¿‘åŒ¹é…CMEæœ€å°1æ‰‹
                // 3000å…‹ vs 3110å…‹ = 96.5% åŒ¹é…åº¦ï¼Œå¯ä»¥æ¥å—
                if (totalGrams < cmeGramsPerLot * 0.5) {
                    // ä»“ä½å¤ªå°ï¼ˆä¸è¶³50%ï¼‰ï¼Œæ— æ³•æœ‰æ•ˆå¯¹å†²
                    canHedge = false;
                    hedgeLots = 0;
                    hedgeOz = 0;
                    hedgeGrams = 0;
                    hedgeContractValue = 0;
                    hedgeMargin = 0;
                    positionMismatch = -totalGrams;
                    hedgeDetail = `âš ï¸ ä»“ä½ä¸è¶³ï¼`;
                    hedgeWarning = `å»ºè®®å¹¿æœŸæ‰€åš${minGfexLotsForCme}æ‰‹ â‰ˆ CME 1æ‰‹`;
                } else {
                    // è®¡ç®—æœ€æ¥è¿‘çš„CMEæ‰‹æ•°
                    hedgeLots = Math.round(totalGrams / cmeGramsPerLot);
                    if (hedgeLots < 1) hedgeLots = 1;
                    hedgeOz = hedgeLots * cmeContractSize;
                    hedgeGrams = hedgeOz * OZ_TO_GRAM;
                    hedgeContractValue = intlPriceUsd * hedgeOz;

                    // ä»“ä½æ•å£è®¡ç®—
                    positionMismatch = hedgeGrams - totalGrams;
                    const mismatchPct = ((positionMismatch / totalGrams) * 100).toFixed(1);

                    // CMEä¿è¯é‡‘ï¼šé“‚é‡‘çº¦$5000/æ‰‹ï¼Œé’¯é‡‘çº¦$15000/æ‰‹
                    const cmeMarginPerLot = selectedMetal === 'PT' ? 5000 : 15000;
                    hedgeMargin = cmeMarginPerLot * hedgeLots;

                    if (Math.abs(positionMismatch) > 200) {
                        hedgeDetail = `= ${hedgeGrams.toFixed(0)}å…‹ (æ•å£${mismatchPct > 0 ? '+' : ''}${mismatchPct}%)`;
                    } else {
                        hedgeDetail = `= ${hedgeGrams.toFixed(0)}å…‹ âœ“`;
                    }
                }
            } else {
                // Bybitæ°¸ç»­CFD - å¯ä»¥ç²¾ç¡®åŒ¹é…ä»»æ„æ•°é‡
                hedgeLots = 1;
                hedgeOz = ozEquivalent;
                hedgeGrams = totalGrams;  // ç²¾ç¡®åŒ¹é…
                hedgeContractValue = intlPriceUsd * hedgeOz;
                hedgeMargin = hedgeContractValue * 0.10;  // 10å€æ æ†
                positionMismatch = 0;
                hedgeDetail = `= ${hedgeGrams.toFixed(0)}å…‹ âœ“`;
            }

            // æ€»ä¿è¯é‡‘éœ€æ±‚ï¼ˆç»Ÿä¸€æ¢ç®—æˆäººæ°‘å¸ï¼‰
            const hedgeMarginCny = hedgeMargin * exchangeRate;
            const hedgeContractValueCny = hedgeContractValue * exchangeRate;
            const totalMarginCny = gfexMargin + hedgeMarginCny;

            // === æ”¶ç›Šè®¡ç®— ===
            // æ”¶ç›ŠåŸºäºèƒ½åŒ¹é…çš„æœ€å°ä»“ä½
            const effectiveGrams = Math.min(totalGrams, hedgeGrams);
            // é¢„æœŸæ”¶æ•›æ”¶ç›Š = ä»·å·® Ã— æ”¶æ•›æ¯”ä¾‹ Ã— æœ‰æ•ˆå…‹æ•°
            const grossProfit = spread * convergence * effectiveGrams;

            // === äº¤æ˜“æˆæœ¬æ˜ç»† ===
            // 1. å¹¿æœŸæ‰€æ‰‹ç»­è´¹: ä¸‡åˆ†ä¹‹2.5å¼€ä»“ + ä¸‡åˆ†ä¹‹2.5å¹³ä»“ = ä¸‡åˆ†ä¹‹5
            const gfexFee = gfexContractValue * 0.0005;

            // 2. CMEæ‰‹ç»­è´¹: çº¦$2.5/æ‰‹/è¾¹ = $5/æ‰‹å¾€è¿”; Bybitçº¦0.055%/è¾¹
            const hedgeFee = hedgePlatform === 'cme'
                ? (hedgeLots * 5 * exchangeRate)  // CMEå¾€è¿”
                : (hedgeContractValue * exchangeRate * 0.0011);  // Bybitå¾€è¿”0.055%Ã—2

            // 3. èµ„é‡‘æˆæœ¬: ä¿è¯é‡‘å ç”¨çš„æœºä¼šæˆæœ¬ (æŒ‰å¹´åŒ–4%è®¡ç®—)
            const capitalCost = totalMarginCny * 0.04 * (period / 365);

            // 4. æ»‘ç‚¹æˆæœ¬: é¢„ä¼°ä¸ºåˆçº¦ä»·å€¼çš„0.1%
            const slippageCost = (gfexContractValue + hedgeContractValueCny) * 0.001;

            const totalFee = gfexFee + hedgeFee + capitalCost + slippageCost;

            // å‡€æ”¶ç›Š
            const netProfit = grossProfit - totalFee;

            // === é£é™©è®¡ç®— ===
            // æœ€å¤§äºæŸ = å‡è®¾ä»·å·®æ‰©å¤§20%
            const maxLoss = spread * 0.2 * totalGrams + totalFee;

            // æ”¶ç›Šé£é™©æ¯”
            const riskRatio = Math.abs(netProfit / maxLoss);

            // === å¹´åŒ–æ”¶ç›Šç‡ ===
            const annualizedReturn = ((netProfit / totalMarginCny) * (365 / period) * 100);

            // === é£é™©ç­‰çº§åˆ¤æ–­ ===
            let riskLevel, riskClass;
            if (spreadPct > 30) {
                riskLevel = 'ğŸ”´ é«˜é£é™©';
                riskClass = 'high';
            } else if (spreadPct > 15) {
                riskLevel = 'âš ï¸ ä¸­é«˜é£é™©';
                riskClass = 'medium';
            } else {
                riskLevel = 'ğŸŸ¢ ä¸­ç­‰é£é™©';
                riskClass = 'low';
            }

            // === æ›´æ–°æ˜¾ç¤º ===

            // æŒä»“æ˜ç»† - å¹¿æœŸæ‰€åšç©º
            document.getElementById('gfex-position').textContent = `${contractCode} Ã— ${lots}æ‰‹`;
            document.getElementById('gfex-contract-value').textContent = `Â¥${formatNumber(gfexContractValue)}`;
            document.getElementById('result-gfex-margin').textContent = `Â¥${formatNumber(gfexMargin)}`;
            document.getElementById('gfex-grams').textContent = `= ${formatNumber(totalGrams)}å…‹`;

            // æŒä»“æ˜ç»† - å¯¹å†²åšå¤š
            document.getElementById('hedge-platform-name').textContent = hedgePlatform === 'cme' ? 'CME NYMEX' : 'Bybit MT5';
            document.getElementById('hedge-contract-type').textContent = hedgePlatform === 'cme' ? 'äº¤å‰²' : 'æ°¸ç»­';

            if (hedgePlatform === 'cme' && !canHedge) {
                // æ— æ³•å¯¹å†²æ—¶æ˜¾ç¤ºè­¦å‘Š
                document.getElementById('hedge-contract-type').style.background = 'var(--negative)';
                document.getElementById('hedge-position').textContent = `âš ï¸ æ— æ³•åŒ¹é…`;
                document.getElementById('hedge-position-detail').textContent = hedgeWarning;
                document.getElementById('hedge-contract-value').textContent = `-`;
                document.getElementById('result-hedge-margin').textContent = `-`;
            } else {
                document.getElementById('hedge-contract-type').style.background = hedgePlatform === 'cme' ? 'var(--info)' : 'var(--warning)';
                document.getElementById('hedge-position').textContent = hedgePlatform === 'cme'
                    ? `${hedgeCode} Ã— ${hedgeLots}æ‰‹`
                    : `${hedgeCode} Ã— ${hedgeOz.toFixed(2)} oz`;
                document.getElementById('hedge-position-detail').textContent = hedgeDetail;
                document.getElementById('hedge-contract-value').textContent = `â‰ˆÂ¥${formatNumber(hedgeContractValueCny)}`;
                document.getElementById('result-hedge-margin').textContent = `â‰ˆÂ¥${formatNumber(hedgeMarginCny)}`;
            }

            // æ€»ä¿è¯é‡‘
            document.getElementById('result-total-margin').textContent = `Â¥${formatNumber(totalMarginCny)}`;

            // æ”¶ç›Š
            const convergencePct = (convergence * 100).toFixed(0);
            document.getElementById('result-gross-profit').textContent = `Â¥${formatNumber(grossProfit)}`;

            // æ”¶ç›Šç‡ï¼ˆç›¸å¯¹äºä¿è¯é‡‘ï¼‰
            const returnRate = (grossProfit / totalMarginCny) * 100;
            const returnRateEl = document.getElementById('result-return-rate');
            returnRateEl.textContent = `+${returnRate.toFixed(0)}%`;
            returnRateEl.style.color = returnRate > 50 ? 'var(--warning)' : 'var(--positive)';

            document.getElementById('gross-profit-detail').textContent =
                `ä»·å·®${spread.toFixed(0)}å…ƒ/å…‹ Ã— ${convergencePct}%æ”¶æ•› Ã— ${totalGrams}å…‹`;

            document.getElementById('result-net-profit').textContent = `Â¥${formatNumber(netProfit)}`;
            document.getElementById('net-profit-detail').textContent =
                `æ¯›æ”¶ç›ŠÂ¥${formatNumber(grossProfit)} - æ‰‹ç»­è´¹Â¥${formatNumber(totalFee)}`;

            // æ›´æ–°æ”¶ç›Šé¢œè‰²
            const netProfitEl = document.getElementById('result-net-profit');
            if (netProfit >= 0) {
                netProfitEl.className = 'result-value green';
            } else {
                netProfitEl.className = 'result-value red';
            }

            // é£é™©
            document.getElementById('result-max-loss').textContent = `-Â¥${formatNumber(maxLoss)}`;
            document.getElementById('result-risk-ratio').textContent = `${riskRatio.toFixed(1)}:1`;

            // é£é™©ç­‰çº§
            document.getElementById('risk-level').textContent = riskLevel;
            document.getElementById('risk-level').style.color =
                riskClass === 'high' ? 'var(--negative)' :
                    riskClass === 'medium' ? 'var(--warning)' : 'var(--positive)';

            const riskBarFill = document.getElementById('risk-bar-fill');
            riskBarFill.className = `risk-fill ${riskClass}`;

            // æ‰§è¡Œæ­¥éª¤
            document.getElementById('step1-detail').textContent =
                `å–å‡º ${contractCode} ${lots}æ‰‹ @ ${gfexPrice.toFixed(2)}å…ƒ/å…‹`;
            document.getElementById('step2-detail').textContent =
                `ä¹°å…¥ ${hedgeCode} ${hedgeOz.toFixed(2)}ç›å¸ @ $${intlPriceUsd.toFixed(0)}`;

            // === é£é™©æ·±åº¦è®¡ç®— (Added) ===
            const exposureGrams = Math.abs(positionMismatch);
            const exposureDir = positionMismatch > 0 ? 'å‡€å¤šå¤´' : (positionMismatch < 0 ? 'å‡€ç©ºå¤´' : 'å®Œç¾å¯¹å†²');
            // è®¡ç®—æ•å£å¸¦æ¥çš„å¸‚å€¼é£é™© (åŸºäºå›½é™…ä»·æ ¼ä½œä¸ºå…¬å…å€¼)
            const exposureValue = exposureGrams * intlPriceCny;
            const exposureRisk1Pct = exposureValue * 0.01;

            // çˆ†ä»“ä»·è®¡ç®— (ç®€åŒ–ç‰ˆï¼šäºæŸ = ä¿è¯é‡‘)
            // å¹¿æœŸæ‰€åšç©ºï¼šä»·æ ¼ä¸Šæ¶¨å¯¼è‡´çˆ†ä»“ã€‚ Burst = Entry + Margin/Size
            const gfexBurst = gfexPrice + (gfexMargin / totalGrams);
            const gfexBurstPct = ((gfexBurst / gfexPrice - 1) * 100);

            // CMEåšå¤šï¼šä»·æ ¼ä¸‹è·Œå¯¼è‡´çˆ†ä»“ã€‚ Burst = Entry - Margin/Size
            // ç”¨æˆ·è¦æ±‚ï¼šä½¿ç”¨ç¾å…ƒæ ‡ä»· ($/oz)
            let cmeBurst = 0;
            let cmeBurstPct = 0;
            if (hedgeOz > 0) {
                // hedgeMargin å·²ç»æ˜¯ç¾å…ƒå•ä½
                cmeBurst = intlPriceUsd - (hedgeMargin / hedgeOz);
                cmeBurstPct = ((1 - cmeBurst / intlPriceUsd) * 100);
            }

            // æ›´æ–°UI
            const expEl = document.getElementById('risk-exposure-val');
            const expPnlEl = document.getElementById('risk-exposure-pnl');
            if (expEl && expPnlEl) {
                if (Math.abs(positionMismatch) < 1) { // å¿½ç•¥å¾®å°å·®å¼‚
                    expEl.textContent = "å®Œç¾å¯¹å†² (æ— æ•å£)";
                    expEl.style.color = "var(--positive)";
                    expPnlEl.textContent = "æ— æ•å£é£é™©";
                } else {
                    expEl.textContent = `${exposureDir} ${exposureGrams.toFixed(0)}å…‹`;
                    expEl.style.color = "var(--warning)";
                    expPnlEl.textContent = `ä»·æ ¼æ³¢åŠ¨1% â‰ˆ ç›ˆäº Â¥${exposureRisk1Pct.toFixed(0)}`;
                }
            }

            const burstGfexEl = document.getElementById('risk-burst-gfex');
            if (burstGfexEl) {
                burstGfexEl.textContent = `> Â¥${gfexBurst.toFixed(2)} (+${gfexBurstPct.toFixed(1)}%)`;
            }

            const burstCmeEl = document.getElementById('risk-burst-cme');
            if (burstCmeEl) {
                if (hedgeOz > 0) {
                    burstCmeEl.textContent = `< $${cmeBurst.toFixed(2)} (-${cmeBurstPct.toFixed(1)}%)`;
                } else {
                    burstCmeEl.textContent = "N/A";
                }
            }

            // === èµ„é‡‘ä¸ä¿è¯é‡‘æ™ºèƒ½åˆ†é… (Capital Allocation) ===
            const totalCapitalInput = document.getElementById('calc-total-capital');
            const allocationEl = document.getElementById('allocation-result');
            const cmeRatioSlider = document.getElementById('cme-ratio-slider');

            if (totalCapitalInput && allocationEl) {
                const totalCapital = parseFloat(totalCapitalInput.value) || 0;

                if (totalCapital < totalMarginCny) {
                    allocationEl.innerHTML = `<span style="color: var(--negative)">âš ï¸ æ€»èµ„é‡‘ Â¥${formatNumber(totalCapital)} ä¸è¶³æ”¯ä»˜æœ€ä½ä¿è¯é‡‘ Â¥${formatNumber(totalMarginCny)}</span>`;
                } else {
                    // ä½¿ç”¨æ»‘å—æ¯”ä¾‹è€Œéè‡ªåŠ¨è®¡ç®—
                    const cmeRatio = cmeRatioSlider ? (parseFloat(cmeRatioSlider.value) / 100) : 0.5;
                    const gfexRatio = 1 - cmeRatio;

                    const allocCme = totalCapital * cmeRatio;
                    const allocGfex = totalCapital * gfexRatio;
                    const allocCmeUsd = allocCme / exchangeRate;

                    // è®¡ç®—å¯æŠ—è·Œå¹…/æ¶¨å¹…
                    // å¹¿æœŸæ‰€ç©º: ä»·æ ¼ä¸Šæ¶¨ä¼šäºæŸ, å¯æŠ—æ¶¨å¹… = allocGfex / åˆçº¦ä»·å€¼
                    const optDPctGfex = ((allocGfex / gfexContractValue) * 100).toFixed(1);
                    const optBurstGfex = gfexPrice * (1 + allocGfex / gfexContractValue);

                    // CMEå¤š: ä»·æ ¼ä¸‹è·Œä¼šäºæŸ, å¯æŠ—è·Œå¹… = allocCme / åˆçº¦ä»·å€¼
                    let optDPctCme = '0.0';
                    let optBurstCme = 0;
                    if (hedgeContractValueCny > 0) {
                        optDPctCme = ((allocCme / hedgeContractValueCny) * 100).toFixed(1);
                        optBurstCme = intlPriceUsd * (1 - allocCme / hedgeContractValueCny);
                    }
                    // è®¡ç®—æ¨èæ­¢æŸä»· (ç•™20%å®‰å…¨è¾¹é™…ï¼Œå³åœ¨å¯æŠ—å¹…åº¦çš„80%ä½ç½®æ­¢æŸ)
                    const safetyMargin = 0.8;
                    const stopLossGfex = gfexPrice * (1 + (allocGfex / gfexContractValue) * safetyMargin);
                    const stopLossCme = intlPriceUsd * (1 - (allocCme / hedgeContractValueCny) * safetyMargin);

                    allocationEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 6px;">
                            <span>å¹¿æœŸæ‰€è´¦æˆ·: <strong style="color: var(--text-primary)">Â¥${formatNumber(allocGfex)}</strong> <span style="color:var(--text-muted);font-size:0.7rem;">(${(gfexRatio * 100).toFixed(0)}%)</span></span>
                            <span style="color: var(--warning)">å¯æŠ—æ¶¨å¹… +${optDPctGfex}% <span style="opacity:0.7">(Â¥${optBurstGfex.toFixed(0)})</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>CMEè´¦æˆ·: <strong style="color: var(--text-primary)">$${formatNumber(allocCmeUsd)}</strong> <span style="color:var(--text-muted);font-size:0.7rem;">(â‰ˆÂ¥${formatNumber(allocCme)}, ${(cmeRatio * 100).toFixed(0)}%)</span></span>
                            <span style="color: var(--info)">å¯æŠ—è·Œå¹… -${optDPctCme}% <span style="opacity:0.7">($${optBurstCme.toFixed(0)})</span></span>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">ğŸ›‘ å»ºè®®æ­¢æŸä»· <span style="opacity:0.6">(ä¿ç•™20%å®‰å…¨è¾¹é™…)</span></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.85rem;">
                            <div>
                                <span style="color: var(--text-muted);">å¹¿æœŸæ‰€ç©ºå•æ­¢æŸ:</span>
                                <strong style="color: var(--negative); margin-left: 4px;">Â¥${stopLossGfex.toFixed(2)}</strong>
                                <span style="color: var(--text-muted); font-size: 0.7rem;"> (+${((stopLossGfex / gfexPrice - 1) * 100).toFixed(1)}%)</span>
                            </div>
                            <div>
                                <span style="color: var(--text-muted);">CMEå¤šå•æ­¢æŸ:</span>
                                <strong style="color: var(--negative); margin-left: 4px;">$${stopLossCme.toFixed(2)}</strong>
                                <span style="color: var(--text-muted); font-size: 0.7rem;"> (-${((1 - stopLossCme / intlPriceUsd) * 100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            return Math.abs(num).toLocaleString('zh-CN', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) btn.textContent = 'â³ åˆ·æ–°ä¸­...';

            try {
                const resp = await fetch('/api/prices');
                if (!resp.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

                const data = await resp.json();
                console.log('APIè¿”å›:', data);

                // æ›´æ–°æ—¶é—´
                document.getElementById('data-time').textContent = data.update_time;

                // æ›´æ–°æ±‡ç‡
                document.getElementById('exchange-rate').textContent = `USD/CNY = ${data.exchange_rate.toFixed(4)}`;

                // æ›´æ–°è¾“å…¥æ¡†
                if (data.cme.pt) document.getElementById('cme-pl-price').value = data.cme.pt;
                if (data.cme.pd) document.getElementById('cme-pa-price').value = data.cme.pd;
                if (data.bybit.pt) document.getElementById('spot-pl-price').value = data.bybit.pt;
                if (data.bybit.pd) document.getElementById('spot-pa-price').value = data.bybit.pd;
                if (data.gfex.pt) document.getElementById('gfex-pl-price').value = data.gfex.pt;
                if (data.gfex.pd) document.getElementById('gfex-pa-price').value = data.gfex.pd;

                // æ›´æ–°å¡ç‰‡ä»·æ ¼æ˜¾ç¤º
                if (data.gfex.pt) document.getElementById('pt-gfex').textContent = data.gfex.pt.toFixed(2);
                if (data.gfex.pd) document.getElementById('pd-gfex').textContent = data.gfex.pd.toFixed(2);
                if (data.cme.pt) document.getElementById('pt-intl-usd').textContent = data.cme.pt.toFixed(2);
                if (data.cme.pd) document.getElementById('pd-intl-usd').textContent = data.cme.pd.toFixed(2);

                // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                if (data.gfex.pt_time) document.getElementById('pt-gfex-time').textContent = '@ ' + data.gfex.pt_time;
                if (data.gfex.pd_time) document.getElementById('pd-gfex-time').textContent = '@ ' + data.gfex.pd_time;
                if (data.cme.pt_time) document.getElementById('pt-cme-time').textContent = '@ ' + data.cme.pt_time;
                if (data.cme.pd_time) document.getElementById('pd-cme-time').textContent = '@ ' + data.cme.pd_time;

                // é‡æ–°è®¡ç®—å¥—åˆ©
                calculateArbitrage();

                if (btn) btn.textContent = 'âœ… å·²åˆ·æ–°';
                setTimeout(() => { if (btn) btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®'; }, 2000);

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                if (btn) btn.textContent = 'âŒ åˆ·æ–°å¤±è´¥';
                setTimeout(() => { if (btn) btn.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®'; }, 2000);
                alert('åˆ·æ–°å¤±è´¥: ' + error.message + '\n\nè¯·ç¡®ä¿ price_api_server.py æ­£åœ¨è¿è¡Œ');
            }
        }

        // æ›´æ–°CMEæ¯”ä¾‹æ»‘å—æ˜¾ç¤º
        function updateCmeRatioDisplay() {
            const slider = document.getElementById('cme-ratio-slider');
            const display = document.getElementById('cme-ratio-display');
            if (slider && display) {
                display.textContent = slider.value + '%';
            }
        }

        // åˆ‡æ¢å¯¹å†²å¹³å°æ—¶æ›´æ–°
        function updateHedgePlatform() {
            calculateArbitrage();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function () {
            // å…ˆå°è¯•åŠ è½½ä¿å­˜çš„æ‰‹åŠ¨æ•°æ®
            await loadSavedPrices();

            setTimeout(() => {
                try {
                    calculateArbitrage();
                } catch (e) {
                    console.error('è®¡ç®—å™¨åˆå§‹åŒ–å¤±è´¥:', e);
                }

                // ç‹¬ç«‹æ‰§è¡Œå›¾è¡¨åŠ è½½ï¼Œäº’ä¸å½±å“
                loadSpreadChart();
                loadConvergenceChart();
            }, 500);
        });

        // åŠ è½½ä¿å­˜çš„æ‰‹åŠ¨ä»·æ ¼æ•°æ®
        async function loadSavedPrices() {
            try {
                const resp = await fetch('/api/saved-prices');
                if (!resp.ok) return;

                const data = await resp.json();
                if (!data) return;

                console.log('åŠ è½½ä¿å­˜çš„æ•°æ®:', data);

                // å¡«å……åˆ°è¾“å…¥æ¡†
                if (data.cme?.pt) document.getElementById('cme-pl-price').value = data.cme.pt;
                if (data.cme?.pd) document.getElementById('cme-pa-price').value = data.cme.pd;
                if (data.bybit?.pt) document.getElementById('spot-pl-price').value = data.bybit.pt;
                if (data.bybit?.pd) document.getElementById('spot-pa-price').value = data.bybit.pd;
                if (data.gfex?.pt) document.getElementById('gfex-pl-price').value = data.gfex.pt;
                if (data.gfex?.pd) document.getElementById('gfex-pa-price').value = data.gfex.pd;

                // æ˜¾ç¤ºä¿å­˜æ—¶é—´ (å®Œæ•´æ—¥æœŸ+æ—¶é—´æ ¼å¼)
                if (data.save_time) {
                    document.getElementById('data-time').textContent = data.save_time + ' (å·²ä¿å­˜)';
                    // save_time æ ¼å¼: "2025/12/26 11:07:30" -> "2025.12.26 11:07 æ‰‹åŠ¨"
                    const parts = data.save_time.split(' ');
                    const datePart = parts[0].replace(/\//g, '.');
                    const timePart = parts[1] ? parts[1].substring(0, 5) : '';
                    const timeLabel = datePart + ' ' + timePart + ' æ‰‹åŠ¨';
                    const ptGfexTimeEl = document.getElementById('pt-gfex-time');
                    const pdGfexTimeEl = document.getElementById('pd-gfex-time');
                    const ptCmeTimeEl = document.getElementById('pt-cme-time');
                    const pdCmeTimeEl = document.getElementById('pd-cme-time');
                    if (ptGfexTimeEl) ptGfexTimeEl.textContent = timeLabel;
                    if (pdGfexTimeEl) pdGfexTimeEl.textContent = timeLabel;
                    if (ptCmeTimeEl) ptCmeTimeEl.textContent = timeLabel;
                    if (pdCmeTimeEl) pdCmeTimeEl.textContent = timeLabel;
                }

                // è§¦å‘æ›´æ–°
                updateCMEPrice();

            } catch (e) {
                console.log('æ— ä¿å­˜æ•°æ®æˆ–åŠ è½½å¤±è´¥:', e);
            }
        }

        // ç›‘å¬è¾“å…¥å˜åŒ–
        document.getElementById('calc-lots').addEventListener('input', calculateArbitrage);

        // ========== åˆçº¦æ”¶æ•›åˆ†æå›¾è¡¨ ==========
        let convergenceChart = null;
        let convergenceContracts = []; // ç¼“å­˜åˆçº¦æ•°æ®
        let selectedContract = 0; // å½“å‰é«˜äº®çš„åˆçº¦ç´¢å¼•

        async function loadConvergenceChart() {
            const chartDom = document.getElementById('convergence-chart');
            const statsDom = document.getElementById('convergence-stats');
            const tabsDom = document.getElementById('convergence-tabs');
            if (!chartDom) return;

            chartDom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">ğŸ“Š åŠ è½½æ”¶æ•›æ•°æ®ä¸­...</div>';

            try {
                const response = await fetch('contract_convergence_data.json?t=' + Date.now());
                if (!response.ok) throw new Error('æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ fetch_contract_convergence.py');

                const data = await response.json();
                console.log('Convergence Data:', data);

                if (!data.contracts || data.contracts.length === 0) {
                    throw new Error('æ— åˆçº¦æ•°æ®');
                }

                convergenceContracts = data.contracts;

                // ç”Ÿæˆé€‰æ‹©æŒ‰é’®
                if (tabsDom) {
                    const colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
                    let tabsHtml = '';
                    data.contracts.forEach((c, idx) => {
                        const isActive = idx === selectedContract;
                        tabsHtml += `<button onclick="selectConvergenceContract(${idx})" 
                            style="padding: 5px 12px; border: 2px solid ${colors[idx % colors.length]}; 
                            border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600;
                            background: ${isActive ? colors[idx % colors.length] : 'transparent'}; 
                            color: ${isActive ? '#000' : colors[idx % colors.length]};">${c.symbol}</button>`;
                    });
                    tabsDom.innerHTML = tabsHtml;
                }

                renderConvergenceChart(chartDom, data.contracts);

                // æ›´æ–°ç»Ÿè®¡
                if (statsDom) {
                    let html = '';
                    data.contracts.forEach(c => {
                        const color = c.convergence > 0 ? 'var(--positive)' : 'var(--negative)';
                        html += `
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${c.symbol}</div>
                                <div style="font-size: 1rem; font-weight: 600; color: ${color};">
                                    ${c.start_spread.toFixed(1)}% â†’ ${c.end_spread.toFixed(1)}%
                                </div>
                                <div style="font-size: 0.7rem; color: ${color};">æ”¶æ•› ${c.convergence > 0 ? '+' : ''}${c.convergence.toFixed(1)}%</div>
                            </div>
                        `;
                    });
                    statsDom.innerHTML = html;
                }

            } catch (error) {
                console.error('åŠ è½½æ”¶æ•›æ•°æ®å¤±è´¥:', error);
                chartDom.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                    <div style="font-size: 2rem; margin-bottom: 10px;">âš ï¸</div>
                    <div style="color: #ef4444;">${error.message}</div>
                </div>`;
            }
        }

        function selectConvergenceContract(idx) {
            selectedContract = idx;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const tabsDom = document.getElementById('convergence-tabs');
            const colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
            if (tabsDom && convergenceContracts.length > 0) {
                let tabsHtml = '';
                convergenceContracts.forEach((c, i) => {
                    const isActive = i === selectedContract;
                    tabsHtml += `<button onclick="selectConvergenceContract(${i})" 
                        style="padding: 5px 12px; border: 2px solid ${colors[i % colors.length]}; 
                        border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600;
                        background: ${isActive ? colors[i % colors.length] : 'transparent'}; 
                        color: ${isActive ? '#000' : colors[i % colors.length]};">${c.symbol}</button>`;
                });
                tabsDom.innerHTML = tabsHtml;
            }
            // é‡æ–°æ¸²æŸ“å›¾è¡¨
            const chartDom = document.getElementById('convergence-chart');
            if (chartDom && convergenceContracts.length > 0) {
                renderConvergenceChart(chartDom, convergenceContracts);
            }
        }

        function renderConvergenceChart(chartDom, contracts) {
            if (convergenceChart) {
                try { convergenceChart.dispose(); } catch (e) { }
            }

            convergenceChart = echarts.init(chartDom, 'dark');

            const colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
            const series = [];
            const legendData = [];

            contracts.forEach((contract, idx) => {
                legendData.push(contract.symbol);

                // å°†æ—¥æœŸè½¬æ¢ä¸º"è·äº¤å‰²å¤©æ•°"ï¼ˆè´Ÿæ•°è¡¨ç¤ºè¿˜æœ‰å¤šå°‘å¤©ï¼‰
                const totalDays = contract.history.length;
                const dataPoints = contract.history.map((item, i) => {
                    const daysToDelivery = i - totalDays; // è´Ÿæ•°åˆ°0
                    return [daysToDelivery, item.spread_pct];
                });

                const isHighlighted = idx === selectedContract;

                series.push({
                    name: contract.symbol,
                    type: 'line',
                    data: dataPoints,
                    smooth: true,
                    symbol: 'none',
                    lineStyle: {
                        color: colors[idx % colors.length],
                        width: isHighlighted ? 3 : 1.5,
                        opacity: isHighlighted ? 1 : 0.25
                    },
                    itemStyle: { color: colors[idx % colors.length] },
                    z: isHighlighted ? 10 : 1
                });
            });

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let html = `è·äº¤å‰² ${Math.abs(params[0].value[0])} å¤©<br/>`;
                        params.forEach(p => {
                            html += `${p.marker} ${p.seriesName}: ${p.value[1].toFixed(2)}%<br/>`;
                        });
                        return html;
                    }
                },
                legend: {
                    data: legendData,
                    bottom: 0,
                    textStyle: { color: '#94a3b8', fontSize: 11 }
                },
                grid: { left: '3%', right: '4%', bottom: '15%', top: '10%', containLabel: true },
                xAxis: {
                    type: 'value',
                    name: 'è·äº¤å‰²å¤©æ•°',
                    nameTextStyle: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', formatter: '{value}' },
                    splitLine: { lineStyle: { color: '#2d3748', type: 'dashed' } }
                },
                yAxis: {
                    type: 'value',
                    name: 'ä»·å·® (%)',
                    nameTextStyle: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#2d3748', type: 'dashed' } }
                },
                series: series
            };

            convergenceChart.setOption(option);
            window.addEventListener('resize', () => convergenceChart && convergenceChart.resize());
        }

        // ========== å†å²ä»·å·®å›¾è¡¨ ==========
        let spreadChart = null;
        let currentCommodity = 'platinum'; // é»˜è®¤é“‚é‡‘

        // å“ç§åˆ‡æ¢å‡½æ•°
        function switchCommodity(commodity) {
            currentCommodity = commodity;

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.commodity-tab').forEach(tab => {
                tab.style.background = 'transparent';
                tab.style.color = 'var(--text-muted)';
            });
            const activeTab = document.getElementById('tab-' + commodity);
            if (activeTab) {
                activeTab.style.background = 'var(--accent-gold)';
                activeTab.style.color = '#000';
            }

            // æ›´æ–°å‰¯æ ‡é¢˜
            const subtitles = {
                'platinum': 'å¹¿æœŸæ‰€ PT2610 vs CME é“‚é‡‘',
                'palladium': 'å¹¿æœŸæ‰€ PD2606 vs CME é’¯é‡‘',
                'gold': 'ä¸ŠæœŸæ‰€ vs COMEXé»„é‡‘',
                'silver': 'ä¸ŠæœŸæ‰€ vs COMEXç™½é“¶',
                'copper': 'ä¸ŠæœŸæ‰€ vs COMEXé“œ'
            };
            document.getElementById('chart-subtitle').textContent = subtitles[commodity] || '';

            // é‡æ–°åŠ è½½å›¾è¡¨
            loadSpreadChart();
        }

        async function loadSpreadChart() {
            const chartDom = document.getElementById('spread-chart');
            if (!chartDom) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            chartDom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">ğŸ“Š åŠ è½½å†å²æ•°æ®ä¸­...</div>';

            try {
                // 1. æ£€æŸ¥EChartsåº“æ˜¯å¦åŠ è½½
                if (typeof echarts === 'undefined') {
                    throw new Error('EChartsåº“æœªåŠ è½½ï¼Œå¯èƒ½CDNè®¿é—®å—é™');
                }

                let data, chartData;

                if (currentCommodity === 'platinum') {
                    // é“‚é‡‘ï¼šå¹¿æœŸæ‰€ PT2610 vs CME
                    const response = await fetch('platinum_spread_analysis.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status})`);
                    data = await response.json();

                    chartData = {
                        dates: data.history.map(item => item.date),
                        spreads: data.history.map(item => item.spread_gfex_pct || item.spread_sge_pct),
                        current: data.current.spread_gfex_pct || data.current.spread_sge_pct,
                        avg: data.stats_3y_sge.avg_spread_pct,
                        max: data.stats_3y_sge.max_spread_pct,
                        min: data.stats_3y_sge.min_spread_pct
                    };
                } else if (currentCommodity === 'palladium') {
                    // é’¯é‡‘ï¼šå¹¿æœŸæ‰€ PD2606 vs CME
                    const response = await fetch('palladium_spread_analysis.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`é’¯é‡‘æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status}), è¯·è¿è¡Œ fetch_palladium_spread.py`);
                    data = await response.json();

                    chartData = {
                        dates: data.history.map(item => item.date),
                        spreads: data.history.map(item => item.spread_gfex_pct || item.spread_sge_pct),
                        current: data.current.spread_gfex_pct || data.current.spread_sge_pct,
                        avg: data.stats_3y_sge.avg_spread_pct,
                        max: data.stats_3y_sge.max_spread_pct,
                        min: data.stats_3y_sge.min_spread_pct
                    };
                } else {
                    // é»„é‡‘/ç™½é“¶/é“œï¼šä½¿ç”¨æ–°æ•°æ®æ–‡ä»¶
                    const response = await fetch('precious_metals_spread_history.json?t=' + Date.now());
                    if (!response.ok) throw new Error(`æ•°æ®æ–‡ä»¶è¯·æ±‚å¤±è´¥ (${response.status})`);
                    data = await response.json();

                    const commodityData = data.commodities[currentCommodity];
                    if (!commodityData) throw new Error(`æœªæ‰¾åˆ°${currentCommodity}æ•°æ®`);

                    chartData = {
                        dates: commodityData.history.map(item => item.date),
                        spreads: commodityData.history.map(item => item.spread_pct),
                        current: commodityData.current_spread_pct,
                        avg: commodityData.avg_spread_pct,
                        max: commodityData.max_spread_pct,
                        min: commodityData.min_spread_pct
                    };
                }

                console.log('Spread Data Loaded:', chartData);
                console.log('chartDom:', chartDom, 'spreads length:', chartData.spreads ? chartData.spreads.length : 0);

                // 3. æ¸²æŸ“å›¾è¡¨
                if (chartDom && chartData.spreads && chartData.spreads.length > 0) {
                    renderSpreadChartGeneric(chartDom, chartData);
                } else {
                    chartDom.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">âš ï¸ æ— æœ‰æ•ˆæ•°æ®</div>';
                }

                // 4. æ›´æ–°ç»Ÿè®¡æ•°æ®
                const elCurrent = document.getElementById('spread-current');
                if (elCurrent) {
                    elCurrent.innerHTML = (chartData.current >= 0 ? '+' : '') + chartData.current.toFixed(2) + '%';
                }

                const elAvg = document.getElementById('spread-avg');
                if (elAvg) {
                    elAvg.innerHTML = (chartData.avg >= 0 ? '+' : '') + chartData.avg.toFixed(2) + '%' +
                        '<span style="font-size:0.75rem; display:block; color:var(--text-muted)">3å¹´å‡å€¼</span>';
                }

                const elMax = document.getElementById('spread-max');
                if (elMax) {
                    elMax.innerHTML = (chartData.max >= 0 ? '+' : '') + chartData.max.toFixed(2) + '%';
                }

                const elMin = document.getElementById('spread-min');
                if (elMin) {
                    elMin.innerHTML = (chartData.min >= 0 ? '+' : '') + chartData.min.toFixed(2) + '%';
                }

            } catch (error) {
                console.error('åŠ è½½ä»·å·®æ•°æ®å¤±è´¥:', error);
                chartDom.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">âš ï¸</div>
                        <div style="color: #ef4444; margin-bottom: 5px;">å›¾è¡¨åŠ è½½å¤±è´¥</div>
                        <div style="font-size: 0.8rem; color: #94a3b8;">${error.message}</div>
                        <div style="font-size: 0.7rem; margin-top: 10px; opacity: 0.5;">è¯·å°è¯•åˆ·æ–°æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
                    </div>
                `;
            }
        }

        function renderSpreadChart(chartDom, data) {
            if (spreadChart) {
                spreadChart.dispose();
            }

            spreadChart = echarts.init(chartDom, 'dark');

            // æ•°æ®å‡†å¤‡
            const dates = data.history.map(item => item.date);
            const sgeSpreads = data.history.map(item => item.spread_sge_pct);
            const gfexSpreads = data.history.map(item => item.spread_gfex_pct); // åŒ…å«null
            const avgLine = data.stats_3y_sge.avg_spread_pct;

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    confine: true,
                    backgroundColor: 'rgba(26, 31, 46, 0.95)',
                    borderColor: '#2d3748',
                    textStyle: { color: '#f0f4f8' },
                    formatter: function (params) {
                        // åªæ˜¾ç¤ºå¹¿æœŸæ‰€
                        const gfex = params.find(x => x.seriesName === 'å¹¿æœŸæ‰€æº¢ä»·');
                        const axisValue = params[0].axisValue;

                        const historyItem = data.history.find(h => h.date === axisValue);
                        let detailHtml = '';
                        if (historyItem) {
                            detailHtml = `
                                <div style="font-size:0.75rem; color:#9ca3af; margin-top:6px; padding-top:6px; border-top:1px solid #374151;">
                                    CMEæŠ˜ç®—: Â¥${historyItem.cme_cny}<br/>
                                    ${historyItem.gfex ? `<span style="color:#ef4444; font-weight:bold">å¹¿æœŸæ‰€: Â¥${historyItem.gfex}</span>` : ''}
                                </div>
                             `;
                        }

                        let html = `${axisValue}<br/>`;
                        if (gfex && gfex.value != null) {
                            html += `${gfex.marker} å¹¿æœŸæ‰€æº¢ä»·: <span style="color:#ef4444; font-weight:bold">+${gfex.value.toFixed(2)}%</span>`;
                        }
                        html += detailHtml;
                        return html;
                    }
                },
                legend: {
                    data: ['å¹¿æœŸæ‰€æº¢ä»·', 'å½“å‰åŸºå·®'],
                    bottom: 0,
                    textStyle: { color: '#94a3b8' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', fontSize: 10 },
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    name: 'æº¢ä»·/åŸºå·® (%)',
                    nameTextStyle: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#2d3748', type: 'dashed' } }
                },
                series: [
                    {
                        name: 'å¹¿æœŸæ‰€æº¢ä»·',
                        type: 'line',
                        data: gfexSpreads,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        connectNulls: true,
                        lineStyle: { color: '#ef4444', width: 3 },
                        itemStyle: { color: '#ef4444' },
                        z: 10,
                        markLine: {
                            data: [
                                {
                                    yAxis: (function () {
                                        const c = parseFloat(document.getElementById('cme-pl-price').value) || 0;
                                        const s = parseFloat(document.getElementById('spot-pl-price').value) || 0;
                                        return s > 0 ? ((c - s) / s) * 100 : 0;
                                    })(),
                                    name: 'å½“å‰åŸºå·®',
                                    label: { formatter: 'åŸºå·® {c}%', position: 'end', color: '#a78bfa' },
                                    lineStyle: { type: 'dotted', color: '#a78bfa', width: 2 }
                                }
                            ],
                            symbol: 'none'
                        }
                    },
                    {
                        name: 'å½“å‰åŸºå·®', // Dummy series for Legend
                        type: 'line',
                        color: '#a78bfa',
                        itemStyle: { color: '#a78bfa' },
                        lineStyle: { type: 'dotted' },
                        data: []
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: (function () {
                            // è‡ªåŠ¨è®¡ç®—æœ‰æ•ˆæ•°æ®èµ·å§‹ç‚¹
                            const idx = gfexSpreads.findIndex(v => v !== null && v !== undefined);
                            if (idx === -1) return 70; // é»˜è®¤
                            // ç¨å¾®å¤šæ˜¾ç¤ºä¸€ç‚¹ä¸Šä¸‹æ–‡ (å¾€å‰æ¨5%)
                            const pct = Math.max(0, (idx / gfexSpreads.length) * 100 - 5);
                            return pct;
                        })(),
                        end: 100
                    },
                    {
                        type: 'slider',
                        start: (function () {
                            const idx = gfexSpreads.findIndex(v => v !== null && v !== undefined);
                            if (idx === -1) return 70;
                            const pct = Math.max(0, (idx / gfexSpreads.length) * 100 - 5);
                            return pct;
                        })(),
                        end: 100,
                        height: 20,
                        bottom: 30,
                        borderColor: '#374151',
                        fillerColor: 'rgba(167, 139, 250, 0.2)'
                    }
                ]
            };

            spreadChart.setOption(option);

            window.addEventListener('resize', () => {
                spreadChart && spreadChart.resize();
            });
        }

        // é€šç”¨ä»·å·®å›¾è¡¨æ¸²æŸ“å‡½æ•° (ç”¨äºé»„é‡‘/ç™½é“¶/é“œ)
        function renderSpreadChartGeneric(chartDom, chartData) {
            if (!chartDom || !chartData || !chartData.dates) {
                console.error('Invalid chart data or DOM');
                return;
            }

            if (spreadChart) {
                try {
                    spreadChart.dispose();
                } catch (e) {
                    console.warn('Chart dispose error:', e);
                }
            }

            spreadChart = echarts.init(chartDom, 'dark');

            const commodityNames = {
                'platinum': 'é“‚é‡‘',
                'gold': 'é»„é‡‘',
                'silver': 'ç™½é“¶',
                'copper': 'é“œ'
            };
            const seriesName = (commodityNames[currentCommodity] || 'ä»·å·®') + 'ä»·å·®';

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    confine: true,
                    backgroundColor: 'rgba(26, 31, 46, 0.95)',
                    borderColor: '#2d3748',
                    textStyle: { color: '#f0f4f8' },
                    formatter: function (params) {
                        const p = params[0];
                        return `${p.axisValue}<br/>${p.marker} ${seriesName}: <span style="font-weight:bold;color:${p.value >= 0 ? '#22c55e' : '#ef4444'}">${p.value >= 0 ? '+' : ''}${p.value.toFixed(2)}%</span>`;
                    }
                },
                legend: {
                    data: [seriesName],
                    bottom: 0,
                    textStyle: { color: '#94a3b8' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: chartData.dates,
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', fontSize: 10 },
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    name: 'ä»·å·® (%)',
                    nameTextStyle: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#2d3748' } },
                    axisLabel: { color: '#64748b', formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#2d3748', type: 'dashed' } }
                },
                series: [
                    {
                        name: seriesName,
                        type: 'line',
                        data: chartData.spreads,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 3,
                        lineStyle: { color: currentCommodity === 'gold' ? '#fbbf24' : currentCommodity === 'silver' ? '#94a3b8' : currentCommodity === 'copper' ? '#f97316' : '#ef4444', width: 2 },
                        itemStyle: { color: currentCommodity === 'gold' ? '#fbbf24' : currentCommodity === 'silver' ? '#94a3b8' : currentCommodity === 'copper' ? '#f97316' : '#ef4444' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(251, 191, 36, 0.3)' },
                                { offset: 1, color: 'rgba(251, 191, 36, 0)' }
                            ])
                        },
                        markLine: {
                            data: [
                                { yAxis: chartData.avg, name: '3å¹´å‡å€¼', label: { formatter: 'å‡å€¼ {c}%', position: 'end', color: '#a78bfa' }, lineStyle: { type: 'dashed', color: '#a78bfa', width: 1 } },
                                { yAxis: 0, lineStyle: { color: '#374151', width: 1 } }
                            ],
                            symbol: 'none'
                        }
                    }
                ],
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { type: 'slider', start: 0, end: 100, height: 20, bottom: 30, borderColor: '#374151', fillerColor: 'rgba(167, 139, 250, 0.2)' }
                ]
            };

            spreadChart.setOption(option);
        }

        // ========== è‡ªåŠ¨åŠ è½½æœ€æ–°æ•°æ® ==========
        async function loadLatestPrices() {
            try {
                const response = await fetch('prices_data.json?t=' + Date.now());
                if (!response.ok) {
                    console.log('prices_data.json not found, using chart data');
                    return;
                }
                const data = await response.json();

                // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                document.getElementById('data-time').textContent = data.update_time || 'è‡ªåŠ¨æ›´æ–°ä¸­...';

                // æ›´æ–°æ±‡ç‡
                if (data.exchange_rate) {
                    document.getElementById('exchange-rate').textContent = 'USD/CNY = ' + data.exchange_rate.toFixed(2);
                }

                // æ›´æ–°ä»·æ ¼å¡ç‰‡
                if (data.gfex) {
                    const ptGfexEl = document.getElementById('pt-gfex');
                    const pdGfexEl = document.getElementById('pd-gfex');
                    const ptGfexTimeEl = document.getElementById('pt-gfex-time');
                    const pdGfexTimeEl = document.getElementById('pd-gfex-time');

                    if (ptGfexEl) ptGfexEl.textContent = data.gfex.pt_price.toFixed(2);
                    if (pdGfexEl) pdGfexEl.textContent = data.gfex.pd_price.toFixed(2);
                    if (ptGfexTimeEl && data.gfex.pt_time) ptGfexTimeEl.textContent = '@' + data.gfex.pt_time;
                    if (pdGfexTimeEl && data.gfex.pd_time) pdGfexTimeEl.textContent = '@' + data.gfex.pd_time;
                }

                if (data.cme) {
                    const ptIntlEl = document.getElementById('pt-intl');
                    const pdIntlEl = document.getElementById('pd-intl');
                    const ptIntlUsdEl = document.getElementById('pt-intl-usd');
                    const pdIntlUsdEl = document.getElementById('pd-intl-usd');
                    const ptCmeTimeEl = document.getElementById('pt-cme-time');
                    const pdCmeTimeEl = document.getElementById('pd-cme-time');
                    const ptCmeContractEl = document.getElementById('pt-cme-contract');
                    const pdCmeContractEl = document.getElementById('pd-cme-contract');

                    // æ˜¾ç¤ºCME USDä»·æ ¼å’Œæ—¶é—´
                    if (ptIntlUsdEl && data.cme.pt_usd) {
                        ptIntlUsdEl.innerHTML = data.cme.pt_usd.toFixed(2) +
                            ' <span style="font-size:0.65rem;color:var(--text-muted);">@' + (data.cme.pt_time || '') + '</span>';
                    }
                    if (pdIntlUsdEl && data.cme.pd_usd) {
                        pdIntlUsdEl.innerHTML = data.cme.pd_usd.toFixed(2) +
                            ' <span style="font-size:0.65rem;color:var(--text-muted);">@' + (data.cme.pd_time || '') + '</span>';
                    }

                    // æ˜¾ç¤ºCME CNYæŠ˜ç®—ä»·æ ¼
                    if (ptIntlEl && data.cme.pt_cny) {
                        ptIntlEl.textContent = data.cme.pt_cny.toFixed(2);
                    }
                    if (pdIntlEl && data.cme.pd_cny) {
                        pdIntlEl.textContent = data.cme.pd_cny.toFixed(2);
                    }

                    // æ˜¾ç¤ºåˆçº¦ä¿¡æ¯
                    if (ptCmeContractEl && data.cme.pt_contract) {
                        ptCmeContractEl.textContent = data.cme.pt_contract;
                    }
                    if (pdCmeContractEl && data.cme.pd_contract) {
                        pdCmeContractEl.textContent = data.cme.pd_contract;
                    }
                }

                if (data.spread) {
                    const ptSpreadEl = document.getElementById('pt-spread');
                    const ptSpreadPctEl = document.getElementById('pt-spread-pct');
                    const pdSpreadEl = document.getElementById('pd-spread');
                    const pdSpreadPctEl = document.getElementById('pd-spread-pct');

                    if (ptSpreadEl) ptSpreadEl.textContent = (data.spread.pt_spread >= 0 ? '+' : '') + data.spread.pt_spread.toFixed(2);
                    if (ptSpreadPctEl) ptSpreadPctEl.textContent = (data.spread.pt_spread_pct >= 0 ? '+' : '') + data.spread.pt_spread_pct.toFixed(2) + '%';
                    if (pdSpreadEl) pdSpreadEl.textContent = (data.spread.pd_spread >= 0 ? '+' : '') + data.spread.pd_spread.toFixed(2);
                    if (pdSpreadPctEl) pdSpreadPctEl.textContent = (data.spread.pd_spread_pct >= 0 ? '+' : '') + data.spread.pd_spread_pct.toFixed(2) + '%';
                }

                // æ›´æ–°å¥—åˆ©è®¡ç®—å™¨çš„å“ç§æ ‡ç­¾æ˜¾ç¤ºä»·æ ¼å’Œæ—¶é—´
                const arbPtPriceEl = document.getElementById('arb-pt-price');
                const arbPdPriceEl = document.getElementById('arb-pd-price');
                if (arbPtPriceEl && data.gfex && data.gfex.pt_price && data.gfex.pt_time) {
                    arbPtPriceEl.textContent = 'Â¥' + data.gfex.pt_price.toFixed(2) + ' @' + data.gfex.pt_time;
                }
                if (arbPdPriceEl && data.gfex && data.gfex.pd_price && data.gfex.pd_time) {
                    arbPdPriceEl.textContent = 'Â¥' + data.gfex.pd_price.toFixed(2) + ' @' + data.gfex.pd_time;
                }

                console.log('ä»·æ ¼æ•°æ®å·²è‡ªåŠ¨æ›´æ–°:', data.update_time);
            } catch (error) {
                console.log('è‡ªåŠ¨åŠ è½½ä»·æ ¼æ•°æ®:', error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        (async function init() {
            // åŠ è½½æœ€æ–°ä»·æ ¼
            await loadLatestPrices();

            // åŠ è½½å›¾è¡¨
            loadSpreadChart();
            loadConvergenceChart();

            // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(async () => {
                await loadLatestPrices();
                loadSpreadChart();
            }, 60000);

            console.log('ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ¯60ç§’è‡ªåŠ¨åˆ·æ–°');
        })();
    </script>
</body>

</html>